<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tobias Tutorial Center Learning Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Typography Plugin for better text formatting -->
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography,aspect-ratio"></script>
    
    <!-- ### NEW: GOOGLE FONTS FOR PRESENTATION ### -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- ### MODIFIED: JITSI/JAAS EXTERNAL API SCRIPT ### -->
    <!-- Using the 8x8.vc domain as requested -->
    <script src='https://8x8.vc/vpaas-magic-cookie-2b16411358d643fa86ede3bbe82bc0df/external_api.js' async></script>

    <style>
        /* Custom font and basic styling */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .subject-card { transition: all 0.2s ease-in-out; }
        .subject-card:hover { transform: translateY(-3px); box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 6px 10px -3px rgba(0, 0, 0, 0.08); }
        .correct-bg { background-color: #d1fae5; border-color: #34d399; } /* Green 100 */
        .incorrect-bg { background-color: #fee2e2; border-color: #f87171; } /* Red 100 */
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 100; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .tab-active {
            border-color: #10b981; /* emerald-600 */
            color: #10b981; /* emerald-600 */
            background-color: #d1fae5; /* emerald-100 */
        }
        .tab-inactive {
            border-color: transparent;
            color: #6b7280;
        }
        /* Style for modals */
        .modal { display: none; /* Hidden by default */ }
        .modal.flex { display: flex; /* Shown when class 'flex' is added */ }
        .input-field { display: block; width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ### MODIFIED STYLES FOR LESSON PRESENTATION MODE ### --- */
        .presentation-view {
            position: fixed;
            inset: 0;
            background-color: #f3f4f6; /* ### CHANGED: gray-100 (was gray-800) ### */
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            width: 100vw;
            height: 100vh;
        }
        .presentation-slide-container {
            width: 100%;
            max-width: 1000px;
            background-color: #ffffff; /* white */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            aspect-ratio: 16 / 9;
            display: flex;
            flex-direction: column;
        }
        .presentation-slide-content {
            flex-grow: 1;
            padding: 2rem; /* p-8 */
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .presentation-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            padding-top: 1rem; /* pt-4 */
        }
        .presentation-nav-btn {
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            /* ### CHANGED: Light theme buttons ### */
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            font-weight: 600; /* font-semibold */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            font-family: 'Poppins', sans-serif;
        }
        .presentation-nav-btn:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .presentation-nav-btn:disabled {
            background-color: #f3f4f6; /* gray-100 */
            opacity: 0.7;
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        .presentation-header {
            width: 100%;
            max-width: 1000px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; /* mb-2 */
            color: #4b5563; /* ### CHANGED: gray-600 (was gray-300) ### */
        }
         .presentation-header button {
            color: #6b7280; /* gray-500 */
            transition: color 0.2s;
         }
         .presentation-header button:hover {
            color: #1f2937; /* gray-800 */
         }
         .presentation-nav p {
             color: #6b7280; /* gray-500 */
             font-family: 'Lato', sans-serif;
         }

        /* ### NEW: Slide Text Content Formatting ### */
        .slide-text-content {
            font-family: 'Lato', sans-serif;
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Vertically centers content */
            height: 100%;
            padding: 2rem;
            box-sizing: border-box; /* Ensures padding is included in height */
        }
        .slide-text-content h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem; /* 56px */
            font-weight: 700;
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        .slide-text-content h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.25rem; /* 36px */
            font-weight: 600;
            color: #374151; /* gray-700 */
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }
        .slide-text-content p {
            font-size: 1.25rem; /* 20px */
            color: #4b5563; /* gray-600 */
            margin-bottom: 1.25rem;
            line-height: 1.6;
        }
        .slide-text-content ul {
            list-style-type: disc;
            margin-left: 1.75rem; /* Indent list */
            margin-bottom: 1.25rem;
        }
        .slide-text-content li {
            font-size: 1.25rem; /* 20px */
            color: #4b5563; /* gray-600 */
            line-height: 1.6;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }
        .slide-text-content strong {
            font-weight: 700;
            color: #111827; /* gray-900 */
        }
        .slide-text-content em {
            font-style: italic;
            color: #374151; /* gray-700 */
        }
        
        /* Kahoot-style question buttons */
        .question-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .question-option-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.125rem; /* text-lg */
            color: white;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 4px solid transparent;
            font-family: 'Poppins', sans-serif; /* ### NEW: Added font ### */
            font-weight: 600;
        }
        .question-option-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .question-option-btn.selected {
            border-color: #ffffff;
            transform: scale(1.03);
        }
        .question-option-btn.correct {
            background-color: #10b981 !important; /* emerald-600 */
            border-color: #ffffff;
        }
        .question-option-btn.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            border-color: #ffffff;
        }
        .question-option-btn:not(.correct):not(.incorrect):not(.selected):hover {
            opacity: 0.9;
        }
        /* --- END MODIFIED STYLES --- */

        /* --- ### NEW: VIRTUAL CLASSROOM STYLES ### --- */
        .virtual-classroom-view {
            position: fixed;
            inset: 0;
            z-index: 100;
            background-color: #111827; /* gray-900 */
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #jitsi-container {
            flex-grow: 1;
            width: 100%;
            height: calc(100% - 60px); /* Adjust height to account for header */
        }
        .virtual-classroom-header {
            width: 100%;
            height: 60px;
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            flex-shrink: 0;
        }
        /* --- END VIRTUAL CLASSROOM STYLES --- */
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc, addDoc, deleteDoc, serverTimestamp, getDocs, updateDoc, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONSTANTS & SETUP ---

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-ttc-lms';
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Paths
        const QUIZ_RESULTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/quiz_results`;
        const ANNOUNCEMENTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/announcements`;
        const QUIZZES_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/quizzes`;
        const LESSON_BOOKS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/lesson_books`;
        const LESSON_SUBMISSIONS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/lesson_submissions`;
        const ASSIGNMENTS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/assignments`;
        const ASSIGNMENT_SUBMISSIONS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/assignment_submissions`;
        const PAYMENT_SESSIONS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/payment_sessions`;
        // NEW: Collection for all user profiles
        const USER_PROFILES_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/user_profiles`;
        // NEW: Collection for virtual classrooms
        const MEETINGS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/meetings`;
        const SUBJECTS_CONFIG_PATH = `artifacts/${APP_ID}/public/data/config/subjects`; // <-- NEW


        // The provided user credentials
        // Task 2.1: Add profilePicUrl placeholder
        // --- EDIT: This is now the *initial seed data*. Users will be managed in Firestore ---
        const INITIAL_SEED_USERS = [
            // Grade 3 Students
            { name: 'Danica Mae Sapida', username: 'd.sapida', password: 'danica3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=DS' },
            { name: 'Gio Nambayan', username: 'g.nambayan', password: 'gionam3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=GN' },
            { name: 'Samantha Ellise Ballester', username: 's.ballester', password: 'samantha3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=SB' },
            { name: 'Jezzmar Gabriel Baril', username: 'j.baril', password: 'gabgab3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=JB' },
            { name: 'Matthew Quierre', username: 'm.quierre', password: 'matmat3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=MQ' },
            { name: 'Alaia Blythe Caampued', username: 'b.caampued', password: 'verygoodgirl', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=BC' },
            { name: 'Mirain Pamisa', username: 'm.pamisa', password: 'mirain3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=MP' },
            { name: 'Ma. Bella Ernacio', username: 'b.ernacio', password: 'mabella3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=BE' },
            { name: 'Steffi Clair Soriano', username: 's.soriano', password: 'steffi3', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=SS' },
            { name: 'admin3', username: 'admin3', password: '1234', role: 'student', grade: 3, profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=A' },
            // Grade 4 Students
            { name: 'Giecel Nambayan', username: 'gc.nambayan', password: 'giecel4', role: 'student', grade: 4, profilePicUrl: 'https://placehold.co/64x64/3b82f6/ffffff?text=GN' },
            { name: 'Reign Cassandra Montejo', username: 'rc.montejo', password: 'reign4', role: 'student', grade: 4, profilePicUrl: 'https://placehold.co/64x64/3b82f6/ffffff?text=RM' },
            { name: 'admin4', username: 'admin4', password: '1234', role: 'student', grade: 4, profilePicUrl: 'https://placehold.co/64x64/3b82f6/ffffff?text=A' },
            // Grade 5 Students
            { name: 'John Francis Parani', username: 'jf.parani', password: 'totoy5', role: 'student', grade: 5, profilePicUrl: 'https://placehold.co/64x64/6366f1/ffffff?text=JP' },
            { name: 'Hiro Dimalanta', username: 'h.dimalanta', password: 'hiro5d', role: 'student', grade: 5, profilePicUrl: 'https://placehold.co/64x64/6366f1/ffffff?text=HD' },
            { name: 'admin5', username: 'admin5', password: '1234', role: 'student', grade: 5, profilePicUrl: 'https://placehold.co/64x64/6366f1/ffffff?text=A' },
            // Grade 2 Students
            { name: 'Dylan Grey Digo', username: 'd.digo', password: 'dylan2', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=DD' },
            { name: 'Yla Nnis Elia Garcia', username: 'y.garcia', password: 'ylannis2', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=YG' },
            { name: 'Athena Ivory Pastores', username: 'a.pastores', password: 'chuki2', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=AP' },
            { name: 'Mickhailla Aevrille Sarinas', username: 'm.sarinas', password: 'mikay2', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=MS' },
            { name: 'Marcus Liam Medina', username: 'l.medina', password: 'liamm2', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=LM' },
            { name: 'Kobe Dwayne Bayot', username: 'k.bayot', password: 'kobe2d', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=KB' },
            { name: 'Yssabella Zofia Haleco', username: 'z.haleco', password: 'zofia2', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=ZH' },
            { name: 'admin2', username: 'admin2', password: '1234', role: 'student', grade: 2, profilePicUrl: 'https://placehold.co/64x64/f97316/ffffff?text=A' },
            // Grade 1 Students
            { name: 'Ram Angelo Montejo', username: 'r.montejo', password: 'ramangelo1', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=RM' },
            { name: 'Marcuz Alejandro Boniol', username: 'm.boniol', password: 'marcuz1', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=MB' },
            { name: 'Khiane Jhay Dela Cruz', username: 'k.delacruz', password: 'khiane1', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=KD' },
            { name: 'Giro Nambayan', username: 'gr.nambayan', password: 'gironam1', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=GN' },
            { name: 'Bella Mariel Sorosoro', username: 'b.sorosoro', password: 'bellam1', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=BS' },
            { name: 'Psalm Daniel Judiana', username: 'p.judiana', password: 'samsam1', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=PJ' },
            { name: 'admin1', username: 'admin1', password: '1234', role: 'student', grade: 1, profilePicUrl: 'https://placehold.co/64x64/f59e0b/ffffff?text=A' },
            // Solo Students (Task 1: Updated grades)
            { name: 'Lyann Therese Pitoy', username: 'l.pitoy', password: 'lyannt', role: 'student', grade: '3 BS', profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=LP' },
            { name: 'Mavi Grae Escala', username: 'm.escala', password: 'mavig', role: 'student', grade: '3 OLHRS', profilePicUrl: 'https://placehold.co/64x64/34d399/ffffff?text=ME' },
            { name: 'Precious Anne Batolbatol', username: 'p.batolbatol', password: 'precious', role: 'student', grade: '5 OLHRS', profilePicUrl: 'https://placehold.co/64x64/6366f1/ffffff?text=PB' },
            // Task 3: Add Kinder Accounts
            // Kinder A
            { name: 'Jan Jacob Rimando', username: 'j.rimando', password: 'jacoba', role: 'student', grade: 'Kinder A', profilePicUrl: 'https://placehold.co/64x64/ec4899/ffffff?text=JR' },
            { name: 'Harley Hermione Soriano', username: 'h.soriano', password: 'harleya', role: 'student', grade: 'Kinder A', profilePicUrl: 'https://placehold.co/64x64/ec4899/ffffff?text=HS' },
            { name: 'Amarah Ysabelle Gawaran', username: 'a.gawaran', password: 'amaraha', role: 'student', grade: 'Kinder A', profilePicUrl: 'https://placehold.co/64x64/ec4899/ffffff?text=AG' },
            { name: 'Jianna Belle Villareal', username: 'j.villareal', password: 'jannaa', role: 'student', grade: 'Kinder A', profilePicUrl: 'https://placehold.co/64x64/ec4899/ffffff?text=JV' },
            { name: 'adminA', username: 'adminA', password: '1234', role: 'student', grade: 'Kinder A', profilePicUrl: 'https://placehold.co/64x64/ec4899/ffffff?text=A' },
            // Kinder B
            { name: 'Liam Kyrie Leyba', username: 'l.leyba', password: 'liamkb', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=LL' },
            { name: 'Lianna Kendra Leyba', username: 'k.leyba', password: 'kendrab', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=KL' },
            { name: 'Faith Brooke Iluzada', username: 'f.iluzada', password: 'faithb', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=FI' },
            { name: 'Azrael Berango', username: 'a.berango', password: 'azraelb', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=AB' },
            { name: 'Zavaiah Gazini Saliva', username: 'z.saliva', password: 'bayangb', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=ZS' },
            { name: 'Scarlette Amber Teope', username: 'a.teope', password: 'amberb', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=AT' },
            { name: 'adminB', username: 'admin', password: '1234', role: 'student', grade: 'Kinder B', profilePicUrl: 'https://placehold.co/64x64/d946ef/ffffff?text=A' },
            // Teacher
            { name: 'Teacher Pia', username: 't.j.tobias', password: 'TTC2016', role: 'teacher', grade: null, profilePicUrl: 'https://placehold.co/64x64/059669/ffffff?text=TP' },
            { name: 'Teacher Jaymarc', username: 't.j.descalso', password: 'TTC2016', role: 'teacher', grade: null, profilePicUrl: 'https://placehold.co/64x64/059669/ffffff?text=TJ' },
        ];

        // --- EDIT: New array for special, non-DB accounts (like admin) ---
        const SPECIAL_ACCOUNTS = [
            { name: 'TTC Admin', username: 'ttc.admin', password: '1234', role: 'admin', grade: null, profilePicUrl: 'https://placehold.co/64x64/84cc16/ffffff?text=ADMIN' }
        ];

        let app, db, auth;
        let state = {
            view: 'login', // login | dashboard | quiz | result | viewLesson | viewAssignment | viewAssignmentSubmissions | virtualClassroom | reviewQuiz
            // ### MODIFIED: Default tabs reordered AND gradeMeeting REMOVED ###
            dashboardTab: 'monitor', // For teacher: 'monitor' | 'announcements' | 'onlineClass' | 'lessons' | 'assignments' | 'viewSubmissions' | 'quizEditor' | 'gradeBook' | 'payments'
                                     // For student: 'onlineClass' | 'lessons' | 'assignments' | 'quizzes' | 'gradeBook' | 'mySubjects' | 'payments'
                                     // For admin: 'accountManager'
            currentUser: null,
            isAuthenticated: false,
            loading: false,
            loginError: null, // Bug Fix 1
            // Quiz State
            quizId: null,
            quizSubject: null,
            quizData: [],
            currentQuestionIndex: 0,
            selectedAnswer: null,
            quizFeedback: null,
            quizResponses: [],
            // NEW: Quiz Editor State
            isEditingQuiz: false,
            editingQuiz: null, // Will hold quiz data when editing
            // Data fetched from Firestore
            studentResults: [],
            studentStats: {},
            announcements: [],
            allQuizzes: [],
            allLessonSubmissions: [],
            // New Feature States
            lessonBooks: [],
            assignments: [],
            selectedLessonBookId: null,
            selectedLessonBook: null,
            currentLessonSlideIndex: 0,
            lessonBookProgress: {},
            selectedAssignmentId: null,
            selectedAssignment: null,
            assignmentSubmissions: [],
            myAssignmentSubmissions: {},
            isLessonModalOpen: false,
            isEditingLesson: false,
            editingLessonBook: null,
            isAssignmentModalOpen: false,
            isEditingAssignment: false,
            editingAssignment: null,
            // NEW: Payment State
            allPaymentSessions: [], // For teacher view
            studentPaymentSessions: [], // For student view
            isPaymentModalOpen: false,
            editingPaymentSession: null, // Data of session being edited
            // NEW: Admin State
            allUserProfiles: [], // For admin to manage
            isUserModalOpen: false,
            isEditingUser: false,
            editingUser: null,
            masterSubjectList: [], // <-- NEW
            // NEW: Virtual Classroom State
            allMeetings: [],
            selectedRoomId: null,
            selectedRoomTopic: null,
            jitsiApi: null,
            mediaPermissionError: null, // NEW: For permission errors
            selectedMeetingForGradingId: null, // ### MODIFIED: This is now unused, but harmless to keep in state ###
        };

        // --- Task 2: MASTER SUBJECT LIST ---
        const INITIAL_MASTER_SUBJECT_LIST = ["Science", "Filipino", "English", "Mathematics", "Araling Panlipunan", "EPP", "GMRC", "Reading and Literacy", "Language", "Makabansa"]; // <-- RENAMED
        
        // --- NEW: QUARTER LIST ---
        const QUARTERS = ['Q1', 'Q2', 'Q3', 'Q4', 'Other'];
        
        // --- NEW: Quarter Display Map ---
        const QUARTER_DISPLAY_MAP = {
            'Q1': 'Quarter 1',
            'Q2': 'Quarter 2',
            'Q3': 'Quarter 3',
            'Q4': 'Quarter 4',
            'Other': 'Summer Class' // As requested
        };

        // --- Task 2: Grade-Specific Subject Mapping ---
        const subjectMap = {
          "Kinder A": ["Reading and Literacy", "Mathematics"],
          "Kinder B": ["Reading and Literacy", "Mathematics"],
          "1": ["Language", "Reading and Literacy", "Mathematics", "Makabansa", "GMRC"],
          "2": ["English", "Filipino", "GMRC", "Makabansa", "Mathematics"],
          "3 BS": ["English", "Filipino", "Makabansa", "Mathematics", "Science"],
          "3 OLHRS": ["English", "Filipino", "Makabansa", "Mathematics", "Science", "CLE"],
          "3": ["English", "Filipino", "GMRC", "Makabansa", "Mathematics", "Science"],
          "4": ["Filipino", "Araling Panlipunan", "English", "Mathematics",  "Science", "Computer", "Research", "EPP"],
          "5": ["Filipino", "Araling Panlipunan", "English", "Mathematics", "Science", "Computer", "Research", "EPP"],
          "6": ["Filipino", "Araling Panlipunan", "English", "Mathematics", "Science", "Computer", "Research", "TLE"],
          "5 OLHRS": ["Filipino", "Araling Panlipunan", "English", "Mathematics", "Science", "Computer", "CLE", "TLE", "MAPEH"]
        };
        
        // --- NEW: Helper function to get a student's enrolled subjects ---
        function getEnrolledSubjects(student) {
            if (!student) return [];
            
            // 1. Get subjects from the grade-based map
            const grade = String(student.grade);
            let enrolledSubjects = subjectMap[grade] || [];
            
            // 2. Get custom subjects (from admin panel)
            const customSubjects = student.customSubjects || [];
            
            // 3. Combine and de-duplicate
            // --- SYNTAX FIX: Replaced spread operator ---
            const allSubjects = enrolledSubjects.concat(customSubjects);
            return allSubjects.filter((item, index) => allSubjects.indexOf(item) === index);
        }
        
        // --- Task 1: Grade Level Sorting Order ---
        const gradeSortOrder = ["Kinder A", "Kinder B", "1", "2", "3", "3 BS", "3 OLHRS", "4", "5", "6", "5 OLHRS", "All", "Ungraded"];


        /* [QUIZ DATA GOES HERE] */
        // All large QUIZ_CONTENT objects have been removed.

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initFirebase() {
            setLogLevel('Debug');
            if (!FIREBASE_CONFIG) {
                console.error("Firebase config is missing. Running in non-persistent mode.");
                renderApp(); // Render login even without Firebase
                return;
            }
            try {
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Firebase Auth State Changed: User signed in with UID:", user.uid);
                        // If state already has currentUser (from handleLogin), start listeners
                        if (state.currentUser && state.isAuthenticated) {
                            // Use the stable username as the ID, not the anonymous auth UID
                            startListeningForData(state.currentUser.username);
                        } else {
                            // This might happen if user refreshes page while logged in
                            // Attempt to find user data based on UID if possible (not implemented here as USERS array lacks UIDs)
                            // For now, if state is lost on refresh but auth persists, force login view
                             console.log("Auth state persists but local state lost, showing login.");
                             state.view = 'login';
                             state.currentUser = null;
                             state.isAuthenticated = false;
                             renderApp();
                        }
                    } else {
                        console.log("Firebase Auth State Changed: User signed out or not logged in.");
                        // Handle anonymous sign-in only if not already authenticated locally (prevents loop on logout)
                        if (!state.isAuthenticated) {
                            try {
                                if (INITIAL_AUTH_TOKEN) {
                                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                console.log("Anonymous/Custom auth completed.");
                                // Initial render after auth completes
                                renderApp();
                            } catch (error) {
                                console.error("Error signing in anonymously/custom:", error);
                                // Show login anyway even if anon fails
                                renderApp();
                            }
                        } else {
                             // User was authenticated locally but Firebase says signed out (e.g., after logout function)
                             // State is already reset, just render login
                             renderApp();
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('app-content').innerHTML = `
                    <div class="p-6 text-center text-red-600 bg-red-100 rounded-lg">
                        Error initializing Firebase: ${error.message}. Check console for details.
                    </div>
                `;
            }
        }

        // --- FIREBASE DATA LISTENERS (Real-time for Teacher/Student) ---

        let quizResultsUnsubscribe = null;
        let announcementsUnsubscribe = null;
        let lessonBooksUnsubscribe = null;
        let assignmentsUnsubscribe = null;
        let lessonSubmissionsUnsubscribe = null; // Specific student
        let assignmentSubmissionsUnsubscribe = null; // Specific student
        let allAssignmentSubmissionsUnsubscribe = null; // All (teacher)
        let allLessonSubmissionsUnsubscribe = null; // Task 5: All (teacher)
        let quizzesUnsubscribe = null;
        let userProfileUnsubscribe = null;
        let paymentSessionsUnsubscribe = null; // NEW: For teacher
        let studentPaymentSessionsUnsubscribe = null; // NEW: For student
        // NEW: Admin/Teacher listener for all user profiles
        let allUserProfilesUnsubscribe = null;
        let subjectsConfigUnsubscribe = null; // <-- NEW
        // NEW: Virtual Classroom listener
        let allMeetingsUnsubscribe = null;

        function startListeningForData(stableId) { // Renamed 'uid' to 'stableId' for clarity
            if (!db || !state.currentUser) {
                 console.warn("Attempted to start listeners but DB or current user is not ready.");
                 return;
            }
            stopListeningForData(); // Clear any existing listeners
            console.log(`Starting listeners for stableId: ${stableId}, Role: ${state.currentUser.role}`);

            // *** NEW LISTENER FOR USER PROFILE DATA ***
            // Listen to the user's specific doc in quiz_results for profile info
            // --- EDIT: Only listen if not admin, as admin doesn't have a profile doc ---
            if (state.currentUser.role !== 'admin') {
                const userProfileDocRef = doc(db, QUIZ_RESULTS_COLLECTION_PATH, stableId); // Use stableId
                userProfileUnsubscribe = onSnapshot(userProfileDocRef, (docSnap) => {
                    let docExists = docSnap.exists();
                    let profileData = docExists ? docSnap.data() : {};
                    let picToUse = state.currentUser.profilePicUrl; // Default from USERS array
                    let picSource = 'default';
                    let needsFirestoreUpdate = false;
                    let newFirestoreData = {};

                    // 1. Check Firestore for a pic. This is the source of truth.
                    if (docExists && profileData.profilePicUrl) {
                        picToUse = profileData.profilePicUrl;
                        picSource = 'firestore';
                    }

                    // 2. Check localStorage (cache) - REMOVED LOGIC THAT OVERWRITES FIRESTORE
                    // We only check local storage on upload, not on read. Firestore is the source of truth.
                    let cachedPic = null;
                    try {
                        cachedPic = localStorage.getItem(`profilePic_${state.currentUser.username}`);
                    } catch (e) { console.warn("Could not read profile pic from localStorage", e); }

                    // 3. Update state if needed
                    if (state.currentUser.profilePicUrl !== picToUse) {
                        console.log(`Updating profile pic from: ${picSource}`);
                        state.currentUser.profilePicUrl = picToUse;
                        renderApp(); // Re-render with the correct pic
                    }
                    
                    // 4. Cache pic from Firestore if local cache is missing or different
                    if (picSource === 'firestore' && cachedPic !== picToUse) {
                        try {
                            localStorage.setItem(`profilePic_${state.currentUser.username}`, picToUse);
                        } catch (e) { console.warn("Could not cache profile pic to localStorage", e); }
                    }

                    // 5. Ensure user doc exists and has basic info
                    if (!docExists) {
                        needsFirestoreUpdate = true;
                        newFirestoreData = {
                            userId: stableId, // Use stableId
                            name: state.currentUser.name,
                            grade: state.currentUser.grade,
                            profilePicUrl: picToUse, // Save default or FS pic
                            subjects: {} // Initialize subjects
                        };
                    } else if (!profileData.userId || !profileData.name) {
                        // Doc exists but is missing basic info (e.g., created by submitQuiz)
                        needsFirestoreUpdate = true;
                        newFirestoreData.userId = stableId; // Use stableId
                        newFirestoreData.name = state.currentUser.name;
                        newFirestoreData.grade = state.currentUser.grade;
                    }
                    
                    // 6. Perform Firestore update if needed
                    if (needsFirestoreUpdate) {
                        console.log("Updating user profile doc in Firestore (basic info):", newFirestoreData);
                        setDoc(userProfileDocRef, newFirestoreData, { merge: true })
                            .catch(e => console.error("Could not create/update user profile doc", e));
                    }

                }, (error) => {
                    console.error("Error listening to User Profile Doc:", error);
                    onDataLoadError(error); // Call error handler
                });
            }
            // *** END NEW LISTENER ***

            // Listener for Quiz Results
            const resultsQuery = query(collection(db, QUIZ_RESULTS_COLLECTION_PATH));
            quizResultsUnsubscribe = onSnapshot(resultsQuery, (snapshot) => {
                const allStudentResults = [];
                const currentUserStats = {};

                snapshot.docs.forEach(doc => {
                    const studentData = doc.data();
                    // --- SYNTAX FIX: Replaced spread operator ---
                    allStudentResults.push(Object.assign({ id: doc.id }, studentData)); // Include doc ID

                    if (studentData.userId === stableId) { // Use stableId
                        if (studentData.subjects) {
                            for (const subject in studentData.subjects) {
                                const subjectData = studentData.subjects[subject];
                                if (subjectData.attempts && subjectData.attempts.length > 0) {
                                    // --- FIX: Store the raw attempts array ---
                                    currentUserStats[subject] = {
                                        attempts: subjectData.attempts // Store all attempts for later filtering
                                    };
                                    // --- END FIX ---
                                }
                            }
                        }
                    }
                });

                state.studentResults = allStudentResults;
                state.studentStats = currentUserStats;
                renderApp();
            }, (error) => {
                console.error("Error listening to Quiz Results:", error);
                onDataLoadError(error); // Call error handler
            });

            // Listener for Announcements
            const announcementsQuery = query(collection(db, ANNOUNCEMENTS_COLLECTION_PATH));
            announcementsUnsubscribe = onSnapshot(announcementsQuery, (snapshot) => {
                // --- SYNTAX FIX: Replaced spread operator ---
                const announcements = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()));
                state.announcements = announcements.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderApp();
            }, (error) => {
                console.error("Error listening to Announcements:", error);
                onDataLoadError(error); // Call error handler
            });

            // Listener for Lesson Books
            const lessonBooksQuery = query(collection(db, LESSON_BOOKS_COLLECTION_PATH));
            lessonBooksUnsubscribe = onSnapshot(lessonBooksQuery, (snapshot) => {
                // --- SYNTAX FIX: Replaced spread operator ---
                state.lessonBooks = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                                           .sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderApp();
            }, (error) => {
                console.error("Error listening to Lesson Books:", error);
                onDataLoadError(error); // Call error handler
            });

            // Listener for Assignments
            const assignmentsQuery = query(collection(db, ASSIGNMENTS_COLLECTION_PATH));
            assignmentsUnsubscribe = onSnapshot(assignmentsQuery, (snapshot) => {
                // --- SYNTAX FIX: Replaced spread operator ---
                state.assignments = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                                         .sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderApp();
            }, (error) => {
                console.error("Error listening to Assignments:", error);
                onDataLoadError(error); // Call error handler
            });

            // Listener for Student's Lesson Submissions (Only for students)
             if (state.currentUser.role === 'student') {
                const studentLessonSubmissionsQuery = query(collection(db, LESSON_SUBMISSIONS_COLLECTION_PATH), where("userId", "==", stableId)); // Use stableId
                lessonSubmissionsUnsubscribe = onSnapshot(studentLessonSubmissionsQuery, (snapshot) => {
                    const progress = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        // --- SYNTAX FIX: Replaced spread operator ---
                        progress[data.lessonBookId] = Object.assign({ id: doc.id }, data); // Store doc id for updates
                    });
                    state.lessonBookProgress = progress;
                    renderApp();
                }, (error) => {
                    console.error("Error listening to Student Lesson Submissions:", error);
                    onDataLoadError(error); // Call error handler
                });
            }

            // Listener for Student's Assignment Submissions (Only for students)
             if (state.currentUser.role === 'student') {
                const studentAssignmentSubmissionsQuery = query(collection(db, ASSIGNMENT_SUBMISSIONS_COLLECTION_PATH), where("userId", "==", stableId)); // Use stableId
                assignmentSubmissionsUnsubscribe = onSnapshot(studentAssignmentSubmissionsQuery, (snapshot) => {
                    const submissions = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        // --- SYNTAX FIX: Replaced spread operator ---
                        submissions[data.assignmentId] = Object.assign({ id: doc.id }, data); // Store doc id for updates
                    });
                    state.myAssignmentSubmissions = submissions;
                    renderApp();
                }, (error) => {
                    console.error("Error listening to Student Assignment Submissions:", error);
                    onDataLoadError(error); // Call error handler
                });
             }
             
             // NEW: Listener for Student's Payment Sessions (Only for students)
             if (state.currentUser.role === 'student') {
                const studentPaymentSessionsQuery = query(collection(db, PAYMENT_SESSIONS_COLLECTION_PATH), where("studentId", "==", stableId)); // Use stableId
                studentPaymentSessionsUnsubscribe = onSnapshot(studentPaymentSessionsQuery, (snapshot) => {
                    // --- SYNTAX FIX: Replaced spread operator ---
                    state.studentPaymentSessions = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                        .sort((a, b) => (b.sessionStartDate?.toDate?.() || 0) - (a.sessionStartDate?.toDate?.() || 0)); // Show newest first
                    renderApp();
                }, (error) => {
                    console.error("Error listening to Student Payment Sessions:", error);
                    onDataLoadError(error); // Call error handler
                });
             }


            // Listener for ALL Quizzes (Task 1) - Needed by both teacher and student
            const quizzesQuery = query(collection(db, QUIZZES_COLLECTION_PATH));
            quizzesUnsubscribe = onSnapshot(quizzesQuery, (snapshot) => {
                // --- SYNTAX FIX: Replaced spread operator ---
                state.allQuizzes = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()));
                renderApp();
            }, (error) => {
                console.error("Error listening to Quizzes:", error);
                onDataLoadError(error); // Call error handler
            });

            // Listeners ONLY FOR TEACHERS
            if (state.currentUser.role === 'teacher') {
                 // Listener for ALL Assignment Submissions
                const allAssignmentSubmissionsQuery = query(collection(db, ASSIGNMENT_SUBMISSIONS_COLLECTION_PATH));
                allAssignmentSubmissionsUnsubscribe = onSnapshot(allAssignmentSubmissionsQuery, (snapshot) => {
                    // --- SYNTAX FIX: Replaced spread operator ---
                    const submissions = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                                             .sort((a, b) => (b.submissionTimestamp?.toMillis() || 0) - (a.submissionTimestamp?.toMillis() || 0));
                    state.assignmentSubmissions = submissions;
                    renderApp();
                }, (error) => {
                    console.error("Error listening to All Assignment Submissions:", error);
                    onDataLoadError(error); // Call error handler
                });

                // Task 5: Listener for ALL Lesson Submissions
                const allLessonSubmissionsQuery = query(collection(db, LESSON_SUBMISSIONS_COLLECTION_PATH));
                allLessonSubmissionsUnsubscribe = onSnapshot(allLessonSubmissionsQuery, (snapshot) => {
                    // --- SYNTAX FIX: Replaced spread operator ---
                    state.allLessonSubmissions = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()));
                    renderApp();
                }, (error) => {
                    console.error("Error listening to All Lesson Submissions:", error);
                    onDataLoadError(error); // Call error handler
                });
                
                // NEW: Listener for ALL Payment Sessions
                // This listener is now active for Teachers (read-only potentially?) NO, moved to Admin.
                // However, keeping the data fetch here doesn't hurt, but we will move the UI.
                // Actually, let's keep it but only Admin will see the UI.
            }

            // --- EDIT: Listener for ADMIN and TEACHER (for user lists) ---
            if (state.currentUser.role === 'admin' || state.currentUser.role === 'teacher') {
                const profilesQuery = query(collection(db, USER_PROFILES_COLLECTION_PATH));
                allUserProfilesUnsubscribe = onSnapshot(profilesQuery, (snapshot) => {
                    // --- SYNTAX FIX: Replaced spread operator ---
                    state.allUserProfiles = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    renderApp();
                }, (error) => {
                    console.error("Error listening to User Profiles:", error);
                    onDataLoadError(error); // Call error handler
                });
            }
            
            // --- NEW: Payment Listener for ADMIN (with Auto-Deactivation) ---
            if (state.currentUser.role === 'admin') {
                const allPaymentSessionsQuery = query(collection(db, PAYMENT_SESSIONS_COLLECTION_PATH));
                paymentSessionsUnsubscribe = onSnapshot(allPaymentSessionsQuery, (snapshot) => {
                    state.allPaymentSessions = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                        .sort((a, b) => (b.lastUpdated?.toMillis() || 0) - (a.lastUpdated?.toMillis() || 0));
                    
                    // ### AUTO-DEACTIVATION LOGIC ###
                    checkOverduePaymentsAndDeactivate(state.allPaymentSessions);
                    
                    renderApp();
                }, (error) => {
                    console.error("Error listening to All Payment Sessions:", error);
                    onDataLoadError(error);
                });
            }

            // --- NEW: Listener for Online Class Meetings (for everyone) ---
            const meetingsQuery = query(collection(db, MEETINGS_COLLECTION_PATH));
            allMeetingsUnsubscribe = onSnapshot(meetingsQuery, (snapshot) => {
                // --- SYNTAX FIX: Replaced spread operator ---
                state.allMeetings = snapshot.docs.map(doc => Object.assign({ id: doc.id }, doc.data()))
                    .sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); // Show newest first
                renderApp();
            }, (error) => {
                console.error("Error listening to Meetings:", error);
                onDataLoadError(error); // Call error handler
            });

            // --- NEW: Listener for Master Subject List (for everyone) ---
            const subjectDocRef = doc(db, SUBJECTS_CONFIG_PATH);
            subjectsConfigUnsubscribe = onSnapshot(subjectDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.list && Array.isArray(data.list)) {
                        state.masterSubjectList = data.list.sort();
                    } else {
                        // Data is malformed, reset it
                        console.warn("Subjects config doc is malformed. Resetting...");
                        await setDoc(subjectDocRef, { list: INITIAL_MASTER_SUBJECT_LIST.sort() });
                    }
                } else {
                    // Doc doesn't exist, create it with the initial list
                    console.log("No subjects config doc found, creating one...");
                    await setDoc(subjectDocRef, { list: INITIAL_MASTER_SUBJECT_LIST.sort() });
                    // state.masterSubjectList will be set by the listener firing again
                }
                renderApp(); // Re-render in case dropdowns need updating
            }, (error) => {
                console.error("Error listening to Subjects Config:", error);
                onDataLoadError(error); // Call error handler
            });
        }

        function stopListeningForData() {
            if (quizResultsUnsubscribe) quizResultsUnsubscribe();
            if (announcementsUnsubscribe) announcementsUnsubscribe();
            if (lessonBooksUnsubscribe) lessonBooksUnsubscribe();
            if (assignmentsUnsubscribe) assignmentsUnsubscribe();
            if (lessonSubmissionsUnsubscribe) lessonSubmissionsUnsubscribe(); // Specific student
            if (assignmentSubmissionsUnsubscribe) assignmentSubmissionsUnsubscribe(); // Specific student
            if (allAssignmentSubmissionsUnsubscribe) allAssignmentSubmissionsUnsubscribe(); // All (teacher)
            if (allLessonSubmissionsUnsubscribe) allLessonSubmissionsUnsubscribe(); // Task 5: All (teacher)
            if (quizzesUnsubscribe) quizzesUnsubscribe();
            if (userProfileUnsubscribe) userProfileUnsubscribe();
            if (paymentSessionsUnsubscribe) paymentSessionsUnsubscribe(); // NEW
            if (studentPaymentSessionsUnsubscribe) studentPaymentSessionsUnsubscribe(); // NEW
            // NEW: Stop admin/teacher user profile listener
            if (allUserProfilesUnsubscribe) allUserProfilesUnsubscribe();
            // NEW: Stop meetings listener
            if (allMeetingsUnsubscribe) allMeetingsUnsubscribe();
            if (subjectsConfigUnsubscribe) subjectsConfigUnsubscribe(); // <-- NEW

            quizResultsUnsubscribe = null;
            announcementsUnsubscribe = null;
            lessonBooksUnsubscribe = null;
            assignmentsUnsubscribe = null;
            lessonSubmissionsUnsubscribe = null;
            assignmentSubmissionsUnsubscribe = null;
            allAssignmentSubmissionsUnsubscribe = null;
            allLessonSubmissionsUnsubscribe = null;
            quizzesUnsubscribe = null;
            userProfileUnsubscribe = null;
            paymentSessionsUnsubscribe = null; // NEW
            studentPaymentSessionsUnsubscribe = null; // NEW
            allUserProfilesUnsubscribe = null; // NEW: Admin/Teacher
            subjectsConfigUnsubscribe = null; // <-- NEW
            allMeetingsUnsubscribe = null; // NEW
            console.log("Stopped Firestore listeners.");
        }
        
        // ### NEW: Auto-Deactivation Function ###
        async function checkOverduePaymentsAndDeactivate(sessions) {
            if (!db || state.currentUser.role !== 'admin') return;
            
            const now = new Date();
            const overdueSessionIds = [];
            const studentsToDeactivate = new Set();

            sessions.forEach(session => {
                // Check for expiration
                let endDate = session.sessionEndDate;
                if (endDate && endDate.toDate) endDate = endDate.toDate();
                else if (endDate) endDate = new Date(endDate);

                const isExpired = endDate && endDate < now;
                const isPaid = session.paymentStatus === 'Paid';
                
                // 1. Identify expired sessions that aren't marked Overdue/Paid
                if (isExpired && !isPaid && session.paymentStatus !== 'Overdue') {
                     overdueSessionIds.push(session.id);
                     studentsToDeactivate.add(session.studentId);
                }
                
                // 2. Identify existing Overdue sessions
                if (session.paymentStatus === 'Overdue') {
                    studentsToDeactivate.add(session.studentId);
                }
            });
            
            // Update Sessions to 'Overdue'
            if (overdueSessionIds.length > 0) {
                console.log("System: Marking sessions as overdue:", overdueSessionIds);
                overdueSessionIds.forEach(id => {
                     updateDoc(doc(db, PAYMENT_SESSIONS_COLLECTION_PATH, id), { 
                         paymentStatus: 'Overdue',
                         lastUpdated: serverTimestamp()
                     }).catch(e => console.error("Auto-update failed", e));
                });
            }
            
            // Deactivate Users
            if (studentsToDeactivate.size > 0) {
                // Wait for user profiles to be loaded if possible, or just try update
                studentsToDeactivate.forEach(studentId => {
                    // Check if currently active before writing to DB to save writes
                    const userProfile = state.allUserProfiles.find(u => u.username === studentId);
                    if (userProfile && userProfile.status !== 'inactive') {
                        console.log("System: Deactivating overdue student account:", studentId);
                        updateDoc(doc(db, USER_PROFILES_COLLECTION_PATH, studentId), {
                            status: 'inactive'
                        }).catch(e => console.error("Auto-deactivate failed", e));
                    }
                });
            }
        }


        // --- AUTH & STATE MANAGEMENT FUNCTIONS ---

        function setLoading(isLoading) {
            state.loading = isLoading;
            renderApp();
        }

        // Add this new error handler function
        function onDataLoadError(error) {
          console.error("Firestore listener failed: ", error);
          setLoading(false); // Hide the spinner
          // Use a simple alert, as custom modals might not work if rendering failed
          // alert("Error loading data from the server. Please check your internet connection and refresh the page. Error: " + error.message);
           // Display error message in a designated area if possible
           const errorDisplay = document.getElementById('app-content');
           if (errorDisplay) {
               errorDisplay.innerHTML = `
                   <div class="p-6 text-center text-red-600 bg-red-100 rounded-lg card">
                       Error loading data: ${error.message}. Please refresh the page.
                   </div>
               `;
           }
        }

        // Bug Fix 1: Clear login error when user starts typing
        function clearLoginError() {
            if (state.loginError) {
                state.loginError = null;
                renderApp();
            }
        }

        // --- EDIT: Major rewrite of handleLogin ---
        async function handleLogin(username, password) {
            // ### FIX: Read checkbox state *before* setLoading re-renders the page ###
            const saveLogin = document.getElementById('saveLogin')?.checked || false;

            setLoading(true); // START loading spinner
            state.loginError = null; // Clear previous errors
            
            // ### MOVED: This line was moved to the top of the function ###
            // const saveLogin = document.getElementById('saveLogin')?.checked || false;

            if (!username || !password) {
                state.loginError = "Please enter a username and password.";
                setLoading(false);
                renderApp();
                return;
            }
            
            try {
                let user = null;

                // 1. Check for special (admin) account first
                const specialUser = SPECIAL_ACCOUNTS.find(u => u.username === username && u.password === password);
                
                if (specialUser) {
                    // --- SYNTAX FIX: Replaced spread operator ---
                    user = Object.assign({}, specialUser); // Found admin
                } else {
                    // 2. If not admin, check Firestore user_profiles
                    if (!db) {
                        throw new Error("Database not connected. Cannot log in.");
                    }
                    
                    const userDocRef = doc(db, USER_PROFILES_COLLECTION_PATH, username);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        state.loginError = "Login failed. Please double-check for typos, extra spaces, or incorrect capitalization in your username or password.";
                        setLoading(false);
                        renderApp();
                        return;
                    }

                    const dbUser = userDoc.data();

                    if (dbUser.password !== password) {
                        state.loginError = "Login failed. Please double-check for typos, extra spaces, or incorrect capitalization in your username or password.";
                        setLoading(false);
                        renderApp();
                        return;
                    }

                    if (dbUser.status !== 'active') {
                        state.loginError = "This account is currently deactivated. Please contact the administrator.";
                        setLoading(false);
                        renderApp();
                        return;
                    }

                    // 3. Login success for Firestore user
                    // --- SYNTAX FIX: Replaced spread operator ---
                    user = Object.assign({}, dbUser);
                }

                // 4. Set state for successful login (for both admin and other users)
                if (user) {
                    // Handle grade mapping (moved from original code)
                    if (user.grade === '3.1' || user.grade === '3.2') {
                        user.grade = 3;
                    } else if (user.grade === '5.1') {
                        user.grade = 5;
                    }

                    state.currentUser = user; // This now includes profilePicUrl
                    state.isAuthenticated = true;
                    state.view = 'dashboard';
                    
                    // ### NEW: Save or clear login info in localStorage ###
                    try {
                        if (saveLogin) {
                            localStorage.setItem('ttc_saved_username', username);
                            // --- REVERT: Save password as requested ---
                            localStorage.setItem('ttc_saved_password', password); 
                            console.log("Login info saved.");
                        } else {
                            localStorage.removeItem('ttc_saved_username');
                            localStorage.removeItem('ttc_saved_password');
                            console.log("Saved login info cleared.");
                        }
                    } catch (e) {
                        console.warn("Could not access localStorage to save login info.", e);
                    }
                    // ### END NEW ###

                     // Check if Firebase auth has initialized and has a user
                     if (auth && auth.currentUser) {
                         console.log("Login successful, starting listeners for stableId:", user.username);
                         startListeningForData(user.username); // Use username as stableId
                     } else {
                         console.warn("Login successful but Firebase auth not ready yet. Listeners will start on auth state change.");
                         renderApp();
                     }
                    
                    setLoading(false); // Stop loading spinner

                } else {
                    // This case should be handled by the checks above, but as a fallback:
                    state.isAuthenticated = false;
                    state.loginError = "Login failed. Please double-check for typos, extra spaces, or incorrect capitalization in your username or password.";
                    setLoading(false); // Turn off loading on failed login
                    renderApp();
                }
            } catch (error) {
                console.error("Login error:", error);
                state.isAuthenticated = false; // Ensure logged out state on error
                state.loginError = "An unexpected error occurred during login. Check console.";
                setLoading(false); // Turn off loading on error
                renderApp();
            }
        }


        async function handleLogout() {
            setLoading(true);
            try {
                stopListeningForData(); // Stop all listeners
                const previousAuthState = auth?.currentUser; // Check if user was actually signed in
                const previousUser = state.currentUser; // Capture the user about to log out

                // Reset state object FIRST
                const wasAuthenticated = state.isAuthenticated; // Keep track if we were logged in
                state.view = 'login';
                state.dashboardTab = 'monitor';
                state.currentUser = null;
                state.isAuthenticated = false; // Set to false immediately
                state.loading = true; // Keep loading until re-auth completes
                state.loginError = null;
                // Reset other data states
                state.quizId = null;
                state.quizSubject = null; state.quizData = []; state.currentQuestionIndex = 0; state.selectedAnswer = null; state.quizFeedback = null; state.quizResponses = [];
                state.isEditingQuiz = false; state.editingQuiz = null; // NEW: Reset quiz editor
                state.studentResults = []; state.studentStats = {}; state.announcements = []; state.allQuizzes = []; state.allLessonSubmissions = [];
                state.lessonBooks = []; state.assignments = [];
                state.selectedLessonBookId = null; state.selectedLessonBook = null; state.currentLessonSlideIndex = 0; state.lessonBookProgress = {};
                state.selectedAssignmentId = null; state.selectedAssignment = null; state.assignmentSubmissions = []; state.myAssignmentSubmissions = {};
                state.isLessonModalOpen = false; state.isEditingLesson = false; state.editingLessonBook = null;
                state.isAssignmentModalOpen = false; state.isEditingAssignment = false; state.editingAssignment = null;
                // NEW: Reset Payment State
                state.allPaymentSessions = []; state.studentPaymentSessions = []; state.isPaymentModalOpen = false; state.editingPaymentSession = null;
                state.isEditingUser = false; state.editingUser = null;
                // NEW: Reset Classroom State
                state.allMeetings = []; state.selectedRoomId = null; state.selectedRoomTopic = null; state.jitsiApi = null;
                state.mediaPermissionError = null; // NEW: Reset permission error
                state.selectedMeetingForGradingId = null; // ### MODIFIED: Reset grading state ###
            
                /* ### BUG FIX: Removed 'let state = { ... }' redeclaration ###
                   This entire block was a bug. It created a new local 'state'
                   variable instead of modifying the global one, preventing logout.
                */
        
                renderApp(); // Render login view immediately
                
                // --- NEW: CLEAR USER-SPECIFIC LOCAL STORAGE (CRITICAL for isolation) ---
                if (previousUser) {
                    const quizKeyPrefix = `unfinishedQuiz_${previousUser.username}_`;
                    // Clear the general profile pic key
                    try {
                        localStorage.removeItem(`profilePic_${previousUser.username}`);
                        console.log(`Cleared profile pic cache for ${previousUser.username}`);

                        // Clear ALL quiz progress keys for this user (they are keyed by subject and grade)
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(quizKeyPrefix)) {
                                localStorage.removeItem(key);
                                i--; // Decrement index because we removed an item
                            }
                        }
                        console.log(`Cleared all quiz progress cache for ${previousUser.username}.`);
                    } catch (e) {
                        console.warn("Could not clear user-specific localStorage keys:", e);
                    }
                }
                // --- END CLEAR LOCAL STORAGE ---


                if (auth && previousAuthState && wasAuthenticated) { // Only sign out if Firebase auth exists and user was logged in
                    await signOut(auth);
                    console.log("Firebase user signed out.");
                } else {
                     console.log("Skipping Firebase signOut (user wasn't logged in or auth not ready).");
                }

                // Re-initialize anonymous auth after sign-out or if never logged in
                 if (auth) {
                    console.log("Attempting anonymous/custom sign-in after logout/initial load.");
                    if (INITIAL_AUTH_TOKEN) {
                        await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                    } else {
                        await signInAnonymously(auth);
                    }
                     console.log("Re-authentication complete.");
                 } else {
                     console.warn("Auth not initialized, cannot re-authenticate anonymously.");
                 }

            } catch (e) {
                console.error("Error during logout or re-authentication:", e);
                state.loginError = "Error during logout. Please refresh."; // Inform user
            } finally {
                // Now that re-auth should be done (or failed), turn off loading
                state.loading = false;
                renderApp(); // Re-render to remove loading indicator and show potential error
            }
        }


        function navigateTo(view, subject = null) {
            state.view = view;

            // Reset quiz/lesson/assignment specific states unless continuing quiz
            if (view !== 'quiz' && view !== 'result' && view !== 'reviewQuiz') { // Keep quiz state for result page
                state.quizId = null;
                state.quizSubject = null;
                state.quizData = [];
                state.currentQuestionIndex = 0;
                state.selectedAnswer = null;
                state.quizFeedback = null;
                state.quizResponses = [];
            } else if (view === 'quiz') {
                 // Quiz subject/id are now set directly by startNewQuiz/loadAndContinueQuiz
            } else if (view === 'reviewQuiz') {
                const quiz = state.allQuizzes.find(q => q.id === subject); // subject is quizId
                if (quiz) {
                    state.quizId = quiz.id;
                    state.quizSubject = quiz.subject;
                    state.quizData = quiz.questions || [];
                } else {
                    console.error("Quiz not found for review:", subject);
                    state.quizId = null; state.quizSubject = null; state.quizData = [];
                }
            }

            // NEW: Clear quiz editor state when navigating away from it
            if (view !== 'dashboard' || state.dashboardTab !== 'quizEditor') {
                state.isEditingQuiz = false;
                state.editingQuiz = null;
            }

            state.selectedLessonBookId = (view === 'viewLesson') ? subject : null;
            state.selectedLessonBook = (view === 'viewLesson' && subject) ? state.lessonBooks.find(lb => lb.id === subject) : null;
            state.currentLessonSlideIndex = 0; // Reset slide index when navigating TO a lesson
            state.selectedAssignmentId = (view === 'viewAssignment' || (state.currentUser?.role === 'teacher' && view === 'dashboard' && state.dashboardTab === 'viewSubmissions')) ? subject : null;
            state.selectedAssignment = (view === 'viewAssignment' || (state.currentUser?.role === 'teacher' && view === 'dashboard' && state.dashboardTab === 'viewSubmissions')) && subject ? state.assignments.find(a => a.id === subject) : null;
            
            // ### MODIFIED: REMOVED grading state logic ###
            if (view !== 'dashboard' || state.dashboardTab !== 'gradeMeeting') {
                state.selectedMeetingForGradingId = null;
            }

            // NEW: Clear Jitsi state if navigating away from classroom
            if (view !== 'virtualClassroom' && state.jitsiApi) {
                console.log("Navigating away from classroom, disposing Jitsi API.");
                state.jitsiApi.dispose();
                state.jitsiApi = null;
                state.selectedRoomId = null;
                state.selectedRoomTopic = null;
            }

            // Task 1: Quiz data is loaded in startNewQuiz/loadAndContinueQuiz, not here.

            renderApp();
        }


        function setDashboardTab(tab) {
            state.dashboardTab = tab;
            // NEW: Clear quiz editor state when switching tabs
            if (tab !== 'quizEditor') {
                state.isEditingQuiz = false;
                state.editingQuiz = null;
            }
            // ### MODIFIED: REMOVED grading state logic ###
            if (tab !== 'gradeMeeting') {
                state.selectedMeetingForGradingId = null;
            }
            renderApp();
        }

        // --- ANNOUNCEMENT FUNCTIONS ---
        async function handlePostAnnouncement(event) {
            event.preventDefault();
            if (!db) { console.error("Firestore not initialized"); return; }
            const title = event.target.title.value;
            const content = event.target.content.value;
            const gradeLevel = event.target.gradeLevel.value;

            if (!title || !content || !gradeLevel) {
                console.warn("Please fill out all announcement fields.");
                return;
            }

            setLoading(true);
            try {
                await addDoc(collection(db, ANNOUNCEMENTS_COLLECTION_PATH), {
                    title: title,
                    content: content,
                    gradeLevel: gradeLevel,
                    teacherName: state.currentUser.name,
                    teacherId: state.currentUser.username, // ### MODIFIED: Add teacherId
                    timestamp: serverTimestamp()
                });
                event.target.reset(); // Clear form
            } catch (error) {
                console.error("Error adding announcement: ", error);
            } finally {
                setLoading(false);
            }
        }

        async function handleDeleteAnnouncement(announcementId) {
            if (!db) { console.error("Firestore not initialized"); return; }
            // Bypassing confirm dialog as per rules
            console.log("Deleting announcement:", announcementId);
            setLoading(true);
            try {
                await deleteDoc(doc(db, ANNOUNCEMENTS_COLLECTION_PATH, announcementId));
            } catch (error) {
                console.error("Error deleting announcement: ", error);
            } finally {
                setLoading(false);
            }
        }
        
        // --- NEW: VIRTUAL CLASSROOM FUNCTIONS ---

        async function handleCreateMeeting(event) {
            // ### FIX: Removed incorrect nesting of handleEndMeeting ###
            
            const form = event.target;
            const topic = form.roomTopic.value.trim();
            const gradeLevel = form.gradeLevel.value;
            const subject = form.subject.value;
            // ### NEW: Get quarter ###
            const quarter = form.quarter.value;
            // ### NEW: Get external link and start time ###
            const externalLink = form.externalLink.value.trim();
            const startTimeValue = form.startTime.value;
            
            // Handle multi-select participants
            const participants = [];
            for (var i = 0; i < form.participants.options.length; i++) {
                if (form.participants.options[i].selected) {
                    participants.push(form.participants.options[i].value);
                }
            }

            if (!topic) {
                console.warn("Topic is required.");
                // You might want to show an error to the user
                return;
            }

            setLoading(true);
            try {
                // ### NEW: Logic for external vs. Jitsi ###
                let meetingData = {
                    topic: topic,
                    teacherName: state.currentUser.name,
                    teacherId: state.currentUser.username,
                    createdAt: serverTimestamp(),
                    gradeLevel: gradeLevel,
                    subject: subject,
                    quarter: quarter, // ### NEW: Save quarter ###
                    participants: participants,
                    startTime: startTimeValue ? new Date(startTimeValue) : null, // Save start time
                    externalLink: null,
                    meetingType: 'jitsi', // Default to Jitsi
                    roomId: null
                };

                if (externalLink) {
                    // This is an external meeting
                    meetingData.externalLink = externalLink;
                    meetingData.meetingType = 'external';
                    
                    await addDoc(collection(db, MEETINGS_COLLECTION_PATH), meetingData);
                    form.reset(); // Clear the form
                    console.log("External meeting link posted.");
                    setLoading(false); // Done
                    // renderApp(); // ### FIX: REMOVED this. The onSnapshot listener will handle rendering. ###
                    
                } else {
                    // This is a Jitsi meeting
                    const roomId = crypto.randomUUID(); // Generate a unique room ID
                    meetingData.roomId = roomId;
                    
                    await addDoc(collection(db, MEETINGS_COLLECTION_PATH), meetingData);
                    form.reset(); // Clear the form
                    console.log("Jitsi meeting created:", roomId);
                    
                    // Automatically join the meeting after creating it
                    await requestMediaPermissionsAndJoin(roomId, topic);
                }
                
            } catch (error) {
                console.error("Error creating meeting:", error);
                setLoading(false); // Ensure loading is turned off on error
            }
        }

        // ### NEW: Function to request permissions BEFORE joining ###
        async function requestMediaPermissionsAndJoin(roomId, topic) {
            if (!roomId || !topic) {
                console.error("Room ID or Topic missing.");
                return;
            }
            
            setLoading(true);
            state.mediaPermissionError = null; // Clear previous errors
            renderApp(); // Show loading spinner

            try {
                // 1. Request permissions
                console.log("Requesting media permissions...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                
                // 2. Success! Stop the tracks immediately, we just needed the permission.
                // Jitsi will ask for its own stream.
                console.log("Permissions granted. Stopping temporary stream.");
                stream.getTracks().forEach(track => track.stop());

                // 3. Proceed to join the meeting
                console.log(`Joining meeting: ${topic} (ID: ${roomId})`);
                state.view = 'virtualClassroom';
                state.selectedRoomId = roomId;
                state.selectedRoomTopic = topic;
                
                // ### FIX 1: Turn off loading spinner on success ###
                setLoading(false);
                renderApp();

            } catch (error) {
                // 4. Failure! User denied or no devices.
                console.error("Media permission denied or error:", error.name, error.message);
                setLoading(false);
                
                if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                    state.mediaPermissionError = "Camera and microphone access was denied. Please allow access in your browser settings and try again.";
                } else if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
                    state.mediaPermissionError = "No camera or microphone was found. Please connect your devices and try again.";
                } else {
                    state.mediaPermissionError = "An error occurred while accessing your camera/microphone. Please try again.";
                }
                
                renderApp(); // Re-render dashboard to show the error
            }
        }

        function handleJoinMeeting(roomId, topic) {
            // This function is now just a stub, the logic is in requestMediaPermissionsAndJoin
            // But it's kept in case it's called from somewhere else (though it shouldn't be)
            console.warn("handleJoinMeeting called directly, redirecting to requestMediaPermissionsAndJoin");
            requestMediaPermissionsAndJoin(roomId, topic);
        }

        async function handleEndMeeting(meetingId) {
            if (!db || !state.currentUser || state.currentUser.role !== 'teacher') return;
            
            // ### MODIFIED: This function now marks as ended AND navigates to grading ###
            console.log("Ending meeting and preparing for grading:", meetingId);
            setLoading(true);
            try {
                const meetingDocRef = doc(db, MEETINGS_COLLECTION_PATH, meetingId);
                
                // 1. Update the meeting doc to set status to 'ended'
                await updateDoc(meetingDocRef, {
                    status: 'ended'
                });
                console.log("Meeting marked as 'ended'.");

                // 2. Set state for grading
                state.selectedMeetingForGradingId = meetingId;
                state.dashboardTab = 'gradeMeeting';
                
                // 3. Navigate teacher back to the dashboard (which will show the grading page)
                navigateTo('dashboard'); 

            } catch (error) {
                console.error("Error ending meeting:", error);
            } finally {
                setLoading(false);
            }
        }

        // ### NEW: Function to save all participation grades for a meeting ###
        async function handleSaveParticipationGrades(meetingId) {
            if (!db || !meetingId) {
                console.error("Firestore not initialized or no meeting ID.");
                return;
            }
            
            // setLoading(true); // <-- BUG was here. Moved to after input read.
            const feedbackDiv = document.getElementById('grading-feedback');
            feedbackDiv.innerText = '';
            feedbackDiv.classList.remove('text-red-500', 'text-green-500');
            
            const gradesToSave = {};
            const gradeInputs = document.querySelectorAll('input[data-userid]');
            
            let hasError = false;
            gradeInputs.forEach(input => {
                const userId = input.dataset.userid;
                const value = input.value.trim();
                
                if (value === '') {
                    // If blank, we don't save a grade (or save null)
                    gradesToSave[userId] = null;
                    input.classList.remove('border-red-500');
                } else {
                    const grade = parseFloat(value);
                    if (isNaN(grade) || grade < 0 || grade > 100) {
                        input.classList.add('border-red-500');
                        hasError = true;
                    } else {
                        gradesToSave[userId] = grade;
                        input.classList.remove('border-red-500');
                    }
                }
            });
            
            if (hasError) {
                feedbackDiv.innerText = 'Error: Please correct invalid grades (must be between 0 and 100).';
                feedbackDiv.classList.add('text-red-500');
                // setLoading(false); // Not needed, was never set to true
                return;
            }
            
            // *** MOVED setLoading(true) HERE ***
            setLoading(true);
            
            try {
                const meetingDocRef = doc(db, MEETINGS_COLLECTION_PATH, meetingId);
                
                // Fetch the latest meeting data to merge with, not overwrite, grades
                const meetingDoc = await getDoc(meetingDocRef);
                const existingGrades = meetingDoc.exists() ? meetingDoc.data().participationGrades || {} : {};
                
                // Merge new grades into existing grades
                // --- SYNTAX FIX: Replaced spread operator ---
                const finalGrades = Object.assign({}, existingGrades, gradesToSave);
                
                // Clean up null entries
                Object.keys(finalGrades).forEach(key => {
                    if (finalGrades[key] === null) {
                        delete finalGrades[key];
                    }
                });

                await updateDoc(meetingDocRef, {
                    participationGrades: finalGrades
                });
                
                console.log("Participation grades saved:", finalGrades);
                feedbackDiv.innerText = 'Grades saved successfully!';
                feedbackDiv.classList.add('text-green-500');
                
            } catch (error) {
                console.error("Error saving participation grades:", error);
                feedbackDiv.innerText = 'Error saving grades: ' + error.message;
                feedbackDiv.classList.add('text-red-500');
            } finally {
                setLoading(false);
                setTimeout(() => {
                   if (feedbackDiv) {
                       feedbackDiv.innerText = '';
                       feedbackDiv.classList.remove('text-green-500', 'text-red-500');
                   }
                }, 3000);
            }
        }

        function handleLeaveMeeting() {
            setLoading(false); // ### FIX: Ensure loading is off when leaving ###
            console.log("Leaving meeting.");
            if (state.jitsiApi) {
                try {
                    state.jitsiApi.dispose();
                } catch (e) {
                    console.error("Error disposing Jitsi API:", e);
                }
            }
            state.jitsiApi = null;
            state.selectedRoomId = null;
            state.selectedRoomTopic = null;
            state.view = 'dashboard';
            
            renderApp();
        }

        async function handleDeleteMeeting(meetingId) {
            if (!db || !state.currentUser || (state.currentUser.role !== 'teacher' && state.currentUser.role !== 'admin')) return;
            
            console.log("Deleting meeting:", meetingId);
            // Bypassing confirm dialog as per rules
            
            setLoading(true);
            try {
                const meetingDocRef = doc(db, MEETINGS_COLLECTION_PATH, meetingId);
                await deleteDoc(meetingDocRef);
                console.log("Meeting deleted successfully.");
                
                // If the teacher was in the grading page for this meeting, kick them back
                if (state.dashboardTab === 'gradeMeeting' && state.selectedMeetingForGradingId === meetingId) {
                    state.dashboardTab = 'onlineClass';
                    state.selectedMeetingForGradingId = null;
                    // renderApp() will be called by setLoading(false)
                }

            } catch (error) {
                console.error("Error deleting meeting:", error);
            } finally {
                setLoading(false);
            }
        }

        function initJitsiMeet() {
            const container = document.getElementById('jitsi-container');
            if (!container || !state.selectedRoomId || state.jitsiApi) {
                if (state.jitsiApi) console.warn("Jitsi API already initialized.");
                if (!container) console.error("Jitsi container not found.");
                if (!state.selectedRoomId) console.error("No selected room ID.");
                return;
            }

            // ### FIX 2: Check if Jitsi API script is loaded ###
            if (typeof JitsiMeetExternalAPI === 'undefined') {
                console.error("Jitsi API script is not loaded yet. Retrying in 500ms...");
                setTimeout(initJitsiMeet, 500); // Retry after a delay
                return;
            }

            try {
                // --- MODIFIED: Use JaaS/8x8 domain and room structure ---
                const domain = '8x8.vc';
                // Use the magic cookie and append the unique room ID
                const roomName = 'vpaas-magic-cookie-2b16411358d643fa86ede3bbe82bc0df/' + state.selectedRoomId;
                // --- END MODIFICATION ---

                const options = {
                    roomName: roomName, // Use the new JaaS room name
                    width: '100%',
                    height: '100%',
                    parentNode: container,
                    
                    // *** 1. FIX FOR USER DATA ***
                    // This 'userInfo' object passes the logged-in user's name
                    // and profile picture directly into the Jitsi meeting.
                    userInfo: {
                        // ### MODIFIED: Make display name unique ###
                        displayName: `${state.currentUser.name} (${state.currentUser.username})`,
                        avatarUrl: state.currentUser.profilePicUrl // Pass the user's picture
                    },
                    // ### FIX: Add configOverwrite for screensharing ###
                    configOverwrite: {
                        enableScreensharing: true,
                        prejoinPageEnabled: false, // Skip prejoin page
                    },
                    interfaceConfigOverwrite: {
                        SHOW_JITSI_WATERMARK: false,
                        SHOW_WATERMARK_FOR_GUESTS: false,
                    }
                };
                
                // Create the Jitsi API object
                // The API script is loaded from 8x8.vc in the <head>
                const api = new JitsiMeetExternalAPI(domain, options);
                state.jitsiApi = api;
                
                // --- CRITICAL: Add the `allow` attribute after the iframe is created ---
                // *** 2. FIX FOR PERMISSIONS ***
                // This event listener waits for the iframe to be ready, then adds
                // the 'allow' attribute. This is what enables the iframe
                // to *request* camera and microphone permissions from the user.
                api.addEventListener('iframeReady', () => {
                    console.log("Jitsi iframe is ready. Setting permissions...");
                    const iframe = api.getIFrame();
                    if (iframe) {
                        // This attribute is necessary for browsers to allow permission requests
                        iframe.setAttribute('allow', 'camera; microphone; fullscreen; display-capture');
                        console.log("Permissions set on Jitsi iframe.");
                    } else {
                        console.error("Could not get Jitsi iframe to set permissions.");
                    }
                });

                // Add other event listeners if needed
                // api.addEventListener('videoConferenceLeft', () => {
                //     handleLeaveMeeting();
                // });

            } catch (error) {
                console.error("Error initializing Jitsi Meet:", error);
                // Show an error in the container
                container.innerHTML = `<div class="p-8 text-center text-red-500">Error loading virtual classroom. Please try again.</div>`;
            }
        }

        // --- END VIRTUAL CLASSROOM FUNCTIONS ---


        // --- ### REMOVED: VIRTUAL CLASSROOM GRADING FUNCTION ### ---
        // async function handleSaveParticipationGrade(...) { ... }
        // --- END VIRTUAL CLASSROOM GRADING FUNCTION ---


        // --- NEW FEATURE: LESSON BOOK FUNCTIONS ---

        // Task 1: Update Grade Level Options
        function getGradeLevelOptions(selectedGrade) {
            // --- EDIT: Add null/empty option for admin user creation ---
            const grades = ["", "All", "Kinder A", "Kinder B", "1", "2", "3", "3 BS", "3 OLHRS", "4", "5", "6", "5 OLHRS"];
            return grades.map(function(g) {
                var gradeLabel;
                if (g === "") gradeLabel = "N/A (e.g., Teacher/Admin)";
                else if (g === 'All') gradeLabel = 'All Grades';
                else gradeLabel = g.startsWith('Kinder') ? g : "Grade " + g;
                
                return '<option value="' + g + '" ' + (String(selectedGrade) === String(g) ? 'selected' : '') + '>' + gradeLabel + '</option>'
            }).join('');
        }
        
        // --- NEW: Quarter Options ---
        function getQuarterOptions(selectedQuarter) {
            return QUARTERS.map(function(q) {
                // --- MODIFICATION: Use display map ---
                const displayText = QUARTER_DISPLAY_MAP[q] || q;
                return '<option value="' + q + '" ' + (selectedQuarter === q ? 'selected' : '') + '>' + displayText + '</option>'
                // --- END MODIFICATION ---
            }).join('');
        }
        
        // Task 2: Helper function to get subject options based on grade
        function getSubjectOptions(grade, selectedSubject) {
            // --- MODIFIED: Read from state.masterSubjectList if available ---
            const masterList = (state.masterSubjectList && state.masterSubjectList.length > 0) ? state.masterSubjectList : INITIAL_MASTER_SUBJECT_LIST;
            
            // --- NEW LOGIC: Always return the full master list for content creation ---
            // This allows teachers to select any subject (e.g., "Research") for any grade level
            // (e.g., "Grade 1"), even if it's not a default subject for that grade.
            // The student-side logic (getSubjectsForStudent) will correctly filter this content.
            const subjects = masterList;
            // --- END NEW LOGIC ---

            // --- OLD LOGIC (Removed) ---
            // const subjects = (grade === 'All') ? masterList : (subjectMap[grade] || []);
            // --- END OLD LOGIC ---
            
            return subjects.map(function(s) { return '<option value="' + s + '" ' + (selectedSubject === s ? 'selected' : '') + '>' + s + '</option>' }).join('');
        }
        
        // Task 2: Helper function to update subject dropdowns dynamically
        function updateSubjectDropdown(gradeSelectId, subjectSelectId) {
            const gradeSelect = document.getElementById(gradeSelectId);
            const subjectSelect = document.getElementById(subjectSelectId);
            if (gradeSelect && subjectSelect) {
                const selectedGrade = gradeSelect.value;
                subjectSelect.innerHTML = getSubjectOptions(selectedGrade, null); // Reset selection
            }
        }
         function renderTeacherGradeBook() {
            // 1. Get all student data with calculated averages
            const allStudentData = getTeacherGradeBookData('All'); // This function already sorts by name

            // 2. Group by grade
            const studentsByGrade = allStudentData.reduce(function(acc, student) {
                const grade = student.grade || 'Ungraded';
                if (!acc[grade]) {
                    acc[grade] = [];
                }
                acc[grade].push(student);
                return acc;
            }, {});

            // 3. Sort grades
            const sortedGrades = Object.keys(studentsByGrade).sort(function(a, b) {
                 const indexA = gradeSortOrder.indexOf(String(a));
                 const indexB = gradeSortOrder.indexOf(String(b));
                 if (indexA === -1) return 1; // Put 'Ungraded' at the end
                 if (indexB === -1) return -1;
                 return indexA - indexB;
            });

            // 4. Check for empty state
            if (allStudentData.length === 0) {
                 return '<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">No student grade data has been recorded yet.</div>'
            }

            // 5. Build HTML
            return sortedGrades.map(function(grade) {
                const studentsInGrade = studentsByGrade[grade];
                const subjectsForThisGrade = subjectMap[String(grade)] || MASTER_SUBJECT_LIST;

                return `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold text-emerald-700 mb-4">${grade.startsWith('Kinder') ? grade : "Grade " + grade} Students - Grade Book</h2>
                        <div class="overflow-x-auto bg-white rounded-xl shadow-lg card">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-emerald-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        ${subjectsForThisGrade.map(function(sub) { return '<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">' + sub + '</th>' }).join('')}
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Average</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${studentsInGrade.map(function(student) {
                                        const totalAvg = student.averages.totalAverage;
                                        const totalAvgColor = (totalAvg === null || totalAvg === undefined) ? 'text-gray-400' : totalAvg >= 80 ? 'text-green-600 font-extrabold' : totalAvg >= 50 ? 'text-orange-500 font-bold' : 'text-red-600 font-bold';
                                        const totalDisplayVal = (totalAvg !== null && totalAvg !== undefined) ? (totalAvg.toFixed(1) + '%') : '-';
                                        
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    ${student.name}
                                                    <div class="text-xs text-gray-400 truncate" title="${student.userId || ''}">${student.userId || 'N/A'}</div>
                                                </td>
                                                ${subjectsForThisGrade.map(function(sub) {
                                                    const avg = student.averages.subjectAverages[sub]; // Directly access the average for the subject
                                                    const avgColor = (avg === null || avg === undefined) ? 'text-gray-400' : avg >= 80 ? 'text-green-600 font-extrabold' : avg >= 50 ? 'text-orange-500 font-bold' : 'text-red-600 font-bold';
                                                    const displayVal = (avg !== null && avg !== undefined) ? (avg.toFixed(1) + '%') : '-';
                                                    return '<td class="px-6 py-4 whitespace-nowrap text-sm text-center ' + avgColor + '">' + displayVal + '</td>';
                                                }).join('')}
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${totalAvgColor}">
                                                    ${totalDisplayVal}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }
                       // Priority 1.3: Gut and replace getTeacherGradeBookData
        function getTeacherGradeBookData(gradeLevel) {
            
            // 1. Get Students for this grade (from INITIAL_SEED_USERS list)
            // Task 1: Handle legacy grades in INITIAL_SEED_USERS list for filtering
            // --- EDIT: Use state.allUserProfiles if available (for new/edited users), fallback to INITIAL_SEED_USERS ---
            const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;

            const students = userSource.filter(function(u) {
                let userGrade = u.grade;
                if (userGrade === '3.1' || userGrade === '3.2') userGrade = 3;
                if (userGrade === '5.1') userGrade = 5;
                return u.role === 'student' && (gradeLevel === 'All' || String(userGrade) === String(gradeLevel));
            }).sort(function(a,b) { return a.name.localeCompare(b.name) });
            
            if (students.length === 0) {
                return []; // Return empty array as requested
            }
            
            // 2. Loop, find UID, and call master function
            const studentData = [];
            students.forEach(function(student) {
                // Find this student's UID from the quiz results (the only place it's linked)
                let studentGrade = student.grade;
                if (studentGrade === '3.1' || studentGrade === '3.2') studentGrade = 3;
                if (studentGrade === '5.1') studentGrade = 5;
                
                // --- EDIT: Find user by username, which is the stable ID ---
                const studentResultData = state.studentResults.find(function(r) { return r.userId === student.username });
                
                // Use UID from results
                const uid = student.username; // The username is the stable ID

                // Call the master function
                // This function reads from global state, simulating the requested server logic
                const averages = _getCalculatedAveragesForStudent(uid, student.grade); // Use original grade for calculation lookup
                
                // 3. Build the final array
                studentData.push({
                    name: student.name,
                    grade: student.grade, // Use original grade for display
                    profilePicUrl: student.profilePicUrl, // Task 2.1: Add profile pic
                    userId: uid, // Add the user ID for the table display
                    averages: averages // This is the object { subjectAverages: {...}, totalAverage: ... }
                });
            });
            
            return studentData; // Return the array as requested
        }
        
        // NEW: Helper function to get student options for modals
        function getStudentOptions(selectedStudentId) {
             // --- EDIT: Use state.allUserProfiles if available, fallback to seed ---
             const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;
             const students = userSource.filter(function(u) { return u.role === 'student' }).sort(function(a,b) { return a.name.localeCompare(b.name) });
             
             return students.map(function(s) {
                // For multi-select, we need to check if the studentId is in an array
                const isSelected = Array.isArray(selectedStudentId) ? selectedStudentId.includes(s.username) : selectedStudentId === s.username;
                 return '<option value="' + s.username + '" ' + (isSelected ? 'selected' : '') + '>' + s.name + ' (Grade ' + s.grade + ')</option>'
             }).join('');
        }

        // Task 2.3: New parser for Lesson Book text (Parser v2.0)
        function parseLessonText(text) {
            const slides = [];
            const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            let currentSlide = null;

            lines.forEach(function(line) {
                const trimmedLine = line.trim();
                
                // Check for tags
                const slideMatch = trimmedLine.match(/^\[SLIDE\]$/i);
                const questionMatch = trimmedLine.match(/^\[QUESTION\]$/i);
                const fileMatch = trimmedLine.match(/^\[FILE:\s*(.+)\]$/i);
                const videoMatch = trimmedLine.match(/^\[VIDEO:\s*(.+)\]$/i);
                const imageMatch = trimmedLine.match(/^\[IMAGE:\s*(.+)\]$/i);

                if (slideMatch) {
                    // Save previous slide if it exists
                    if (currentSlide) slides.push(currentSlide);
                    // Start new SLIDE
                    currentSlide = { type: 'SLIDE', text: '' };
                } else if (questionMatch) {
                    // Save previous slide
                    if (currentSlide) slides.push(currentSlide);
                    // Start new QUESTION
                    currentSlide = { type: 'QUESTION', question: '', options: {}, answer: '', textLines: [] };
                } else if (fileMatch) {
                    if (currentSlide) slides.push(currentSlide);
                    currentSlide = null; // Reset
                    slides.push({ type: 'FILE', url: fileMatch[1].trim(), text: '', question: '', options: {}, answer: '' });
                } else if (videoMatch) {
                    if (currentSlide) slides.push(currentSlide);
                    currentSlide = null; // Reset
                    slides.push({ type: 'VIDEO', url: videoMatch[1].trim(), text: '', question: '', options: {}, answer: '' });
                } else if (imageMatch) {
                    if (currentSlide) slides.push(currentSlide);
                    currentSlide = null; // Reset
                    slides.push({ type: 'IMAGE', url: imageMatch[1].trim(), text: '', question: '', options: {}, answer: '' });
                } else if (currentSlide) {
                    // This line is content for the current slide
                    if (currentSlide.type === 'SLIDE') {
                        currentSlide.text += line + '\n';
                    } else if (currentSlide.type === 'QUESTION') {
                        // Add line to be parsed later
                        currentSlide.textLines.push(line);
                    }
                } else if (trimmedLine.length > 0) {
                     // Content before any tag is treated as the first slide
                     if (slides.length === 0) {
                         currentSlide = { type: 'SLIDE', text: '' };
                         slides.push(currentSlide);
                     }
                     // Append to last slide if it was a slide
                     const lastSlide = slides[slides.length - 1];
                     if(lastSlide && lastSlide.type === 'SLIDE') {
                         lastSlide.text += line + '\n';
                     }
                }
            });

            // Push the last slide
            if (currentSlide) {
                slides.push(currentSlide);
            }

            // Post-process slides to clean up and parse questions
            return slides.map(function(slide) {
                if (slide.type === 'SLIDE') {
                    slide.text = slide.text.trim();
                } else if (slide.type === 'QUESTION') {
                    if (slide.textLines && slide.textLines.length > 0) {
                        slide.question = slide.textLines[0].trim();
                        slide.textLines.slice(1).forEach(function(line) {
                            const optMatch = line.match(/^([a-zA-Z])[\.\)]\s+(.*)/);
                            const answerMatch = line.match(/^Answer:\s*(.*)/i);

                            if (optMatch) {
                                slide.options[optMatch[1].toUpperCase()] = optMatch[2].trim();
                            } else if (answerMatch) {
                                slide.answer = answerMatch[1].trim().toUpperCase().substring(0, 1);
                            } else {
                                // Line is part of the question
                                slide.question += '\n' + line;
                            }
                        });
                    }
                    delete slide.textLines; // Clean up
                }
                return slide;
            }).filter(function(slide) {
                 // Filter out empty slides that might have been created
                 if (slide.type === 'SLIDE' && !slide.text) return false;
                 if (slide.type === 'QUESTION' && !slide.question) return false;
                 return true;
            });
        }

        // Task 2.3: New helper to convert slides back to text for editing
        function lessonSlidesToText(slides) {
            if (!slides) return '';
            return slides.map(function(slide) {
                switch (slide.type) {
                    case 'SLIDE':
                        return '[SLIDE]\n' + (slide.text || '');
                    case 'QUESTION':
                        const options = slide.options || {};
                        const optionsText = Object.entries(options)
                            .map(function([key, value]) { return (key.toLowerCase() + ') ' + value) })
                            .join('\n');
                        return '[QUESTION]\n' + (slide.question || '') + '\n' + optionsText + '\nAnswer: ' + slide.answer.toLowerCase();
                    case 'FILE':
                        return '[FILE: ' + (slide.url || '') + ']';
                    case 'VIDEO':
                        return '[VIDEO: ' + (slide.url || '') + ']';
                    case 'IMAGE':
                        return '[IMAGE: ' + (slide.url || '') + ']';
                    default:
                        return '';
                }
            }).join('\n\n'); // Separate blocks with two newlines
        }

        // NEW: Helper to convert quiz questions back to text for editing
        function quizQuestionsToText(questions) {
            if (!questions) return '';
            return questions.map(function(q, index) {
                let text = (index + 1) + '. '; // Start with number
                if (q.introduction) { // <-- NEW
                    text += 'Introduction: ' + q.introduction + '\n'; // <-- NEW
                } // <-- NEW
                text += q.question + '\n'; // Add question text

                if (q.questionImage) { // <-- NEW
                    text += 'Image: ' + q.questionImage + '\n'; // <-- NEW
                } // <-- NEW

                if (q.type === 'FillIn') {
                    text += 'Type: FillIn\n';
                    text += 'Answer: ' + q.answer + '\n';
                } else { // MC or TF
                    const options = q.options || {};
                    text += Object.entries(options)
                        .map(function([key, value]) { return (key.toLowerCase() + ') ' + value) })
                        .join('\n');
                    text += '\nAnswer: ' + q.answer.toLowerCase() + '\n';
                }
                if (q.discussion) {
                    text += 'Discussion: ' + q.discussion + '\n';
                }
                return text;
            }).join('\n'); // Separate questions with one newline
        }

        function openLessonBookModal(lessonBookId = null) {
            if (lessonBookId) {
                state.isEditingLesson = true;
                state.editingLessonBook = JSON.parse(JSON.stringify(state.lessonBooks.find(function(lb) { return lb.id === lessonBookId }))) || null; // Deep copy
                 if (!state.editingLessonBook) { // Handle case where lesson book might have been deleted
                     console.error("Lesson book not found for editing:", lessonBookId);
                     state.isEditingLesson = false;
                     // Task 2.3: Updated default object
                     state.editingLessonBook = { title: '', gradeLevel: 'All', subject: 'Science', quarter: 'Q1', attachmentUrl: '', status: 'active', slides: [{ type: 'SLIDE', text: '[SLIDE]\n# New Lesson\n* Start typing here' }] };
                 }
            } else {
                state.isEditingLesson = false;
                 // Task 2.3: Updated default object
                state.editingLessonBook = { title: '', gradeLevel: 'All', subject: 'Science', quarter: 'Q1', attachmentUrl: '', status: 'active', slides: [{ type: 'SLIDE', text: '[SLIDE]\n# New Lesson\n* Start typing here' }] }; // Default first slide
            }
            state.isLessonModalOpen = true;
            renderApp();
        }

        function closeLessonBookModal() {
            state.isLessonModalOpen = false;
            state.isEditingLesson = false;
            state.editingLessonBook = null;
            renderApp();
        }

        function renderModalSlides() {
            // Task 2: This function is now OBSOLETE due to the textarea.
            // We leave it here, but it's no longer called by renderLessonBookModal.
            const container = document.getElementById('slidesContainer');
            if (container) {
                container.innerHTML = '<!-- Slide editor removed. Use text area. -->';
            }
        }

        function addSlideToModal() {
            // Task 2: This function is now OBSOLETE.
            console.warn("addSlideToModal is obsolete.");
        }

        function removeSlideFromModal(index) {
             // Task 2: This function is now OBSOLETE.
             console.warn("removeSlideFromModal is obsolete.");
        }

        async function handleSaveLessonBook(event) {
            event.preventDefault();
            if (!db) { console.error("Firestore not initialized"); return; }
            setLoading(true);

            const form = event.target;
            const lessonBookId = form.lessonBookId.value;
            const rawLessonText = form.lessonRawText.value; // Task 2: Get text from new textarea
            
            // Simple validation feedback
            const errorDiv = document.getElementById('lesson-editor-error');
            if(errorDiv) errorDiv.innerText = '';

            try {
                // Task 2.3: Parse the raw text using new parser
                const slidesData = parseLessonText(rawLessonText);

                if (slidesData.length === 0) {
                    console.error("Parsing failed. No valid tags found.");
                    if(errorDiv) errorDiv.innerText = 'Parsing failed. Please add at least one [SLIDE], [QUESTION], [FILE: ...], or [VIDEO: ...] tag.';
                    setLoading(false);
                    return; 
                }

                // Task 2: Removed old slide container loop

                const lessonBookData = {
                    title: form.lessonTitle.value,
                    gradeLevel: form.lessonGradeLevel.value,
                    subject: form.lessonSubject.value, // Task 5
                    quarter: form.lessonQuarter.value, // NEW: Save quarter
                    attachmentUrl: form.lessonAttachmentUrl.value, // Task 2
                    slides: slidesData, // Use the new parsed data
                    teacherName: state.currentUser.name,
                    teacherId: state.currentUser.username, // ### MODIFIED: Add teacherId
                    status: state.editingLessonBook?.status || 'active', // Preserve status on edit
                };

                if (state.isEditingLesson && lessonBookId) {
                    // Update existing lesson book
                    const lessonDocRef = doc(db, LESSON_BOOKS_COLLECTION_PATH, lessonBookId);
                    await updateDoc(lessonDocRef, lessonBookData); // Overwrites entire doc
                     console.log("Lesson book updated:", lessonBookId);
                } else {
                    // Create new lesson book
                     lessonBookData.timestamp = serverTimestamp(); // Add timestamp on create
                     lessonBookData.status = 'active'; // NEW: Ensure status is active on create
                     const docRef = await addDoc(collection(db, LESSON_BOOKS_COLLECTION_PATH), lessonBookData);
                     console.log("Lesson book created:", docRef.id);
                }
                closeLessonBookModal();
            } catch (error) {
                console.error("Error saving lesson book:", error);
                if(errorDiv) errorDiv.innerText = 'Error: ' + error.message;
            } finally {
                setLoading(false);
            }
        }


        async function handleDeleteLessonBook(lessonBookId) {
             if (!db) { console.error("Firestore not initialized"); return; }
             console.log("Deleting lesson book:", lessonBookId);
             // Bypassing confirm dialog
             setLoading(true);
             try {
                await deleteDoc(doc(db, LESSON_BOOKS_COLLECTION_PATH, lessonBookId));
                // Optionally delete related student submissions
             } catch (error) {
                 console.error("Error deleting lesson book:", error);
             } finally {
                setLoading(false);
             }
        }

        // NEW: Toggle Lesson Status
        async function handleToggleLessonStatus(lessonId, newStatus) {
            if (!db) return;
            console.log("Setting lesson " + lessonId + " status to: " + newStatus);
            setLoading(true);
            try {
                const docRef = doc(db, LESSON_BOOKS_COLLECTION_PATH, lessonId);
                await updateDoc(docRef, { status: newStatus });
            } catch (error) {
                console.error("Error updating lesson status:", error);
            } finally {
                setLoading(false);
            }
        }

        function nextLessonSlide() {
            if (state.selectedLessonBook && state.currentLessonSlideIndex < state.selectedLessonBook.slides.length - 1) {
                state.currentLessonSlideIndex++;
                state.selectedAnswer = null; // Clear answer when moving
                renderApp();
            }
        }

        function previousLessonSlide() {
            if (state.currentLessonSlideIndex > 0) {
                state.currentLessonSlideIndex--;
                state.selectedAnswer = null; // Clear answer when moving
                renderApp();
            }
        }
        
        // --- NEW: Lesson Retake ---
        async function handleRetakeLesson(lessonBookId) {
            if (!db) { console.error("Firestore not initialized"); return; }
            setLoading(true);
            try {
                const submission = state.lessonBookProgress[lessonBookId];
                if (submission && submission.id) {
                    const docRef = doc(db, LESSON_SUBMISSIONS_COLLECTION_PATH, submission.id);
                    // Clear answers and reset completed status.
                    // Keep bestScore to compare against the new attempt.
                    await updateDoc(docRef, {
                        answers: [],
                        completed: false,
                        score: 0
                    });
                    console.log("Lesson progress reset for retake:", lessonBookId);
                }
                // Navigate to the lesson to start the retake
                navigateTo('viewLesson', lessonBookId);
            } catch (error) {
                 console.error("Error resetting lesson for retake:", error);
            } finally {
                setLoading(false); // navigateTo will render, so this is okay
            }
        }


        async function submitLessonAnswer(lessonBookId, slideIndex, answer) {
            if (!db || !auth.currentUser || !state.selectedLessonBook) return;
            // Set selectedAnswer in state immediately for UI feedback
            state.selectedAnswer = answer;
            renderApp(); // Re-render to show the "selected" but not-yet-confirmed state (e.g., blue border)

            setLoading(true); // Set loading before async operations

            try {
                const lesson = state.selectedLessonBook;
                const slide = lesson.slides[slideIndex];
                if (!slide) return; // Exit if slide data is missing

                const isCorrect = answer === slide.answer;
                const studentUid = state.currentUser.username; // Use username as stableId

                // Find existing submission doc ID from state or query
                let submissionDocId = state.lessonBookProgress[lessonBookId]?.id;
                let currentProgress = state.lessonBookProgress[lessonBookId];

                // If progress doesn't exist locally, try fetching (might happen on first answer)
                if (!currentProgress) {
                     const q = query(collection(db, LESSON_SUBMISSIONS_COLLECTION_PATH), where("userId", "==", studentUid), where("lessonBookId", "==", lessonBookId));
                     const querySnapshot = await getDocs(q);
                     if (!querySnapshot.empty) {
                         const docSnap = querySnapshot.docs[0];
                         submissionDocId = docSnap.id;
                         // --- SYNTAX FIX: Replaced spread operator ---
                         currentProgress = Object.assign({ id: docSnap.id }, docSnap.data());
                     }
                }

                const progressUpdate = currentProgress || {
                    userId: studentUid,
                    studentName: state.currentUser.name,
                    lessonBookId: lessonBookId,
                    lessonTitle: lesson.title, // Store for grade book
                    subject: lesson.subject, // Store for grade book
                    answers: [],
                    completed: false,
                    bestScore: 0, // Task 3: Initialize bestScore
                    totalQuestions: lesson.slides.filter(function(s) { return s.type === 'QUESTION' && s.question && s.question.trim() !== '' }).length // Task 2.3: Update total questions logic
                };
                
                // --- NEW: Ensure bestScore is carried over ---
                progressUpdate.bestScore = currentProgress?.bestScore || 0;

                // Ensure answers array exists
                progressUpdate.answers = progressUpdate.answers || [];

                const existingAnswerIndex = progressUpdate.answers.findIndex(function(a) { return a.slideIndex === slideIndex });
                const answerData = { slideIndex: slideIndex, answer: answer, isCorrect: isCorrect };

                if (existingAnswerIndex > -1) {
                    progressUpdate.answers[existingAnswerIndex] = answerData; // Update
                } else {
                    progressUpdate.answers.push(answerData); // Add new
                }

                // Save to Firestore
                if (submissionDocId) { // Update existing doc
                    const docRef = doc(db, LESSON_SUBMISSIONS_COLLECTION_PATH, submissionDocId);
                    await updateDoc(docRef, {
                        answers: progressUpdate.answers,
                        studentName: state.currentUser.name // Update name just in case
                        // Don't update completed status or score here
                    });
                } else { // Create new doc
                    const docRef = await addDoc(collection(db, LESSON_SUBMISSIONS_COLLECTION_PATH), progressUpdate);
                    progressUpdate.id = docRef.id; // Store new ID
                }
                // Update local state (listener might take time)
                state.lessonBookProgress[lessonBookId] = progressUpdate;
                console.log("Lesson answer submitted for slide:", slideIndex);
                renderApp(); // Re-render to show feedback (correct/incorrect)
            } catch (error) {
                console.error("Error submitting lesson answer:", error);
            } finally {
                 setLoading(false);
            }
        }

        // Task 3: Calculate and Save Lesson Score
        async function calculateAndSaveLessonScore(lessonBookId) {
            if (!db || !state.currentUser) return; // Check for currentUser, not auth.currentUser
            const submission = state.lessonBookProgress[lessonBookId];
            if (!submission || !submission.answers || !submission.id) {
                 console.error("Submission data incomplete for saving score.");
                 return;
            }

            const lesson = state.lessonBooks.find(function(lb) { return lb.id === lessonBookId });
            if (!lesson || !lesson.slides) {
                 console.error("Lesson data not found for saving score.");
                 return;
            }

            setLoading(true);
            try {
                const questions = lesson.slides.filter(function(s) { return s.type === 'QUESTION' && s.question && s.question.trim() !== '' }); // Task 2.3
                const totalQuestions = questions.length;

                let score = 0;
                submission.answers.forEach(function(ans) {
                    // Ensure the slide index exists and has a question before checking correctness
                    const slide = lesson.slides[ans.slideIndex];
                    if (slide && slide.type === 'QUESTION' && slide.question && slide.question.trim() !== '' && ans.isCorrect) { // Task 2.3
                        score++;
                    }
                });

                const submissionDocRef = doc(db, LESSON_SUBMISSIONS_COLLECTION_PATH, submission.id);

                // Note: The original code used Subject.max which is not a standard JS Math function.
                // Assuming it was intended to be Math.max
                const currentBestScore = submission.bestScore || 0;
                const newBestScore = Math.max(score, currentBestScore); // Fixed Math function

                await updateDoc(submissionDocRef, {
                    score: score, // Save the score for this completion attempt
                    totalQuestions: totalQuestions,
                    bestScore: newBestScore, // Update best score if current is higher
                    completed: true // Mark as completed
                });

                // Update local state immediately
                state.lessonBookProgress[lessonBookId].completed = true;
                state.lessonBookProgress[lessonBookId].score = score;
                state.lessonBookProgress[lessonBookId].totalQuestions = totalQuestions;
                state.lessonBookProgress[lessonBookId].bestScore = newBestScore;

            } catch (error) {
                console.error("Error saving lesson score:", error);
            } finally {
                setLoading(false);
                navigateTo('dashboard'); // Go back to dashboard after saving.
            }
        }


        // --- NEW FEATURE: ASSIGNMENT FUNCTIONS ---

        function openAssignmentModal(assignmentId = null) {
            if (assignmentId) {
                state.isEditingAssignment = true;
                 // Deep copy to prevent modifying state directly during edit
                state.editingAssignment = JSON.parse(JSON.stringify(state.assignments.find(function(a) { return a.id === assignmentId }))) || null;
                 if (!state.editingAssignment) {
                     console.error("Assignment not found for editing:", assignmentId);
                     state.isEditingAssignment = false;
                     // Task 2 & 5: Updated default object
                     state.editingAssignment = { title: '', gradeLevel: 'All', subject: 'Science', quarter: 'Q1', instructions: '', dueDate: null, attachmentUrl: '', status: 'active' };
                 }
            } else {
                state.isEditingAssignment = false;
                 // Task 2 & 5: Updated default object
                state.editingAssignment = { title: '', gradeLevel: 'All', subject: 'Science', quarter: 'Q1', instructions: '', dueDate: null, attachmentUrl: '', status: 'active' };
            }
            state.isAssignmentModalOpen = true;
            renderApp();
        }

        function closeAssignmentModal() {
            state.isAssignmentModalOpen = false;
            state.isEditingAssignment = false;
            state.editingAssignment = null;
            renderApp();
        }

        async function handleSaveAssignment(event) {
            event.preventDefault();
            if (!db) { console.error("Firestore not initialized"); return; }
            setLoading(true);

            const form = event.target;
            const assignmentId = form.assignmentId.value;

            try {
                 let dueDateValue = null;
                 if (form.assignmentDueDate.value) {
                     // Ensure the date is interpreted correctly regardless of local timezone issues
                     // --- SYNTAX FIX: Replaced destructuring ---
                     const dateParts = form.assignmentDueDate.value.split('-').map(Number);
                     const year = dateParts[0];
                     const month = dateParts[1];
                     const day = dateParts[2];
                     dueDateValue = new Date(Date.UTC(year, month - 1, day, 0, 0, 0)); // Set to UTC midnight
                 }

                const assignmentData = {
                    title: form.assignmentTitle.value,
                    gradeLevel: form.assignmentGradeLevel.value,
                    subject: form.assignmentSubject.value, // Task 5
                    quarter: form.assignmentQuarter.value, // NEW: Save quarter
                    instructions: form.assignmentInstructions.value,
                    attachmentUrl: form.assignmentAttachmentUrl.value, // Task 2
                    dueDate: dueDateValue, // Use the processed date object
                    teacherName: state.currentUser.name,
                    teacherId: state.currentUser.username, // ### MODIFIED: Add teacherId
                    status: state.editingAssignment?.status || 'active', // Preserve status on edit
                };

                if (state.isEditingAssignment && assignmentId) {
                    const assignmentDocRef = doc(db, ASSIGNMENTS_COLLECTION_PATH, assignmentId);
                    await updateDoc(assignmentDocRef, assignmentData); // Overwrites
                    console.log("Assignment updated:", assignmentId);
                } else {
                    assignmentData.timestamp = serverTimestamp(); // Add timestamp on create
                    assignmentData.status = 'active'; // NEW: Ensure status is active on create
                    const docRef = await addDoc(collection(db, ASSIGNMENTS_COLLECTION_PATH), assignmentData);
                    console.log("Assignment created:", docRef.id);
                }
                closeAssignmentModal();
            } catch (error) {
                console.error("Error saving assignment:", error);
            } finally {
                setLoading(false);
            }
        }


        async function handleDeleteAssignment(assignmentId) {
             if (!db) { console.error("Firestore not initialized"); return; }
             console.log("Deleting assignment:", assignmentId);
             // Bypassing confirm dialog
             setLoading(true);
             try {
                await deleteDoc(doc(db, ASSIGNMENTS_COLLECTION_PATH, assignmentId));
                // Optionally delete related student submissions
             } catch (error) {
                 console.error("Error deleting assignment:", error);
             } finally {
                setLoading(false);
             }
        }

        // NEW: Toggle Assignment Status
        async function handleToggleAssignmentStatus(assignmentId, newStatus) {
            if (!db) return;
            console.log("Setting assignment " + assignmentId + " status to: " + newStatus);
            setLoading(true);
            try {
                const docRef = doc(db, ASSIGNMENTS_COLLECTION_PATH, assignmentId);
                await updateDoc(docRef, { status: newStatus });
            } catch (error) {
                console.error("Error updating assignment status:", error);
            } finally {
                setLoading(false);
            }
        }

        // --- FIX: ADD MISSING FUNCTION DEFINITIONS ---
        function viewAssignment(assignmentId) {
             navigateTo('viewAssignment', assignmentId);
        }

        function viewSubmissions(assignmentId) {
             // This will navigate to the teacher dashboard and select the 'viewSubmissions' tab
             state.dashboardTab = 'viewSubmissions';
             navigateTo('dashboard', assignmentId); // 'assignmentId' is passed as 'subject'
        }
        // --- END FIX ---

        // *** NEW: Function to compress images before base64 encoding ***
        /**
         * Compresses an image file and/or converts any file to base64.
         * If the file is an image, it resizes it to a max width/height and compresses.
         * If it's not an image (e.g., PDF), it just converts to base64.
         */
        async function compressAndEncodeFile(file, maxWidthOrHeight = 1024, quality = 0.7) {
            if (!file) return null;

            // 1. If it's NOT an image (e.g., PDF), just base64 encode it
            if (!file.type.startsWith('image/')) {
                console.log("File is not an image (" + file.type + "), encoding directly.");
                try {
                    return await new Promise(function(resolve, reject) {
                        const reader = new FileReader();
                        reader.onload = function(e) { resolve(e.target.result) };
                        reader.onerror = function(e) { reject(new Error("Error reading file: " + e.message)) };
                        reader.readAsDataURL(file);
                    });
                } catch (e) {
                    console.error("Error reading non-image file:", e);
                    return file.name; // Fallback
                }
            }

            // 2. If it IS an image, compress it via Canvas
            console.log("File is an image (" + file.type + "), attempting compression...");
            return new Promise(function(resolve, reject) {
                const img = new Image();
                const objectUrl = URL.createObjectURL(file); // Create a blob URL
                
                img.onload = function() {
                    URL.revokeObjectURL(objectUrl); // Clean up the blob URL
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions, maintaining aspect ratio
                    if (width > height) {
                        if (width > maxWidthOrHeight) {
                            height = Math.round(height * (maxWidthOrHeight / width));
                            width = maxWidthOrHeight;
                        }
                    } else {
                        if (height > maxWidthOrHeight) {
                            width = Math.round(width * (maxWidthOrHeight / height));
                            height = maxWidthOrHeight;
                        }
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Get compressed data URL (JPEG, 70% quality)
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    console.log("Image compressed from " + img.width + "x" + img.height + " to " + width + "x" + height + ". New size: " + compressedDataUrl.length + " bytes");
                    resolve(compressedDataUrl);
                };

                img.onerror = function(err) {
                    URL.revokeObjectURL(objectUrl); // Clean up blob URL on error
                    console.error("Error loading image for compression, falling back to direct encoding:", err);
                    // Fallback: just base64 encode the original
                    const reader = new FileReader();
                    reader.onload = function(e) { resolve(e.target.result) }; // Resolve with uncompressed base64
                    reader.onerror = function(e) { reject(new Error("Could not read image file.")) };
                    reader.readAsDataURL(file);
                };

                img.src = objectUrl; // Trigger the load
            });
        }

        async function handleSubmitAssignment(event) {
            event.preventDefault();
            if (!db || !state.currentUser) { console.error("Firestore not initialized or user not logged in"); return; } // Check for currentUser

            const form = event.target;
            const assignmentId = form.submitAssignmentId.value;
            const submissionText = form.submissionText.value;
            // Task 2.2: Get file from file input
            const file = form.submissionFile.files[0];

            // Task 2.2: Remove attachmentUrl, check for file instead
            // const attachmentUrl = form.submissionAttachmentUrl.value; 

            if (!submissionText.trim() && !file) { // Task 2.2
                 console.warn("Submission text and file are empty.");
                 return;
            }
            
            setLoading(true); // *** MOVED: Start loading BEFORE compression ***

            // *** TASK 2 (Assignment) FIX: Convert file to base64 data URI ***
            // --- MODIFICATION: Use new compression function ---
            let submittedFileData = null;
            if (file) {
                console.log("File detected, starting compression and encoding...");
                try {
                    // Call the new helper function
                    // This will compress images or just encode other files
                    submittedFileData = await compressAndEncodeFile(file, 1024, 0.7); // Max 1024px, 70% quality
                    console.log("File processing complete.");
                } catch (e) {
                    console.error("Error compressing or encoding file:", e);
                    submittedFileData = file.name; // Fallback to filename on error
                }
            }
            // *** END MODIFICATION ***


            // setLoading(true); // *** REMOVED: Redundant ***
            const studentUid = state.currentUser.username; // Use username as stableId

            try {
                 const assignment = state.assignments.find(function(a) { return a.id === assignmentId });
                 const submissionData = {
                    assignmentId: assignmentId,
                    assignmentTitle: assignment?.title || 'Unknown Assignment', // For Grade Book
                    subject: assignment?.subject || 'Unknown', // For Grade Book
                    userId: studentUid,
                    studentName: state.currentUser.name,
                    grade: state.currentUser.grade,
                    submissionText: submissionText,
                    // attachmentUrl: attachmentUrl, // Task 2.2: Removed
                    submissionFile: submittedFileData, // *** TASK 2 FIX: Save data URI or filename ***
                    submissionTimestamp: serverTimestamp(), // Use server timestamp
                    // grade: undefined // Ensure grade is not set on initial submission
                };
                 // Remove grade property if it exists from previous edit
                 delete submissionData.grade;

                 // Check if submission already exists to update it
                 const existingSubmission = state.myAssignmentSubmissions[assignmentId];
                 if (existingSubmission && existingSubmission.id) {
                     // Update existing
                     const docRef = doc(db, ASSIGNMENT_SUBMISSIONS_COLLECTION_PATH, existingSubmission.id);
                     // Create update object, don't overwrite existing grade if teacher already set one
                     // --- SYNTAX FIX: Replaced spread operator ---
                     const updateData = Object.assign({}, submissionData);
                     if (existingSubmission.grade !== undefined) {
                         updateData.grade = existingSubmission.grade;
                     }
                     // --- EDIT: If new file is submitted, overwrite old one ---
                     if (!submittedFileData) {
                         updateData.submissionFile = existingSubmission.submissionFile || null;
                     }
                     await updateDoc(docRef, updateData);
                      console.log("Assignment submission updated.");
                 } else {
                     // Create new
                     await addDoc(collection(db, ASSIGNMENT_SUBMISSIONS_COLLECTION_PATH), submissionData);
                      console.log("Assignment submitted successfully.");
                 }
                 // Let the listener handle the state update and re-render
                 navigateTo('dashboard'); // Go back to dashboard after submit
            } catch (error) {
                 console.error("Error submitting assignment:", error);
            } finally {
                setLoading(false);
            }
        }


        // Task 4: Save Assignment Grade
        async function handleSaveAssignmentGrade(submissionId) {
            if (!db) return;
            const gradeInput = document.getElementById('grade-input-' + submissionId);
            if (!gradeInput) return;

            const gradeValue = gradeInput.value.trim();
            // ### MODIFICATION: Coerce invalid numbers (NaN) to null ###
            let grade = gradeValue === '' ? null : parseFloat(gradeValue); // Allow clearing grade

            if (isNaN(grade)) {
                grade = null; // Force NaN to null
            }

            if (grade !== null && (grade < 0 || grade > 100)) {
                console.warn("Invalid grade value. Must be between 0 and 100.");
                gradeInput.classList.add('border-red-500'); // Show error
                return;
            }
             gradeInput.classList.remove('border-red-500'); // Remove error state

            setLoading(true);
            try {
                const submissionDocRef = doc(db, ASSIGNMENT_SUBMISSIONS_COLLECTION_PATH, submissionId);
                await updateDoc(submissionDocRef, {
                    grade: grade // Save as number or null
                });
                console.log("Grade saved for", submissionId);
                // Give visual feedback
                gradeInput.classList.add('bg-green-100', 'border-green-400');
                setTimeout(function() {
                    gradeInput.classList.remove('bg-green-100', 'border-green-400');
                }, 2000);
            } catch (error) {
                console.error("Error saving grade:", error);
            } finally {
                setLoading(false);
            }
        }
        
          function formatDateForInput(date) {
            if (!date) return '';
            try {
                const dateObj = new Date(date.toDate ? date.toDate() : date);
                // Adjust for timezone offset to get correct YYYY-MM-DD in local time
                dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset());
                return dateObj.toISOString().split('T')[0];
            } catch (e) {
                console.warn("Could not parse date:", date, e);
                return '';
            }
        }      // --- NEW: PAYMENT FUNCTIONS ---

        function openPaymentModal(sessionId = null) {
            if (sessionId) {
                // Edit existing session
                state.isEditingPayment = true;
                const session = state.allPaymentSessions.find(function(s) { return s.id === sessionId });
                state.editingPaymentSession = JSON.parse(JSON.stringify(session)) || null; // Deep copy
                 if (!state.editingPaymentSession) {
                     console.error("Payment session not found for editing:", sessionId);
                     state.isEditingPayment = false;
                     state.editingPaymentSession = { studentId: '', sessionStartDate: '', sessionEndDate: '', paymentStatus: 'No Payment', amountDue: 0, notes: '' };
                 }
            } else {
                // Create new session
                state.isEditingPayment = false;
                state.editingPaymentSession = { studentId: '', sessionStartDate: '', sessionEndDate: '', paymentStatus: 'No Payment', amountDue: 0, notes: '' };
            }
            state.isPaymentModalOpen = true;
            renderApp();
        }

        function closePaymentModal() {
            state.isPaymentModalOpen = false;
            state.isEditingPayment = false;
            state.editingPaymentSession = null;
            renderApp();
        }

        async function handleSavePaymentSession(event) {
            event.preventDefault();
            if (!db || !state.currentUser) { console.error("Not logged in"); return; }
            setLoading(true);
            
            const form = event.target;
            const sessionId = form.paymentSessionId.value;
            const studentId = form.paymentStudentId.value;
            const startDate = form.paymentStartDate.value;
            const endDate = form.paymentEndDate.value;
            
            // Find student info
            // --- EDIT: Use state.allUserProfiles if available, fallback to seed ---
            const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;
            const student = userSource.find(function(u) { return u.username === studentId });
            if (!student) {
                console.error("Selected student not found!");
                setLoading(false);
                return;
            }
            
            try {
                const sessionData = {
                    studentId: student.username,
                    studentName: student.name,
                    studentGrade: student.grade,
                    sessionStartDate: new Date(startDate), // Store as Firestore Timestamp
                    sessionEndDate: new Date(endDate), // Store as Firestore Timestamp
                    amountDue: parseFloat(form.paymentAmountDue.value) || 0,
                    notes: form.paymentNotes.value || '',
                    paymentStatus: form.paymentStatus.value,
                    teacherId: state.currentUser.username,
                    lastUpdated: serverTimestamp(),
                };

                if (state.isEditingPayment && sessionId) {
                    // --- NEW: Create History Entry ---
                    const originalSession = state.allPaymentSessions.find(function(s) { return s.id === sessionId });
                    let historyEntry = null;
                    if (originalSession && (
                        originalSession.paymentStatus !== sessionData.paymentStatus ||
                        originalSession.amountDue !== sessionData.amountDue ||
                        originalSession.notes !== sessionData.notes
                    )) {
                        historyEntry = {
                            timestamp: serverTimestamp(),
                            previousStatus: originalSession.paymentStatus || 'N/A',
                            previousAmount: originalSession.amountDue || 0,
                            previousNotes: originalSession.notes || '',
                            changedBy: state.currentUser.name
                        };
                    }
                    // --- END NEW ---
                    
                    // Update
                    const docRef = doc(db, PAYMENT_SESSIONS_COLLECTION_PATH, sessionId);
                    
                    // Add history entry to the update object if it was created
                    if (historyEntry) {
                        sessionData.history = arrayUnion(historyEntry);
                    }
                    
                    await updateDoc(docRef, sessionData);
                    console.log("Payment session updated:", sessionId);
                } else {
                    // Create New
                    // We don't need to add `reminderSentTimestamp` here, it will be added on remind
                    const docRef = await addDoc(collection(db, PAYMENT_SESSIONS_COLLECTION_PATH), sessionData);
                    console.log("Payment session created:", docRef.id);
                }
                closePaymentModal();
            } catch (error) {
                console.error("Error saving payment session:", error);
            } finally {
                setLoading(false);
            }
        }
        
        async function handleDeletePaymentSession(sessionId) {
            if (!db) { console.error("Firestore not initialized"); return; }
            console.log("Deleting payment session:", sessionId);
            // Bypassing confirm dialog
            setLoading(true);
            try {
                await deleteDoc(doc(db, PAYMENT_SESSIONS_COLLECTION_PATH, sessionId));
            } catch (error) {
                console.error("Error deleting payment session:", error);
            } finally {
                setLoading(false);
            }
        }
        
        async function handleSendPaymentReminder(sessionId) {
            if (!db) { console.error("Firestore not initialized"); return; }
            console.log("Sending payment reminder for:", sessionId);
            setLoading(true);
            try {
                const docRef = doc(db, PAYMENT_SESSIONS_COLLECTION_PATH, sessionId);
                await updateDoc(docRef, {
                    reminderSentTimestamp: serverTimestamp(),
                    lastUpdated: serverTimestamp()
                });
                // Find the button and give visual feedback
                const button = document.querySelector('button[data-action="send-payment-reminder"][data-id="' + sessionId + '"]');
                if(button) {
                    button.innerText = 'Reminder Sent!';
                    button.classList.add('bg-green-100', 'text-green-700');
                    setTimeout(function() {
                         button.innerText = 'Send Reminder';
                         button.classList.remove('bg-green-100', 'text-green-700');
                    }, 3000);
                }
            } catch (error) {
                console.error("Error sending reminder:", error);
            } finally {
                setLoading(false);
            }
        }
        
        async function handleChangePaymentStatus(sessionId, newStatus) {
            if (!db) { console.error("Firestore not initialized"); return; }
            console.log("Updating status for " + sessionId + " to " + newStatus);
            setLoading(true);
            try {
                const docRef = doc(db, PAYMENT_SESSIONS_COLLECTION_PATH, sessionId);
                await updateDoc(docRef, {
                    paymentStatus: newStatus,
                    lastUpdated: serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating payment status:", error);
            } finally {
                setLoading(false);
                // The listener will re-render the app with the new status
            }
        }


        // --- QUIZ FUNCTIONS (Task 1 Refactor) ---

        // Task 1: Parse quiz text into JSON
        function parseQuizText(text) {
            const questions = [];
            // Normalize line endings and split
            const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            let currentQuestion = null;
            let idCounter = 1;

            lines.forEach(function(line) {
                line = line.trim();
                if (!line) return; // Skip empty lines

                // Match question number (e.g., "1.", "1)", "1-") followed by text
                const qMatch = line.match(/^(\d+)[\.\)\-]?\s+(.*)/);
                 if (qMatch && qMatch[2]) {
                     // Save previous question if exists and valid
                     if (currentQuestion && (Object.keys(currentQuestion.options).length > 0 || currentQuestion.type === 'FillIn') && currentQuestion.answer) {
                          // Final check for TF based on options if not already set
                         if (currentQuestion.type === 'MC' && Object.keys(currentQuestion.options).length === 2 && 'T' in currentQuestion.options && 'F' in currentQuestion.options) {
                             currentQuestion.type = 'TF';
                         }
                         questions.push(currentQuestion);
                     }
                     // Start new question object
                     currentQuestion = {
                         id: idCounter++,
                         type: 'MC', // Default to MC
                         introduction: '', // <-- NEW
                         questionImage: '', // <-- NEW
                         discussion: '',
                         question: qMatch[2].trim(),
                         options: {},
                         answer: '',
                         feedback: { correct: 'Correct!', incorrect: 'Incorrect.' }
                     };
                     return; // Move to next line after processing question start
                 }
                // --- NEW: Match Introduction ---
                const introMatch = line.match(/^Intro(duction)?:\s*(.*)/i); // Case-insensitive
                if (currentQuestion && introMatch) {
                    currentQuestion.introduction = introMatch[2].trim();
                    return; // Move to next line
                }
                // --- NEW: Match Question Image ---
                const imageMatch = line.match(/^Image:\s*(.*)/i); // Case-insensitive
                if (currentQuestion && imageMatch) {
                    currentQuestion.questionImage = imageMatch[1].trim();
                    return; // Move to next line
                }
                // Match options (e.g., "a. text", "a) text", "A. Text") - Allow uppercase option letters
                 const optMatch = line.match(/^([a-zA-Z])[\.\)]\s+(.*)/);
                 if (currentQuestion && optMatch) {
                     const optKey = optMatch[1].toUpperCase();
                     const optValue = optMatch[2].trim();
                     if (['A', 'B', 'C', 'D', 'T', 'F'].includes(optKey) && optValue) { // Allow T/F as options
                         currentQuestion.options[optKey] = optValue;
                         // Don't auto-detect TF here yet, wait until all options/answer are parsed
                     }
                     return; // Move to next line
                 }
                // Match Answer (e.g., "Answer: b", "Answer:B", "Answer: text for fill-in")
                 const answerMatch = line.match(/^Answer:\s*(.*)/i); // Case-insensitive match for "Answer:"
                 if (currentQuestion && answerMatch) {
                    const answerValue = answerMatch[1].trim();
                    if (answerValue) {
                         // Decide type based on whether options exist at this point
                         if (Object.keys(currentQuestion.options).length > 0) {
                             currentQuestion.answer = answerValue.substring(0, 1).toUpperCase();
                             // Check if options are only T/F
                             const optionsKeys = Object.keys(currentQuestion.options);
                             if(optionsKeys.length === 2 && optionsKeys.includes('T') && optionsKeys.includes('F')) {
                                 currentQuestion.type = 'TF';
                             } else {
                                 currentQuestion.type = 'MC'; // Or MT if specified later? Parser assumes MC/TF based on options.
                             }
                         } else {
                             // No options found, assume FillIn
                             currentQuestion.type = 'FillIn';
                             currentQuestion.answer = answerValue; // Keep original case for fill-in
                         }
                     }
                     return; // Move to next line
                }
                // Match Discussion (e.g., "Discussion: ...")
                 const discussionMatch = line.match(/^Discussion:\s*(.*)/i); // Case-insensitive
                 if (currentQuestion && discussionMatch) {
                    currentQuestion.discussion = discussionMatch[1].trim();
                    return; // Move to next line
                }
                // Match explicit Type (e.g., "Type: FillIn", "Type: TF")
                 const typeMatch = line.match(/^Type:\s*(.*)/i); // Case-insensitive
                 if (currentQuestion && typeMatch) {
                     const typeValue = typeMatch[1].trim().toUpperCase();
                     if (typeValue === 'FILLIN' || typeValue === 'FILL-IN' || typeValue === 'IDENTIFICATION') {
                         currentQuestion.type = 'FillIn';
                     } else if (typeValue === 'TF' || typeValue === 'TRUEFALSE' || typeValue === 'TRUE/FALSE') {
                         currentQuestion.type = 'TF';
                     } else if (typeValue === 'MC' || typeValue === 'MULTIPLECHOICE' || typeValue === 'MULTIPLE CHOICE') {
                         currentQuestion.type = 'MC';
                     } // Add MT later if needed
                     return; // Move to next line
                 }

                 // Append to discussion or question if it's a continuation line
                 if (currentQuestion) {
                      // If a discussion has started, append there
                      if (currentQuestion.discussion) {
                          currentQuestion.discussion += (currentQuestion.discussion.endsWith('\n') ? '' : '\n') + line;
                      }
                      // --- NEW: If intro has started (and discussion hasn't), append there ---
                     else if (currentQuestion.introduction && !currentQuestion.discussion) {
                         currentQuestion.introduction += (currentQuestion.introduction.endsWith('\n') ? '' : '\n') + line;
                     }
                      // Otherwise, append to the question text
                      else if (currentQuestion.question) {
                          currentQuestion.question += (currentQuestion.question.endsWith('\n') ? '' : '\n') + line;
                      }
                 }
            });

            // Push the last valid question after loop finishes
            if (currentQuestion && (Object.keys(currentQuestion.options).length > 0 || currentQuestion.type === 'FillIn') && currentQuestion.answer) {
                 // Final check for TF based on options if not already set by "Type:" or Answer parsing
                 if (currentQuestion.type === 'MC' && Object.keys(currentQuestion.options).length === 2 && 'T' in currentQuestion.options && 'F' in currentQuestion.options) {
                     currentQuestion.type = 'TF';
                 }
                questions.push(currentQuestion);
            }
            return questions;
        }


        // Task 1: Save parsed quiz to Firestore
        async function handleSaveQuiz(event) {
            event.preventDefault();
            if (!db) return;
            setLoading(true);
            const errorDiv = document.getElementById('quiz-editor-error');
            errorDiv.innerText = ''; // Clear previous errors
            errorDiv.classList.remove('text-red-500', 'text-green-500');

            const form = event.target;
            const quizId = form.quizId.value; // NEW: Get quizId for editing
            const subject = form.quizSubject.value;
            const gradeLevel = form.quizGradeLevel.value;
            const quarter = form.quizQuarter.value; // NEW: Get quarter
            const rawText = form.quizText.value;
            const title = form.quizTitle.value; // NEW: Get title
            
            if (!subject) {
                 errorDiv.innerText = 'Error: Please select a subject. If the list is empty, select a grade level first.';
                 errorDiv.classList.add('text-red-500');
                 setLoading(false);
                 return;
            }
            if (!title.trim()) { // NEW: Validate title
                 errorDiv.innerText = 'Error: Please enter a Quiz Title.';
                 errorDiv.classList.add('text-red-500');
                 setLoading(false);
                 return;
            }

            try {
                const questions = parseQuizText(rawText);
                if (questions.length === 0) {
                    throw new Error("Parsing failed. No valid questions found. Check format: Start with '1.', use 'A) Option', include 'Answer: A' or 'Answer: Text for FillIn'. Optional: 'Discussion: ...', 'Type: FillIn'.");
                }

                const quizData = {
                    title: title.trim(), // NEW: Save title
                    subject: subject,
                    gradeLevel: gradeLevel,
                    quarter: quarter, // NEW: Save quarter
                    questions: questions, // The parsed array
                    teacherName: state.currentUser.name,
                    teacherId: state.currentUser.username, // ### MODIFIED: Add teacherId
                    timestamp: serverTimestamp(), // Use server timestamp for sorting/tracking
                    status: state.editingQuiz?.status || 'active', // Preserve status on edit
                };


                if (state.isEditingQuiz && quizId) {
                    // Update existing
                    const docRef = doc(db, QUIZZES_COLLECTION_PATH, quizId);
                    await updateDoc(docRef, quizData); // Overwrite with new questions and timestamp
                    console.log("Quiz updated:", quizId);
                     errorDiv.innerText = 'Quiz updated successfully!';
                } else {
                    // Create new
                    quizData.status = 'active'; // NEW: Ensure status is active on create
                    const docRef = await addDoc(collection(db, QUIZZES_COLLECTION_PATH), quizData);
                    console.log("Quiz created:", docRef.id);
                     errorDiv.innerText = 'Quiz saved successfully!';
                }

                form.reset();
                state.isEditingQuiz = false; // NEW: Reset editing state
                state.editingQuiz = null; // NEW: Clear editing data
                
                 // Show success message
                 errorDiv.classList.add('text-green-500');
                 // Reset dropdowns
                 updateSubjectDropdown('quizGradeLevel', 'quizSubject');
                 renderApp(); // NEW: Re-render to show updated button text
                 setTimeout(function() { errorDiv.innerText = ''; errorDiv.classList.remove('text-green-500'); }, 3000);

            } catch (error) {
                console.error("Error saving quiz:", error);
                // Show specific error to user
                 errorDiv.innerText = 'Error: ' + error.message;
                 errorDiv.classList.add('text-red-500');

            } finally {
                setLoading(false);
            }
        }

        // NEW: Load quiz data into the editor
        function handleEditQuiz(quizId) {
            const quiz = state.allQuizzes.find(function(q) { return q.id === quizId });
            if (!quiz) {
                console.error("Quiz not found for editing:", quizId);
                return;
            }
            
            // Set state
            state.isEditingQuiz = true;
            state.editingQuiz = JSON.parse(JSON.stringify(quiz)); // Deep copy
            
            // Re-render the dashboard (which will show renderQuizEditor)
            renderApp();
            
            // Now that renderApp is called, populate the form
            try {
                document.getElementById('quizId').value = quiz.id || '';
                document.getElementById('quizTitle').value = quiz.title || '';
                document.getElementById('quizGradeLevel').value = quiz.gradeLevel || 'All';
                
                // Update subject dropdown *before* setting its value
                updateSubjectDropdown('quizGradeLevel', 'quizSubject');
                document.getElementById('quizSubject').value = quiz.subject || '';
                
                document.getElementById('quizQuarter').value = quiz.quarter || 'Q1';
                document.getElementById('quizText').value = quizQuestionsToText(quiz.questions);
                
                // Scroll to top of form
                document.getElementById('quiz-editor-form')?.scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                console.error("Error populating quiz editor form:", e);
                // Clear state if form population fails
                state.isEditingQuiz = false;
                state.editingQuiz = null;
                renderApp();
            }
        }

        // NEW: Cancel quiz edit
        function handleCancelEditQuiz() {
            state.isEditingQuiz = false;
            state.editingQuiz = null;
            renderApp(); // Re-renders quiz editor with blank form
        }

        // Task 1: Delete quiz from Firestore
        // --- NEW: Renamed to handleArchiveQuiz ---
        async function handleArchiveQuiz(quizId, status) {
             if (!db) return;
             console.log("Setting quiz " + quizId + " status to: " + status);
             setLoading(true);
             try {
                const docRef = doc(db, QUIZZES_COLLECTION_PATH, quizId);
                await updateDoc(docRef, { status: status });
             } catch (error) {
                 console.error("Error updating quiz status:", error);
             } finally {
                setLoading(false);
             }
        }

        // NEW: Delete Quiz
        async function handleDeleteQuiz(quizId) {
            if (!db) return;
            console.log("Deleting quiz: " + quizId);
            setLoading(true);
            try {
                const docRef = doc(db, QUIZZES_COLLECTION_PATH, quizId);
                await deleteDoc(docRef);
                console.log("Quiz deleted successfully.");
            } catch (error) {
                console.error("Error deleting quiz:", error);
            } finally {
                setLoading(false);
            }
        }


        function saveProgress() {
            if (state.view !== 'quiz' || !state.currentUser || !state.quizSubject) return;
            try {
                const progress = {
                    responses: state.quizResponses,
                    currentQuestionIndex: state.currentQuestionIndex,
                };
                 // Task 1: Use subject AND grade in the key
                const key = 'unfinishedQuiz_' + state.currentUser.username + '_' + state.quizId; // CHANGED: Use quizId
                localStorage.setItem(key, JSON.stringify(progress));
            } catch (e) {
                console.warn("Could not save quiz progress to localStorage:", e);
            }
        }

        function handleAnswerSelection(event) {
            state.selectedAnswer = event.target.value;
            // No need to renderApp or saveProgress on every input change for FillIn
            // It will be saved when checkAnswer or nextQuestion is called.
            // Only update button state for FillIn
            const currentQ = state.quizData[state.currentQuestionIndex];
            const questionType = currentQ?.type || 'MC';

             if (questionType === 'MC' || questionType === 'MT' || questionType === 'TF') {
                 renderApp(); // Re-render to show selection styling
                 saveProgress();
             } else { // For text inputs
                const submitButton = document.getElementById('submit-answer-button');
                if (submitButton) {
                    submitButton.disabled = !state.selectedAnswer || !state.selectedAnswer.trim();
                }
             }
        }


        function checkAnswerAndProvideFeedback() {
            if (!state.selectedAnswer || (typeof state.selectedAnswer === 'string' && !state.selectedAnswer.trim())) return;

            const currentQ = state.quizData[state.currentQuestionIndex];
             // Task 1: Ensure answer comparison is correct for different types
             const questionType = currentQ.type || 'MC';
             let isCorrect;
             if (questionType === 'MC' || questionType === 'MT' || questionType === 'TF') {
                 isCorrect = state.selectedAnswer === currentQ.answer;
             } else { // FillIn - Case-insensitive comparison
                 isCorrect = state.selectedAnswer.trim().toLowerCase() === String(currentQ.answer).trim().toLowerCase();
             }

            // Store or update response for this question index
            const responseData = {
                questionId: currentQ.id,
                response: state.selectedAnswer.trim(),
                correctAnswer: currentQ.answer,
                isCorrect: isCorrect,
            };
            // Ensure quizResponses matches currentQuestionIndex length or update existing
            state.quizResponses[state.currentQuestionIndex] = responseData;


            state.quizFeedback = {
                isCorrect: isCorrect,
                 message: isCorrect ? (currentQ.feedback?.correct || 'Correct!') : (currentQ.feedback?.incorrect || 'Incorrect.'),
            };

            saveProgress(); // Save state including feedback
            renderApp();
        }

        function nextQuestion() {
            if (state.currentQuestionIndex < state.quizData.length - 1) {
                state.quizFeedback = null;
                state.selectedAnswer = null; // Clear selection for next question
                state.currentQuestionIndex++;

                // Pre-load saved answer if exists for the *next* question
                 const savedResponse = state.quizResponses[state.currentQuestionIndex];
                 if (savedResponse) {
                     state.selectedAnswer = savedResponse.response;
                 } else {
                     // If no saved response, ensure selectedAnswer is cleared
                     state.selectedAnswer = null;
                 }


                saveProgress();
                renderApp();
            } else {
                submitQuiz(); // Submit if it was the last question
            }
        }


        async function submitQuiz() {
            state.view = 'result';
            renderApp(); // Show result page immediately

             // Task 1: Use subject AND grade in the key
            const key = 'unfinishedQuiz_' + state.currentUser.username + '_' + state.quizId; // CHANGED: Use quizId
            try { localStorage.removeItem(key); } catch(e) { console.warn("Could not remove item from localStorage:", e); } // Clear saved progress

            if (!db || !state.currentUser) { // Check for currentUser
                console.warn("Cannot submit score: Firebase not available.");
                return;
            }

            setLoading(true);
            const studentUid = state.currentUser.username; // Use username as stableId

            try {
                // Use UID as document ID in quiz_results
                const studentDocRef = doc(db, QUIZ_RESULTS_COLLECTION_PATH, studentUid); // Use username as doc ID

                // Filter out any potential undefined/null entries in quizResponses
                const validResponses = state.quizResponses.filter(function(r) { return r !== undefined && r !== null });

                const newAttempt = {
                    quizId: state.quizId, // NEW: Tag attempt with quizId
                    score: validResponses.filter(function(r) { return r.isCorrect }).length,
                    totalItems: state.quizData.length,
                    timestamp: Date.now(), // Use client timestamp for simplicity, or serverTimestamp()
                    responses: validResponses.map(function(r) { return ({ qId: r.questionId, r: r.response, correct: r.correctAnswer, isCorrect: r.isCorrect }) }), // Include correctness
                };

                const studentDoc = await getDoc(studentDocRef);
                const dataToSet = studentDoc.exists() ? studentDoc.data() : {
                    userId: studentUid, // Ensure userId is set for new docs
                    name: state.currentUser.name,
                    grade: state.currentUser.grade,
                    subjects: {}
                };

                // Always update name and grade in case they changed in USERS array (though unlikely in this app structure)
                dataToSet.name = state.currentUser.name;
                dataToSet.grade = state.currentUser.grade;
                dataToSet.subjects = dataToSet.subjects || {}; // Ensure subjects object exists
                dataToSet.subjects[state.quizSubject] = dataToSet.subjects[state.quizSubject] || { attempts: [] }; // Ensure subject and attempts array exist

                dataToSet.subjects[state.quizSubject].attempts.push(newAttempt);

                // Use setDoc with merge:true to create or update
                await setDoc(studentDocRef, dataToSet, { merge: true });
                console.log("Quiz results submitted successfully for UID:", studentUid);

            } catch (error) {
                console.error("Error submitting quiz results to Firestore:", error);
            } finally {
                setLoading(false);
            }
        }

        // --- FIX: RE-ADDING ALL MISSING RENDER FUNCTIONS ---

        function renderLogin() {
            // ### NEW: Get saved login info from localStorage ###
            let savedUsername = '';
            let savedPassword = ''; // Will be populated
            let saveLoginChecked = false;
            try {
                savedUsername = localStorage.getItem('ttc_saved_username') || '';
                // --- REVERT: Retrieve saved password ---
                savedPassword = localStorage.getItem('ttc_saved_password') || '';
                // --- FIX: Check only for username to check the box ---
                if (savedUsername) { // Check only for username
                    saveLoginChecked = true;
                }
            } catch (e) {
                console.warn("Could not read saved login from localStorage.", e);
            }
            // ### END NEW ###

            return `
                <div class="flex items-center justify-center min-h-screen bg-emerald-50">
                    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl card border border-gray-200">
                        <div class="text-center">
                            <!-- ### LOGO ADDED AS REQUESTED ### -->
                            <img src="https://pbs.twimg.com/media/G4h6l5ea8AYzQhK?format=jpg&name=large" 
                                 alt="Tobias Tutorial Center Logo" 
                                 class="w-24 h-24 mx-auto mb-4 rounded-full object-cover border-4 border-emerald-100 shadow-sm"
                                 onerror="this.style.display='none'"> <!-- Fallback in case the link breaks -->

                            <h1 class="text-3xl font-extrabold text-emerald-600">Tobias Tutorial Center</h1>
                            <p class="mt-2 text-lg text-gray-500">Learning Management System</p>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                <!-- ### MODIFIED: Added 'value' attribute ### -->
                                <input id="username" name="username" type="text" required oninput="clearLoginError()" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="Enter your username" value="${savedUsername}">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <!-- ### MODIFIED: Added 'value' attribute ### -->
                                <input id="password" name="password" type="password" required oninput="clearLoginError()" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="" value="${savedPassword}">
                            </div>
                            
                            <!-- ### NEW "SAVE LOGIN" CHECKBOX ### -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input id="saveLogin" name="saveLogin" type="checkbox" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded" ${saveLoginChecked ? 'checked' : ''}>
                                    <label for="saveLogin" class="ml-2 block text-sm text-gray-900">
                                        Save Login Info
                                    </label>
                                </div>
                            </div>
                            <!-- ### END NEW CHECKBOX ### -->
                            
                            <div id="login-message" class="text-center h-10 flex items-center justify-center">
                                ${state.loginError ? '<p class="text-red-500 text-sm">' + state.loginError + '</p>' : ''}
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                                Log In
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            if (!state.currentUser) return renderLogin(); // Safety check

            const greetingName = state.currentUser.name.split(' ')[0]; // Get first name

            let dashboardContent = '';
            // --- EDIT: Add admin role ---
            if (state.currentUser.role === 'teacher') {
                dashboardContent = renderTeacherDashboard();
            } else if (state.currentUser.role === 'admin') {
                dashboardContent = renderAdminDashboard();
            } else {
                dashboardContent = renderStudentDashboard();
            }

            return `
                <div class="min-h-screen bg-gray-100">
                    <!-- Header -->
                    <header class="bg-white shadow-md card fixed top-0 left-0 right-0 z-50">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-20">
                                <div class="flex items-center">
                                    <!-- Task 2.1: Add profile pic to header -->
                                    <img src="${state.currentUser.profilePicUrl}" alt="Profile" id="headerProfilePic" data-action="upload-pic" class="h-10 w-10 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity">
                                    <h1 class="text-2xl font-bold text-gray-800 ml-3 hidden sm:block">Hello, ${greetingName}!</h1>
                                </div>
                                <div class="flex items-center">
                                    <button data-action="logout" class="ml-4 px-4 py-2 bg-emerald-50 text-emerald-600 font-semibold rounded-lg hover:bg-emerald-100 transition-colors text-sm shadow-sm">
                                        Logout
                                    </button>
                                </div>
                            </div>
                             <!-- Hidden file input for profile pic -->
                            <input type="file" id="profileUpload" accept="image/png, image/jpeg" style="display: none;" onchange="handleProfilePicUpload(event)">
                        </div>
                    </header>

                    <!-- Main Content Area -->
                    <main class="pt-24 pb-12 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        ${dashboardContent}
                    </main>

                     <!-- Render Modals if open -->
                     ${state.isLessonModalOpen ? renderLessonBookModal() : ''}
                     ${state.isAssignmentModalOpen ? renderAssignmentModal() : ''}
                     ${state.isPaymentModalOpen ? renderPaymentModal() : ''}
                     ${state.isUserModalOpen ? renderUserModal() : ''}
                </div>
            `;
        }

        function renderStudentDashboard() {
            const grade = state.currentUser.grade;
             // Filter announcements for student's grade or 'All'
             // Task 1: Handle grade mapping for 3.1, 3.2, 5.1 -> 3, 3, 5
             const studentGradeStr = String(grade);
             const relevantAnnouncements = state.announcements.filter(function(ann) { return ann.gradeLevel === 'All' || String(ann.gradeLevel) === studentGradeStr });
             
             // NEW: Check for payment reminders
             const recentReminders = state.studentPaymentSessions.filter(function(s) {
                return s.reminderSentTimestamp && 
                (Date.now() - s.reminderSentTimestamp.toDate().getTime()) < (14 * 86400000) // Reminders active for 14 days
             });

             // --- ### NEW: Calculate Notification Counts ### ---
             const enrolledSubjects = getEnrolledSubjects(state.currentUser);
             
             // 1. Lessons To-Do (Not Completed)
             const relevantLessons = state.lessonBooks.filter(function(lb) {
                const isMatchingGrade = (lb.gradeLevel === 'All' || String(lb.gradeLevel) === String(grade));
                const isEnrolledSubject = enrolledSubjects.includes(lb.subject);
                return (isMatchingGrade && (isEnrolledSubject || !lb.subject)) && lb.status === 'active';
             });
             const lessonsToDoCount = relevantLessons.filter(lesson => !state.lessonBookProgress[lesson.id]?.completed).length;
             
             // 2. Assignments To-Do (Not Submitted)
             const relevantAssignments = state.assignments.filter(function(a) {
                const isMatchingGrade = (a.gradeLevel === 'All' || String(a.gradeLevel) === String(grade));
                const isEnrolledSubject = enrolledSubjects.includes(a.subject);
                return (isMatchingGrade && (isEnrolledSubject || !a.subject)) && a.status === 'active';
             });
             const assignmentsToDoCount = relevantAssignments.filter(assignment => !state.myAssignmentSubmissions[assignment.id]).length;
             
             // 3. Quizzes To-Do (Not Attempted)
             const relevantQuizzes = state.allQuizzes.filter(function(q) {
                const isMatchingGrade = (String(q.gradeLevel) === studentGradeStr || q.gradeLevel === 'All');
                const isEnrolledSubject = enrolledSubjects.includes(q.subject);
                return isMatchingGrade && isEnrolledSubject && q.status === 'active' && q.questions?.length > 0;
             });
             const quizzesToDoCount = relevantQuizzes.filter(quiz => {
                 const attempts = (state.studentStats[quiz.subject]?.attempts || []).filter(a => a.quizId === quiz.id);
                 return attempts.length === 0;
             }).length;
             
             // 4. Online Class Notifications (LIVE meetings)
             const studentUsername = state.currentUser.username;
             const meetingsToShow = state.allMeetings.filter(meeting => {
                const isInvited = meeting.participants && meeting.participants.includes(studentUsername);
                const isForMyGrade = meeting.gradeLevel && meeting.gradeLevel !== '' && (meeting.gradeLevel === 'All' || String(meeting.gradeLevel) === studentGradeStr);
                const isForMySubject = !meeting.subject || enrolledSubjects.includes(meeting.subject);
                return (isInvited || (isForMyGrade && isForMySubject));
             });
             const now = new Date();
             const threeHours = 3 * 60 * 60 * 1000;
             const liveMeetingsCount = meetingsToShow.filter(meeting => {
                 if (meeting.status === 'ended') return false;
                 const startTime = meeting.startTime?.toDate();
                 if (startTime) {
                     // "LIVE" if start time is in the past and within 3 hours
                     return (startTime.getTime() < now.getTime() && (now.getTime() - startTime.getTime()) < threeHours);
                 }
                 // Jitsi class without start time is "LIVE" if not ended
                 return (meeting.meetingType === 'jitsi' && meeting.status !== 'ended');
             }).length;
             
             // Helper function to render the badge
             const renderBadge = (count) => {
                if (count > 0) {
                    return `<span class="ml-1.5 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-bold bg-red-500 text-white">${count > 9 ? '9+' : count}</span>`;
                }
                return '';
             };
             // --- ### END NEW: Calculate Notification Counts ### ---

             return `
                 <div class="flex flex-col lg:flex-row gap-6">
                     <!-- Left Column (Announcements & Profile) -->
                     <div class="lg:w-1/3 w-full space-y-6">
                         ${renderAnnouncementsForStudent(relevantAnnouncements, recentReminders)}
                         ${renderStudentProfileSection()}
                     </div>

                     <!-- Right Column (Tabs for Quizzes, Lessons, Assignments) -->
                     <div class="lg:w-2/3 w-full">
                         <!-- Tab Navigation -->
                         <div class="mb-4 border-b border-gray-200">
                             <nav class="flex flex-wrap -mb-px space-x-6" aria-label="Tabs">
                                 <!-- ### MODIFIED: Reordered Tabs ### -->
                                 <button data-action="set-dashboard-tab" data-tab="onlineClass"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'onlineClass' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     Online Class ${renderBadge(liveMeetingsCount)}
                                 </button>
                                 <button data-action="set-dashboard-tab" data-tab="lessons"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'lessons' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     Lessons ${renderBadge(lessonsToDoCount)}
                                 </button>
                                 <button data-action="set-dashboard-tab" data-tab="assignments"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'assignments' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     Assignments ${renderBadge(assignmentsToDoCount)}
                                 </button>
                                 <button data-action="set-dashboard-tab" data-tab="quizzes"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'quizzes' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     Quizzes & Scores ${renderBadge(quizzesToDoCount)}
                                 </button>
                                  <button data-action="set-dashboard-tab" data-tab="gradeBook"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'gradeBook' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     My Grade Book
                                 </button>
                                 <button data-action="set-dashboard-tab" data-tab="mySubjects"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'mySubjects' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     My Subjects
                                 </button>
                                 <button data-action="set-dashboard-tab" data-tab="payments"
                                         class="py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === 'payments' ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                     Payments ${recentReminders.length > 0 ? '<span class="ml-1.5 inline-block bg-red-500 text-white text-xs font-bold w-4 h-4 rounded-full text-center leading-4">' + recentReminders.length + '</span>' : ''}
                                 </button>
                                 <!-- ### END MODIFICATION ### -->
                             </nav>
                         </div>

                         <!-- Tab Content -->
                         <div id="student-tab-content">
                             ${state.dashboardTab === 'quizzes' ? renderStudentQuizList() : ''}
                             ${state.dashboardTab === 'lessons' ? renderStudentLessonsListForTab() : ''}
                             ${state.dashboardTab === 'assignments' ? renderStudentAssignmentsListForTab() : ''}
                             ${state.dashboardTab === 'gradeBook' ? renderStudentGradeBook() : ''}
                             ${state.dashboardTab === 'payments' ? renderStudentPaymentStatus() : ''}
                             ${state.dashboardTab === 'mySubjects' ? renderMySubjects() : ''}
                             ${state.dashboardTab === 'onlineClass' ? renderOnlineClassTab() : ''}
                         </div>
                     </div>
                 </div>
             `;
        }

        // Task 2.1: New function to render student profile section
        function renderStudentProfileSection() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">My Profile</h2>
                     <div class="flex flex-col items-center">
                        <img src="${state.currentUser.profilePicUrl}" alt="Profile Picture" id="dashboardProfilePic" data-action="upload-pic" class="w-32 h-32 rounded-full object-cover border-4 border-emerald-200 shadow-md mb-4 cursor-pointer hover:opacity-80 transition-opacity">
                        <h3 class="text-xl font-semibold text-gray-800">${state.currentUser.name}</h3>
                        <p class="text-sm text-gray-500">Grade ${state.currentUser.grade}</p>
                        <p class="text-xs text-gray-400 mt-2" title="Username/Stable ID">${state.currentUser.username}</p>
                        
                        <!-- Hidden file input for student profile pic, triggered by clicking image -->
                        <!-- MOVED to renderDashboard to be shared -->
                     </div>
                </div>
            `;
        }
        
        // Task 2.1: New stubbed function for profile pic upload
        async function handleProfilePicUpload(event) { // Make the main function async
            const file = event.target.files[0];
            if (!file) return;
            
            console.log("File selected: " + file.name + ". Compressing and encoding...");
            
            // --- NEW: Use compression function ---
            setLoading(true);
            let base64Url = null;
            try {
                // Compress to a small size for a profile pic
                base64Url = await compressAndEncodeFile(file, 256, 0.8); // 256px, 80% quality
            } catch (e) {
                console.error("Error compressing profile pic:", e);
                setLoading(false);
                return;
            }
            // --- END NEW ---

            if (!base64Url) {
                console.error("File compression returned null.");
                setLoading(false);
                return;
            }
            
            // Update the header image
            const headerImg = document.getElementById('headerProfilePic');
            if (headerImg) headerImg.src = base64Url;
            // Update the dashboard image
            const dashboardImg = document.getElementById('dashboardProfilePic'); // Use new ID
            if (dashboardImg) dashboardImg.src = base64Url;
            
            // Save to state and localStorage
            if (state.currentUser && state.currentUser.username) {
                state.currentUser.profilePicUrl = base64Url;
                try {
                    localStorage.setItem('profilePic_' + state.currentUser.username, base64Url);
                } catch (e) {
                    console.warn("Could not save profile pic to localStorage", e);
                }

                // *** NEW: Save to Firestore ***
                // --- EDIT: Also save to user_profiles collection ---
                if (db && auth.currentUser) {
                    // setLoading(true); // Already set
                    try {
                        const stableId = state.currentUser.username;
                        
                        // 1. Update user_profiles doc (if not admin)
                        // ### FIX: Removed admin check ###
                        const userProfileDocRef = doc(db, USER_PROFILES_COLLECTION_PATH, stableId);
                        await setDoc(userProfileDocRef, { profilePicUrl: base64Url }, { merge: true });
                        console.log("Profile pic updated in user_profiles.");


                        // 2. Update quiz_results doc (for student/teacher stats) (if not admin)
                        // ### FIX: Removed admin check, but kept role check ###
                        if (state.currentUser.role === 'student' || state.currentUser.role === 'teacher') {
                            const quizResultsDocRef = doc(db, QUIZ_RESULTS_COLLECTION_PATH, stableId);
                            await setDoc(quizResultsDocRef, {
                                profilePicUrl: base64Url,
                                userId: stableId,
                                name: state.currentUser.name,
                                grade: state.currentUser.grade
                            }, { merge: true });
                            console.log("Profile pic updated in quiz_results.");
                        }

                    } catch (e) {
                        console.error("Failed to update profile pic in Firestore:", e);
                    } finally {
                        setLoading(false); // Move setLoading(false) here
                    }
                } else {
                    console.warn("Cannot save profile pic to Firestore, db or auth not ready.");
                    setLoading(false); // Turn off loading if DB isn't ready
                }
                // *** END NEW PART ***
            } else {
                 setLoading(false); // Turn off loading if no user
            }
        }


        function renderTeacherDashboard() {
            // ### MODIFIED: Reordered Tabs - Removed Payments ###
             const tabs = [
                 { id: 'monitor', label: 'Monitor' },
                 { id: 'announcements', label: 'Announcements' },
                 { id: 'onlineClass', label: 'Online Class' }, // <-- MOVED
                 { id: 'lessons', label: 'Lesson Manager' },
                 { id: 'assignments', label: 'Assignment Manager' },
                 { id: 'quizEditor', label: 'Quiz Editor' },
                 { id: 'gradeBook', label: 'Grade Book' },
                 // { id: 'payments', label: 'Payments' }, // REMOVED
             ];
            // ### END MODIFICATION ###

             let tabContent = '';
             switch (state.dashboardTab) {
                 case 'monitor': tabContent = renderTeacherMonitor(); break;
                 case 'announcements': tabContent = renderAnnouncementsManager(); break;
                 case 'lessons': tabContent = renderLessonBookManager(); break;
                 case 'assignments': tabContent = renderAssignmentManager(); break;
                 case 'viewSubmissions': tabContent = renderViewSubmissions(); break; // Special tab
                 case 'quizEditor': tabContent = renderQuizEditor(); break;
                 case 'gradeBook': tabContent = renderTeacherGradeBook(); break;
                 // case 'payments': tabContent = renderPaymentManager(); break; // REMOVED
                 case 'onlineClass': tabContent = renderOnlineClassTab(); break;
                 // ### NEW: Add this case back ###
                 case 'gradeMeeting': tabContent = renderMeetingGradingPage(); break;
                 default: tabContent = renderTeacherMonitor();
             }
             
             // Check for special breadcrumb views
             if (state.dashboardTab === 'viewSubmissions') {
                  return `
                      <div class="mb-4 text-sm">
                          <button data-action="set-dashboard-tab" data-tab="assignments" class="text-emerald-600 hover:underline">Assignment Manager</button>
                          <span class="text-gray-500 mx-2">/</span>
                          <span class="text-gray-700 font-medium">Submissions for "${state.selectedAssignment?.title || 'Assignment'}"</span>
                      </div>
                      ${tabContent}
                  `;
             }
             
             // ### NEW: Add this breadcrumb logic ###
             if (state.dashboardTab === 'gradeMeeting') {
                 const meeting = state.allMeetings.find(m => m.id === state.selectedMeetingForGradingId);
                  return `
                      <div class="mb-4 text-sm">
                          <button data-action="set-dashboard-tab" data-tab="onlineClass" class="text-emerald-600 hover:underline">Online Class</button>
                          <span class="text-gray-500 mx-2">/</span>
                          <span class="text-gray-700 font-medium">Grade Participation for "${meeting?.topic || 'Class'}"</span>
                      </div>
                      ${tabContent}
                  `;
             }
             // ### END NEW BREADCRUMB LOGIC ###
             
             return `
                 <!-- Tab Navigation -->
                 <div class="mb-6 border-b border-gray-200">
                     <nav class="flex flex-wrap -mb-px space-x-6" aria-label="Tabs">
                         ${tabs.map(function(tab) { return `
                             <button data-action="set-dashboard-tab" data-tab="${tab.id}"
                                     class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === tab.id ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                 ${tab.label}
                             </button>
                         `}).join('')}
                     </nav>
                 </div>
                 <!-- Tab Content -->
                 <div id="teacher-tab-content">
                     ${tabContent}
                 </div>
             `;
        }

        // --- NEW: Admin Dashboard Renderer ---
        function renderAdminDashboard() {
             const tabs = [
                 { id: 'accountManager', label: 'Account Manager' },
                 { id: 'subjectManager', label: 'Subject Manager' }, // <-- NEW
                 { id: 'payments', label: 'Payments Control' } // ### MODIFIED: Added Payments ###
             ];

             let tabContent = '';
             switch (state.dashboardTab) {
                 case 'accountManager': tabContent = renderAccountManager(); break;
                 case 'subjectManager': tabContent = renderSubjectManager(); break; // <-- NEW
                 case 'payments': tabContent = renderPaymentManager(); break; // ### MODIFIED: Added Payments ###
                 default: tabContent = renderAccountManager();
             }

             return `
                 <!-- Tab Navigation -->
                 <div class="mb-6 border-b border-gray-200">
                     <nav class="flex flex-wrap -mb-px space-x-6" aria-label="Tabs">
                         ${tabs.map(function(tab) { return `
                             <button data-action="set-dashboard-tab" data-tab="${tab.id}"
                                     class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${state.dashboardTab === tab.id ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700'}">
                                 ${tab.label}
                             </button>
                         `}).join('')}
                     </nav>
                 </div>
                 <!-- Tab Content -->
                 <div id="admin-tab-content">
                     ${tabContent}
                 </div>
             `;
        }

        // --- NEW: Admin Account Manager Renderer ---
        function renderAccountManager() {
            const users = state.allUserProfiles; // Fetched by listener
            return `
                 <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-5 border-b pb-3 gap-3">
                         <h2 class="text-2xl font-bold text-gray-800">Account Manager</h2>
                         <div class="flex gap-2">
                             <button data-action="seed-users" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 shadow-md">
                                 Seed Initial Users
                             </button>
                             <button data-action="open-user-modal" class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 shadow-md">
                                 + Create New Account
                             </button>
                         </div>
                     </div>

                     <p class="text-sm text-gray-600 mb-4">
                         Click "Seed Initial Users" once to populate the database from the original code.
                         New accounts can be created, and existing accounts can be activated or deactivated.
                     </p>

                     <!-- User List -->
                     <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade</th>
                                     <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                     <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                 </tr>
                             </thead>
                             <tbody class="bg-white divide-y divide-gray-200">
                                 ${users.map(function(user) {
                                     const isActive = user.status === 'active';
                                     return `
                                         <tr class="hover:bg-gray-50">
                                             <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.username}</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${user.role}</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.grade || 'N/A'}</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                                 <button data-action="toggle-user-status" data-id="${user.username}" data-status="${user.status}"
                                                         class="px-3 py-1 rounded-full text-xs font-semibold
                                                         ${isActive ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-red-100 text-red-800 hover:bg-red-200'}">
                                                     ${isActive ? 'Active' : 'Inactive'}
                                                 </button>
                                             </td>
                                             <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                 <button data-action="open-user-modal" data-id="${user.username}" class="text-blue-600 hover:text-blue-900">Edit</button>
                                                 <button data-action="delete-user" data-id="${user.username}" class="text-red-600 hover:text-red-900">Delete</button>
                                             </td>
                                         </tr>
                                     `;
                                 }).join('')}
                             </tbody>
                         </table>
                     </div>
                 </div>
            `;
        }

        // --- NEW: Admin User Creation Modal ---
        function renderUserModal() {
            const user = state.editingUser;
            const isEditing = state.isEditingUser;
            
            return `
                 <div class="modal flex fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
                     <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-screen overflow-hidden flex flex-col card">
                         <div class="flex justify-between items-center p-5 border-b">
                             <h2 class="text-2xl font-bold text-gray-800">${isEditing ? 'Edit User Account' : 'Create New Account'}</h2>
                             <button data-action="close-user-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
                         </div>
                         <form id="userForm" class="flex-grow overflow-y-auto p-6 space-y-4">
                             <input type="hidden" name="userId" value="${user?.username || ''}">
                             <div>
                                 <label for="userName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                 <input type="text" id="userName" name="userName" required class="input-field mt-1" value="${user?.name || ''}">
                             </div>
                             <div>
                                 <label for="userUsername" class="block text-sm font-medium text-gray-700">Username</label>
                                 <input type="text" id="userUsername" name="userUsername" required ${isEditing ? 'disabled' : ''} class="input-field mt-1 ${isEditing ? 'bg-gray-100' : ''}" value="${user?.username || ''}">
                                 ${isEditing ? '<p class="text-xs text-gray-500 mt-1">Username cannot be changed after creation.</p>' : ''}
                             </div>
                             <div>
                                 <label for="userPassword" class="block text-sm font-medium text-gray-700">Password</label>
                                 <input type="text" id="userPassword" name="userPassword" required class="input-field mt-1" value="${user?.password || ''}">
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="userRole" class="block text-sm font-medium text-gray-700">Role</label>
                                    <select id="userRole" name="userRole" required class="input-field mt-1">
                                        <option value="student" ${user?.role === 'student' ? 'selected' : ''}>Student</option>
                                        <option value="teacher" ${user?.role === 'teacher' ? 'selected' : ''}>Teacher</option>
                                        <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                </div>
                                 <div>
                                     <label for="userGrade" class="block text-sm font-medium text-gray-700">Grade (if student)</label>
                                      <select id="userGrade" name="userGrade" class="input-field mt-1">
                                          ${getGradeLevelOptions(user?.grade || '')}
                                      </select>
                                 </div>
                             </div>
                             <div>
                                 <label for="userProfilePicUrl" class="block text-sm font-medium text-gray-700">Profile Pic URL (Optional)</label>
                                 <!-- ### NEW: Profile Pic Preview & Uploader ### -->
                                 <div class="flex items-center gap-3 mt-1">
                                    <img id="user-modal-pic-preview"
                                         src="${user?.profilePicUrl || 'https://placehold.co/64x64/eeeeee/333333?text=??'}"
                                         alt="Profile Preview"
                                         class="h-16 w-16 rounded-full object-cover border-2 border-gray-200 cursor-pointer hover:opacity-80"
                                         onclick="document.getElementById('adminUserPicUpload').click()">
                                    <input type="file" id="adminUserPicUpload" accept="image/png, image/jpeg" style="display: none;" onchange="handleAdminProfilePicPreview(event)">
                                     
                                    <input type="url" id="userProfilePicUrl" name="userProfilePicUrl" class="input-field flex-grow" placeholder="https://placehold.co/..." value="${user?.profilePicUrl || ''}">
                                 </div>
                                 <p class="text-xs text-gray-500 mt-1">Click the image to upload a new one, or paste a URL.</p>
                                 <!-- ### END NEW ### -->
                             </div>

                             <!-- ### FIX: ADDING MISSING CUSTOM SUBJECTS FIELD ### -->
                             <div>
                                 <label for="userCustomSubjects" class="block text-sm font-medium text-gray-700">Custom Subjects (Optional)</label>
                                 <input type="text" id="userCustomSubjects" name="userCustomSubjects" class="input-field mt-1" placeholder="e.g., CLE, Research, Computer" value="${user?.customSubjects ? user.customSubjects.join(', ') : ''}">
                                 <p class="text-xs text-gray-500 mt-1">Comma-separated list. These will be added to the student's grade book.</p>
                             </div>
                             <!-- ### END FIX ### -->
                             
                             <div id="user-modal-error" class="text-sm font-medium text-red-500" role="alert"></div>
                             
                             <div class="flex justify-end space-x-3 pt-4 border-t">
                                 <button type="button" data-action="close-user-modal" class="px-5 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200">Cancel</button>
                                 <button type="submit" class="px-5 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-md">Save Account</button>
                             </div>
                         </form>
                     </div>
                 </div>
             `;
        }

        // --- NEW: Admin Subject Manager Renderer ---
        function renderSubjectManager() {
            const subjects = (state.masterSubjectList && state.masterSubjectList.length > 0) ? state.masterSubjectList : INITIAL_MASTER_SUBJECT_LIST;
            
            return `
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add Subject Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card h-fit">
                         <h2 class="text-2xl font-bold text-gray-800 mb-4">Add New Subject</h2>
                         <p class="text-sm text-gray-600 mb-4">
                             Add a new subject to the master list. This subject will then be available when selecting "All Grades" for lessons, quizzes, and assignments.
                         </p>
                         <form id="add-subject-form" class="space-y-4">
                             <div>
                                 <label for="newSubjectName" class="block text-sm font-medium text-gray-700">New Subject Name</label>
                                 <input type="text" id="newSubjectName" name="newSubjectName" required class="input-field mt-1" placeholder="e.g., Computer Science">
                             </div>
                             <div id="subject-manager-error" class="text-sm font-medium text-red-500" role="alert"></div>
                             <button type="submit" data-action="add-new-subject" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 shadow-md">
                                 Add Subject
                             </button>
                         </form>
                    </div>
                    
                    <!-- Current List Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Master Subject List</h2>
                        <div class="max-h-96 overflow-y-auto">
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                                ${subjects.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                 </div>
            `;
        }

        // --- NEW: Admin Subject Management Function ---
        async function handleAddNewSubject(event) {
            event.preventDefault();
            if (!db) { console.error("Firestore not initialized"); return; }
            
            const form = event.target.closest('form');
            const subjectNameInput = form.querySelector('#newSubjectName');
            const errorDiv = form.querySelector('#subject-manager-error');
            const subjectName = subjectNameInput.value.trim();
            
            errorDiv.innerText = '';
            
            if (!subjectName) {
                errorDiv.innerText = "Subject name cannot be empty.";
                return;
            }
            
            const currentList = (state.masterSubjectList && state.masterSubjectList.length > 0) ? state.masterSubjectList : INITIAL_MASTER_SUBJECT_LIST;
            
            if (currentList.find(s => s.toLowerCase() === subjectName.toLowerCase())) {
                errorDiv.innerText = "This subject already exists in the list.";
                return;
            }
            
            setLoading(true);
            try {
                const newList = [...currentList, subjectName].sort();
                const subjectDocRef = doc(db, SUBJECTS_CONFIG_PATH);
                await setDoc(subjectDocRef, { list: newList }, { merge: true }); // Use setDoc to be safe
                
                console.log("Subject list updated. Added:", subjectName);
                subjectNameInput.value = ''; // Clear input
                // The onSnapshot listener will update the state and re-render
                
            } catch (error) {
                console.error("Error adding new subject:", error);
                errorDiv.innerText = "Error: " + error.message;
            } finally {
                setLoading(false);
            }
        }

        // --- NEW: Admin Account Management Functions ---

        async function handleSeedUsers() {
            if (!db) { console.error("Firestore not initialized"); return; }
            console.log("Seeding initial users...");
            setLoading(true);
            try {
                let count = 0;
                for (const user of INITIAL_SEED_USERS) {
                    const userDocRef = doc(db, USER_PROFILES_COLLECTION_PATH, user.username);
                    // Set with merge:true to avoid overwriting existing users if run again
                    // Add the 'status: active' field
                    // --- SYNTAX FIX: Replaced spread operator ---
                    await setDoc(userDocRef, Object.assign({}, user, {status: 'active'}), { merge: true });
                    count++;
                }
                console.log("Successfully seeded " + count + " users.");
            } catch (error) {
                console.error("Error seeding users:", error);
            } finally {
                setLoading(false);
            }
        }

        function openUserModal(username = null) {
            if (username) {
                state.isEditingUser = true;
                state.editingUser = JSON.parse(JSON.stringify(state.allUserProfiles.find(function(u) { return u.username === username }))) || null;
            } else {
                state.isEditingUser = false;
                state.editingUser = { name: '', username: '', password: '', role: 'student', grade: '', profilePicUrl: '', status: 'active' };
            }
            state.isUserModalOpen = true;
            renderApp();
        }

        function closeUserModal() {
            state.isUserModalOpen = false;
            state.isEditingUser = false;
            state.editingUser = null;
            renderApp();
        }

        async function handleSaveUser(event) {
            event.preventDefault();
            if (!db) { console.error("Firestore not initialized"); return; }
            setLoading(true);
            
            const form = event.target;
            const username = form.userUsername.value.trim();
            const errorDiv = document.getElementById('user-modal-error');
            errorDiv.innerText = '';
            
            if (!username) {
                errorDiv.innerText = "Username is required.";
                setLoading(false);
                return;
            }
            
            try {
                // --- ### FIX: Added missing custom subject parser ### ---
                const customSubjectsRaw = form.userCustomSubjects.value || '';
                const customSubjectsArray = customSubjectsRaw.split(',')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
                // --- ### END FIX ### ---

                const userData = {
                    name: form.userName.value,
                    username: username,
                    password: form.userPassword.value, // Note: Storing password in plain text is not secure for a real app.
                    role: form.userRole.value,
                    grade: form.userGrade.value || null,
                    profilePicUrl: form.userProfilePicUrl.value || 'https://placehold.co/64x64/eeeeee/333333?text=' + username.substring(0,2).toUpperCase(),
                    status: state.isEditingUser ? state.editingUser.status : 'active', // Preserve status on edit, default to active on create
                    // --- ### FIX: Added customSubjects to the user object ### ---
                    customSubjects: customSubjectsArray.length > 0 ? customSubjectsArray : null
                };

                const userDocRef = doc(db, USER_PROFILES_COLLECTION_PATH, username);
                
                if (!state.isEditingUser) {
                    // Check if user already exists on create
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        errorDiv.innerText = "This username already exists. Please choose another.";
                        setLoading(false);
                        return;
                    }
                }
                
                // Use setDoc to create or overwrite
                await setDoc(userDocRef, userData);
                console.log("User " + (state.isEditingUser ? 'updated' : 'created') + ": " + username);
                
                // --- ### NEW: Sync profile pic to quiz_results collection ### ---
                // This ensures the student's grade book and other views reflect the new pic.
                if (userData.role === 'student' || userData.role === 'teacher') {
                    const quizResultsDocRef = doc(db, QUIZ_RESULTS_COLLECTION_PATH, username);
                    await setDoc(quizResultsDocRef, {
                        profilePicUrl: userData.profilePicUrl,
                        userId: username,
                        name: userData.name,
                        grade: userData.grade
                    }, { merge: true });
                    console.log("Profile pic synced to quiz_results for " + username);
                }
                // --- ### END NEW ### ---
                
                closeUserModal();
                
            } catch (error) {
                console.error("Error saving user:", error);
                errorDiv.innerText = 'Error: ' + error.message;
            } finally {
                setLoading(false);
            }
        }

        async function handleToggleUserStatus(username, currentStatus) {
            if (!db) { console.error("Firestore not initialized"); return; }
            
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            console.log("Changing status for " + username + " to " + newStatus);
            setLoading(true);
            try {
                const userDocRef = doc(db, USER_PROFILES_COLLECTION_PATH, username);
                await updateDoc(userDocRef, { status: newStatus });
            } catch (error) {
                console.error("Error toggling user status:", error);
            } finally {
                setLoading(false);
            }
        }

        async function handleDeleteUser(username) {
            if (!db) { console.error("Firestore not initialized"); return; }
            
            // Bypass confirm dialog
            console.log("Deleting user: " + username);
            setLoading(true);
            try {
                const userDocRef = doc(db, USER_PROFILES_COLLECTION_PATH, username);
                await deleteDoc(userDocRef);
                // Note: This does not delete their quiz_results data, just their login.
            } catch (error) {
                console.error("Error deleting user:", error);
            } finally {
                setLoading(false);
            }
        }
        
        // --- END: Admin Functions ---


        function renderAnnouncementsForStudent(relevantAnnouncements, recentReminders = []) {
             return `
                 <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Announcements</h2>
                     <div class="space-y-5 max-h-[50vh] overflow-y-auto">
                         ${recentReminders.length > 0 ? recentReminders.map(function(rem) {
                            const status = rem.paymentStatus || 'No Payment';
                            let cardClass = 'bg-red-50 border-red-200';
                            let titleClass = 'text-red-800';
                            let tagClass = 'bg-red-200 text-red-700';
                            let tagText = 'Urgent'; // Default for Overdue/No Payment

                            if (status === 'Pending') {
                                cardClass = 'bg-yellow-50 border-yellow-200';
                                titleClass = 'text-yellow-800';
                                tagClass = 'bg-yellow-200 text-yellow-700';
                                tagText = 'Pending';
                            } else if (status === 'Paid') {
                                cardClass = 'bg-green-50 border-green-200';
                                titleClass = 'text-green-800';
                                tagClass = 'bg-green-200 text-green-700';
                                tagText = 'Paid';
                            }
                            // 'No Payment' and 'Overdue' will use the default red
                            
                            return `
                                <div class="p-4 rounded-lg border shadow-sm ${cardClass}">
                                    <div class="flex justify-between items-center mb-1">
                                        <h3 class="text-lg font-semibold ${titleClass}">Payment Reminder</h3>
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${tagClass}">${tagText}</span>
                                    </div>
                                    <p class="text-sm text-gray-700 mb-2">This is a reminder for your payment session from <strong>${new Date(rem.sessionStartDate.toDate()).toLocaleDateString()}</strong> to <strong>${new Date(rem.sessionEndDate.toDate()).toLocaleDateString()}</strong>.</p>
                                    <p class="text-sm text-gray-700">Status: <span class="font-bold">${rem.paymentStatus}</span></p>
                                    <p class="text-xs text-gray-500 text-right mt-2">
                                        (Sent on ${new Date(rem.reminderSentTimestamp.toDate()).toLocaleDateString()})
                                    </p>
                                </div>
                             `;
                         }).join('') : ''}
                     
                         ${relevantAnnouncements.length > 0 ? relevantAnnouncements.map(function(ann) { return `
                             <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200 shadow-sm">
                                 <div class="flex justify-between items-center mb-1">
                                     <h3 class="text-lg font-semibold text-emerald-800">${ann.title}</h3>
                                     ${ann.gradeLevel !== 'All' ? '<span class="px-2 py-0.5 bg-emerald-200 text-emerald-700 rounded-full text-xs font-medium">' + (ann.gradeLevel.startsWith('Kinder') ? ann.gradeLevel : 'Grade ' + ann.gradeLevel) + '</span>' : ''}
                                 </div>
                                 <p class="text-sm text-gray-700 mb-2 whitespace-pre-wrap">${ann.content}</p>
                                 <p class="text-xs text-gray-500 text-right">
                                     &mdash; ${ann.teacherName} (${new Date(ann.timestamp?.toDate() || Date.now()).toLocaleDateString()})
                                 </p>
                             </div>
                         `}).join('') : `
                             ${recentReminders.length === 0 ? '<p class="text-sm text-gray-500 text-center py-4">No announcements for your grade level right now.</p>' : ''}
                         `}
                     </div>
                 </div>
             `;
         }

        function renderStudentQuizList() {
             const grade = state.currentUser.grade;
             // Task 2: Get subjects based on student's grade
             // const subjectsForGrade = subjectMap[String(grade)] || []; // OLD
             
             // --- FIX: Get subjects student is *actually* enrolled in ---
             const enrolledSubjects = getEnrolledSubjects(state.currentUser);
             const studentGradeStr = String(grade);
             
             const quizzesForStudent = state.allQuizzes
                .filter(function(q) {
                    // Content must match student's grade (or 'All')
                    const isMatchingGrade = (String(q.gradeLevel) === studentGradeStr || q.gradeLevel === 'All');
                    // Content must be for a subject the student is enrolled in
                    const isEnrolledSubject = enrolledSubjects.includes(q.subject);
                    // --- FIX: Show content if it's for their grade AND an enrolled subject ---
                    return isMatchingGrade && isEnrolledSubject && q.status !== 'archived';
                })
                .sort(function(a, b) { return (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0) }); // Show newest first

             return `
                 <div class="bg-white rounded-xl p-6 shadow-lg card">
                      <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Available Quizzes</h2>
                      ${quizzesForStudent.length === 0 ? '<p class="text-gray-500">No quizzes are available for your enrolled subjects and grade level right now.</p>' : ''}
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                         ${quizzesForStudent.map(function(quiz) {
                             // NEW: Calculate stats specifically for this quiz.id
                             const subjectStats = state.studentStats[quiz.subject];
                             // Ensure attempts exist before filtering
                             const attemptsForThisQuiz = subjectStats ? (subjectStats.attempts || []).filter(function(a) { return a.quizId === quiz.id }) : [];
                             const attemptsCount = attemptsForThisQuiz.length;
                             
                             let bestScore = null;
                             let totalItems = quiz.questions?.length || 0; // Default to quiz length

                             if (attemptsCount > 0) {
                                 // --- SYNTAX FIX: Replaced spread operator ---
                                 const bestAttempt = attemptsForThisQuiz.slice().sort(function(a,b) { return b.score - a.score })[0];
                                 bestScore = bestAttempt.score;
                                 totalItems = bestAttempt.totalItems; // Get totalItems from the attempt
                             }

                             const key = 'unfinishedQuiz_' + state.currentUser.username + '_' + quiz.id; // CHANGED: Use quiz.id
                             let hasUnfinished = false;
                             try { hasUnfinished = localStorage.getItem(key) !== null; } catch(e){}

                             return `
                                 <div class="subject-card rounded-xl border border-gray-200 bg-gray-50 p-5 shadow-sm">
                                     <h3 class="text-xl font-semibold text-gray-800">${quiz.title || quiz.subject}</h3>
                                     <p class="text-sm text-gray-500">${quiz.subject}</p>
                                     ${attemptsCount > 0 ? `
                                         <p class="text-sm text-gray-600 mt-2">
                                             Best Score: <span class="font-bold ${bestScore > (totalItems * 0.8) ? 'text-green-600' : 'text-gray-700'}">${bestScore} / ${totalItems}</span>
                                         </p>
                                         <p class="text-xs text-gray-500">Attempts: ${attemptsCount}</p>
                                     ` : `
                                         <p class="text-sm text-gray-500 mt-2">No attempts yet.</p>
                                     `}
                                     ${quiz.questions?.length > 0 ? `
                                         <div class="flex space-x-2 mt-4">
                                             <button data-action="start-new-quiz" data-id="${quiz.id}" class="flex-1 px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-md hover:bg-emerald-700 shadow-sm transition-colors">
                                                 Start New Quiz
                                             </button>
                                             ${hasUnfinished ? `
                                                 <button data-action="continue-quiz" data-id="${quiz.id}" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300 shadow-sm transition-colors">
                                                     Continue
                                                 </button>
                                             ` : ''}
                                         </div>
                                     ` : `
                                         <p class="text-sm text-gray-400 mt-4">Quiz not yet available.</p>
                                     `}
                                 </div>
                             `;
                         }).join('')}
                     </div>
                 </div>
             `;
         }

        function renderStudentLessonsListForTab() {
             const grade = state.currentUser.grade;
             // Task 2: Filter lessons based on grade-specific subjects
             // const subjectsForGrade = subjectMap[String(grade)] || []; // OLD
             // --- FIX: Get subjects student is *actually* enrolled in ---
             const enrolledSubjects = getEnrolledSubjects(state.currentUser);
             const studentGradeStr = String(grade);
             
             const relevantLessons = state.lessonBooks.filter(function(lb) {
                const isMatchingGrade = (lb.gradeLevel === 'All' || String(lb.gradeLevel) === String(grade));
                const isEnrolledSubject = enrolledSubjects.includes(lb.subject);
                // --- FIX: Show content if it's for their grade AND an enrolled subject ---
                // (Also include untagged subjects if they match the grade)
                return (isMatchingGrade && (isEnrolledSubject || !lb.subject)) &&
                       lb.status !== 'archived';
             });

             return `
                 <div class="bg-white rounded-xl p-6 shadow-lg card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Lessons</h2>
                      ${relevantLessons.length === 0 ? '<p class="text-gray-500">No lessons are available for your enrolled subjects and grade level right now.</p>' : ''}
                     <div class="space-y-4">
                         ${relevantLessons.map(function(lesson) {
                             const progress = state.lessonBookProgress[lesson.id];
                             const questions = lesson.slides?.filter(function(s) { return s.type === 'QUESTION' && s.question && s.question.trim() !== '' }); // Task 2.3
                             const totalQuestions = questions?.length || 0;
                             const bestScore = progress?.bestScore ?? null;

                             return `
                                 <div class="flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm gap-3">
                                     <div>
                                         <h3 class="text-lg font-semibold text-gray-800">${lesson.title}</h3>
                                         <p class="text-sm text-gray-500">Subject: ${lesson.subject || 'N/A'}</p>
                                         ${bestScore !== null ? `
                                             <p class="text-sm text-green-700 font-medium">Completed! Best Score: ${bestScore}/${totalQuestions}</p>
                                         ` : (progress && progress.answers?.length > 0 ? `
                                             <p class="text-sm text-blue-600 font-medium">In Progress...</p>
                                         ` : `
                                             <p class="text-sm text-gray-500">Not started.</p>
                                         `)}
                                     </div>
                                     <div class="flex space-x-2">
                                         <button data-action="view-lesson" data-id="${lesson.id}" class="px-5 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 shadow-sm transition-colors">
                                             ${bestScore !== null ? 'View' : (progress && progress.answers?.length > 0 ? 'Continue' : 'Start Lesson')}
                                         </button>
                                         <!-- NEW: Retake Button -->
                                         ${bestScore !== null ? `
                                             <button data-action="retake-lesson" data-id="${lesson.id}" class="px-5 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300 shadow-sm transition-colors">
                                                 Retake Lesson
                                             </button>
                                         ` : ''}
                                     </div>
                                 </div>
                             `;
                         }).join('')}
                     </div>
                 </div>
             `;
         }

        function renderStudentAssignmentsListForTab() {
            const grade = state.currentUser.grade;
            // Task 2: Filter assignments based on grade-specific subjects
            // const subjectsForGrade = subjectMap[String(grade)] || []; // OLD
            // --- FIX: Get subjects student is *actually* enrolled in ---
            const enrolledSubjects = getEnrolledSubjects(state.currentUser);
            const studentGradeStr = String(grade);
            
            const relevantAssignments = state.assignments.filter(function(a) {
                const isMatchingGrade = (a.gradeLevel === 'All' || String(a.gradeLevel) === String(grade));
                const isEnrolledSubject = enrolledSubjects.includes(a.subject);
                // --- FIX: Show content if it's for their grade AND an enrolled subject ---
                // (Also include untagged subjects if they match the grade)
                return (isMatchingGrade && (isEnrolledSubject || !a.subject)) &&
                       a.status !== 'archived';
            });

             return `
                 <div class="bg-white rounded-xl p-6 shadow-lg card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Assignments</h2>
                      ${relevantAssignments.length === 0 ? '<p class="text-gray-500">No assignments are available for your enrolled subjects and grade level right now.</p>' : ''}
                     <div class="space-y-4">
                         ${relevantAssignments.map(function(assignment) {
                             const submission = state.myAssignmentSubmissions[assignment.id];
                             const dueDate = assignment.dueDate ? new Date(assignment.dueDate.toDate()) : null; // Use .toDate()
                             const isPastDue = dueDate && (dueDate.getTime() + 86400000) < Date.now(); // Add 24h grace
                             const grade = submission?.grade; // Task 4:const grade = submission?.grade; // Task 4: Get grade

                             return `
                                 <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                                     <div>
                                         <h3 class="text-lg font-semibold text-gray-800">${assignment.title}</h3>
                                         <p class="text-sm text-gray-500">Subject: ${assignment.subject || 'N/A'}</p>
                                         ${dueDate ? `
                                             <p class="text-sm ${isPastDue && !submission ? 'text-red-600 font-medium' : 'text-gray-500'}">
                                                 Due: ${dueDate.toLocaleDateString()}
                                             </p>
                                         `: ''}
                                         ${submission ? `
                                             <p class="text-sm text-green-700 font-medium">Submitted ${submission.submissionTimestamp ? new Date(submission.submissionTimestamp.toDate()).toLocaleString() : ''}</p>
                                         ` : (isPastDue ? `
                                             <p class="text-sm text-red-600 font-medium">Missing</p>
                                         ` : `
                                             <p class="text-sm text-gray-500">Not submitted.</p>
                                         `)}
                                         ${(grade !== undefined && grade !== null) ? `
                                             <p class="text-sm text-emerald-700 font-bold">Grade: ${grade} / 100</p>
                                         ` : (submission ? `
                                             <p class="text-sm text-gray-500">Awaiting grade...</p>
                                         ` : ``)}
                                     </div>
                                     <button data-action="view-assignment" data-id="${assignment.id}" class="px-5 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 shadow-sm transition-colors">
                                         ${submission ? 'View/Resubmit' : 'View Assignment'}
                                     </button>
                                 </div>
                             `;
                         }).join('')}
                     </div>
                 </div>
             `;
        }
        
        // --- NEW: Render function for Online Class tab ---
        function renderOnlineClassTab() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left/Main Column: Meeting List -->
                    <div class="lg:col-span-2">
                        ${renderMeetingList()}</div>
                    
                    <!-- Right Column: Create Form (Teacher only) -->
                    <div class="lg:col-span-1">
                        ${state.currentUser.role === 'teacher' ? renderCreateMeetingForm() : ''}
                    </div>
                </div>
            `;
        }

        // --- NEW: Render function for Create Meeting Form ---
        function renderCreateMeetingForm() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 card sticky top-24">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Create New Class</h2>
                    <form id="create-meeting-form" class="space-y-4">
                        <div>
                            <label for="roomTopic" class="block text-sm font-medium text-gray-700">Class Topic / Name</label>
                            <input type="text" id="roomTopic" name="roomTopic" required class="input-field mt-1" placeholder="e.g., Grade 3 Math Review">
                        </div>
                        
                        <!-- ### NEW: Grade and Subject Selectors ### -->
                        <!-- ### MODIFIED: Changed to 3-col grid ### -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="gradeLevel" class="block text-sm font-medium text-gray-700">Grade Level</label>
                                <select id="gradeLevel" name="gradeLevel" class="input-field mt-1" onchange="updateSubjectDropdown('gradeLevel', 'subject')">
                                    ${getGradeLevelOptions('')} <!-- Default to 'N/A' -->
                                </select>
                            </div>
                            <div>
                                <label for="subject" class="block text-sm font-medium text-gray-700">Subject</label>
                                <select id="subject" name="subject" class="input-field mt-1">
                                    ${getSubjectOptions('', null)} <!-- Start with subjects for 'N/A' (which is empty) -->
                                </select>
                            </div>
                            <!-- ### NEW: Quarter Dropdown ### -->
                            <div>
                                <label for="quarter" class="block text-sm font-medium text-gray-700">Quarter</label>
                                <select id="quarter" name="quarter" class="input-field mt-1">
                                    ${getQuarterOptions('Q1')} <!-- Default to Q1 -->
                                </select>
                            </div>
                        </div>

                        <!-- ### NEW: Schedule Time ### -->
                        <div>
                            <label for="startTime" class="block text-sm font-medium text-gray-700">Schedule Time (Optional)</label>
                            <input type="datetime-local" id="startTime" name="startTime" class="input-field mt-1">
                        </div>
                        
                        <!-- ### NEW: Participant Multi-select ### -->
                        <div>
                            <label for="participants" class="block text-sm font-medium text-gray-700">Invite Specific Students (Optional)</label>
                            <!-- ### MODIFICATION: Removed text about grading ### -->
                            <p class="text-xs text-gray-500 mb-1">Select students to invite. This will help filter the class list for students.</p>
                            <select id="participants" name="participants" multiple class="input-field mt-1 h-32">
                                ${getStudentOptions(null)}
                            </select>
                        </div>
                        
                        <!-- ### NEW: External Link ### -->
                        <div>
                            <label for="externalLink" class="block text-sm font-medium text-gray-700">External Link (Optional)</label>
                            <input type="url" id="externalLink" name="externalLink" class="input-field mt-1" placeholder="https://meet.google.com/...">
                            <p class="text-xs text-gray-500 mb-1">If you add a link, this will be posted instead of starting a Jitsi class.</p>
                        </div>

                        <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 shadow-md">
                            Post / Start Class
                        </button>
                    </form>
                </div>
            `;
        }

        // --- NEW: Render function for Meeting List ---
        // --- NEW: Render function for Meeting List ---
        function renderMeetingList() {
            const isStudent = state.currentUser.role === 'student';
            const isTeacher = state.currentUser.role === 'teacher';
            
            // ### NEW: Filter logic for students (from user's query) ###
            let meetingsToShow = state.allMeetings;
            if (isStudent) {
                const studentGrade = String(state.currentUser.grade);
                const studentUsername = state.currentUser.username;
                
                // --- MODIFICATION: Added subject filtering ---
                const enrolledSubjects = getEnrolledSubjects(state.currentUser); // Get student's subjects
                
                meetingsToShow = state.allMeetings.filter(meeting => {
                    const isInvited = meeting.participants && meeting.participants.includes(studentUsername);
                    
                    // Check if grade is set, not 'N/A' ('')
                    const isForMyGrade = meeting.gradeLevel && meeting.gradeLevel !== '' && (meeting.gradeLevel === 'All' || String(meeting.gradeLevel) === studentGrade);
                    
                    // Check if subject matches (or if no subject is specified for the meeting)
                    const isForMySubject = !meeting.subject || enrolledSubjects.includes(meeting.subject);
                    
                    // Show if explicitly invited OR if it's for their grade AND a matching subject (or no subject)
                    return isInvited || (isForMyGrade && isForMySubject);
                });
                // --- END MODIFICATION ---
            }
            // Teachers and Admins see all meetings by default
            
            // ### NEW: Split into Active and Past meetings (from user's query) ###
            const activeMeetings = [];
            const pastMeetings = [];
            const now = new Date();
            const threeHours = 3 * 60 * 60 * 1000;

            meetingsToShow.forEach(meeting => {
                if (meeting.status === 'ended') {
                    pastMeetings.push(meeting);
                } else {
                    const startTime = meeting.startTime?.toDate();
                    // If scheduled time is significantly past (more than 3 hours), treat as past class even if not explicitly 'ended'
                    if (startTime && (now.getTime() - startTime.getTime()) >= threeHours) {
                        pastMeetings.push(meeting);
                    } else {
                        activeMeetings.push(meeting); // All non-ended meetings
                    }
                }
            });
            
            // Sort active meetings: live ones first, then scheduled
            activeMeetings.sort((a, b) => {
                const aStartTime = a.startTime?.toDate();
                const bStartTime = b.startTime?.toDate();
                
                // isLive logic
                const aIsLive = aStartTime ? (aStartTime.getTime() < now.getTime() && (now.getTime() - aStartTime.getTime()) < threeHours) : (a.meetingType === 'jitsi' && a.status !== 'ended');
                const bIsLive = bStartTime ? (bStartTime.getTime() < now.getTime() && (now.getTime() - bStartTime.getTime()) < threeHours) : (b.meetingType === 'jitsi' && b.status !== 'ended');

                if (aIsLive && !bIsLive) return -1; // a (live) comes before b (not live)
                if (!aIsLive && bIsLive) return 1; // b (live) comes before a (not live)
                
                // If both are live or both are scheduled, sort by time
                if (aStartTime && bStartTime) return aStartTime.getTime() - bStartTime.getTime(); // Earliest scheduled first
                if (aStartTime) return -1; // a has time, b doesn't
                if (bStartTime) return 1; // b has time, a doesn't
                return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0); // Fallback to creation time (newest first)
            });
            // Past meetings are sorted by creation time descending (newest first)
            pastMeetings.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            return `
                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Active & Scheduled Classes</h2>
                    
                    <!-- ### NEW: Permission Error Display (from user's query) ### -->
                    ${state.mediaPermissionError ? `
                        <div class="p-4 mb-4 bg-red-100 border border-red-300 text-red-800 rounded-lg text-sm" role="alert">
                            <strong>Permission Error:</strong> ${state.mediaPermissionError}
                        </div>
                    ` : ''}

                    <div class="space-y-4">
                        ${activeMeetings.length === 0 ? `
                            <p class="text-gray-500 text-center py-4">There are no active online classes for you right now.</p>
                        ` : ''}
                        
                        ${activeMeetings.map(meeting => {
                            const isExternal = meeting.meetingType === 'external';
                            const startTime = meeting.startTime?.toDate();
                            let isLive = false;
                            
                            if (startTime) {
                                // Class is "LIVE" if start time is in the past and within 3 hours
                                if (startTime.getTime() < now.getTime() && (now.getTime() - startTime.getTime()) < threeHours) {
                                    isLive = true;
                                }
                            } else if (!isExternal && meeting.status !== 'ended') {
                                // Jitsi class without start time is always "LIVE" (old format)
                                isLive = true;
                            }
                            
                            // ### NEW: Calculate Roster Size (from user's query) ###
                            const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;
                            let specificInvites = meeting.participants || [];
                            let gradeInvites = [];
                            if (meeting.gradeLevel && meeting.gradeLevel !== 'All' && meeting.gradeLevel !== '') {
                                gradeInvites = userSource.filter(u => u.role === 'student' && String(u.grade) === String(meeting.gradeLevel)).map(u => u.username);
                            }
                            const allParticipants = specificInvites.concat(gradeInvites);
                            const totalInvited = allParticipants.filter((item, index) => allParticipants.indexOf(item) === index).length; // Unique count
                            // ### END: Calculate Roster Size ###

                            return `
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h3 class="text-lg font-semibold text-gray-800">${meeting.topic}</h3>
                                        ${isLive ? `
                                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-500 text-white animate-pulse">
                                                LIVE
                                            </span>
                                        ` : (startTime ? `
                                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                                Scheduled
                                            </span>
                                        ` : '')}
                                        ${isExternal ? `
                                            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700">
                                                External Link
                                            </span>
                                        ` : ''}
                                    </div>
                                    <p class="text-sm text-gray-500">
                                        Hosted by: <span class="font-medium text-gray-700">${meeting.teacherName}</span>
                                    </p>
                                    <!-- ### NEW: Show Roster Size (from user's query) ### -->
                                    <p class="text-sm text-gray-500">
                                        Roster Size: <span class="font-medium text-gray-700">${totalInvited} student(s)</span>
                                    </p>
                                    ${startTime ? `
                                    <p class="text-sm text-gray-500 font-bold">
                                        Scheduled for: ${startTime.toLocaleString()}
                                    </p>
                                    ` : `
                                    <p class="text-xs text-gray-400">
                                        Started: ${new Date(meeting.createdAt?.toDate() || Date.now()).toLocaleString()}
                                    </p>
                                    `}
                                </div>
                                <!-- ### FIX: ADDED MISSING BUTTONS CONTAINER (from user's query) ### -->
                                <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0 mt-3 sm:mt-0 items-center">
                                    ${isExternal ? `
                                        <!-- ### QUICK FIX START ### -->
                                        ${(isTeacher && state.currentUser.username === meeting.teacherId) ? `
                                            <!-- Add End Class button for external links too -->
                                            <button data-action="end-meeting" data-id="${meeting.id}"
                                                    class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 shadow-sm w-full sm:w-auto">
                                                End Class
                                            </button>
                                        ` : ''}
                                        <!-- Renamed "View Link" to "Join Class" -->
                                        <a href="${meeting.externalLink}" target="_blank" rel="noopener noreferrer"
                                           class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 shadow-sm text-center w-full sm:w-auto">
                                            Join Class
                                        </a>
                                        <!-- ### QUICK FIX END ### -->
                                    ` : `
                                        <!-- Jitsi Buttons -->
                                        ${(isTeacher && state.currentUser.username === meeting.teacherId) ? `
                                            <!-- ### MODIFICATION: Changed "End & Grade" to "End Class" ### -->
                                            <button data-action="end-meeting" data-id="${meeting.id}"
                                                    class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 shadow-sm w-full sm:w-auto">
                                                End Class
                                            </button>
                                        ` : ''}
                                        <button data-action="join-meeting" data-id="${meeting.roomId}" data-topic="${meeting.topic}"
                                                class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 shadow-sm w-full sm:w-auto">
                                            Join Class
                                        </button>
                                    `}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    
                    <!-- ### NEW: Past Classes & Grades ### -->
                    <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-5 border-b pb-3">Recent Classes</h2>
                    <p class="text-sm text-gray-500 -mt-4 mb-4">Showing the 5 most recent classes. All past classes are available in the "My Subjects" tab.</p>
                    <div class="space-y-4">
                        ${pastMeetings.length === 0 ? `
                            <p class="text-gray-500 text-center py-4">No recent past classes found.</p>
                        ` : ''}
                        
                        ${pastMeetings.slice(0, 5).map(meeting => {
                            // ### RE-INTEGRATE: Logic to show grades (from previous version) ###
                            let myGrade = null;
                            const isStudent = state.currentUser.role === 'student';
                            const isTeacher = state.currentUser.role === 'teacher';

                            if (isStudent) {
                                const myUsername = state.currentUser.username;
                                if (meeting.participationGrades && meeting.participationGrades[myUsername] !== undefined) {
                                    myGrade = meeting.participationGrades[myUsername];
                                }
                            }
                            // ### END RE-INTEGRATE ###
                            
                            return `
                            <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 opacity-80">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h3 class="text-lg font-semibold text-gray-700">${meeting.topic}</h3>
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700">
                                            Ended
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-500">
                                        Hosted by: <span class="font-medium text-gray-700">${meeting.teacherName}</span>
                                    </p>
                                    <p class="text-sm text-gray-500">
                                        Class Date: ${new Date(meeting.startTime?.toDate() || meeting.createdAt?.toDate() || Date.now()).toLocaleDateString()}
                                    </p>
                                    
                                    <!-- ### RE-INTEGRATE: Show grade for student (from previous version) ### -->
                                    ${isStudent && myGrade !== null ? `
                                        <p class="text-sm text-emerald-700 font-bold mt-1">
                                            Participation Grade: ${myGrade} / 100
                                        </p>
                                    ` : (isStudent ? `
                                        <p class="text-sm text-gray-500 mt-1">
                                            Participation: (Not Graded)
                                        </p>
                                    ` : '')}
                                    <!-- ### END RE-INTEGRATE ### -->
                                    
                                </div>
                                <div class="flex space-x-2 flex-shrink-0">
                                    <!-- ### RE-INTEGRATE: Show "View/Edit Grades" button for teacher (from previous version) ### -->
                                    ${isTeacher ? `
                                        <button data-action="view-meeting-grades" data-id="${meeting.id}"
                                                class="px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200">
                                            View/Edit Grades
                                        </button>
                                        <!-- ### NEW: Delete Button ### -->
                                        <button data-action="delete-meeting" data-id="${meeting.id}"
                                                class="px-4 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">
                                            Delete
                                        </button>
                                        <!-- ### END NEW ### -->
                                    ` : ''}
                                    <!-- ### END RE-INTEGRATE ### -->
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }
        
        // --- ### REMOVED: Grading Page Render Function ### ---
        // ### NEW: Function to render the participation grading page ###
        function renderMeetingGradingPage() {
            if (!state.selectedMeetingForGradingId) {
                return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">Error: No meeting selected for grading.</div>`;
            }
            
            const meeting = state.allMeetings.find(m => m.id === state.selectedMeetingForGradingId);
            if (!meeting) {
                return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">Error: Meeting data not found.</div>`;
            }
            
            // 1. Build the Roster
            const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;
            const roster = {}; // Use object to de-duplicate
            
            // Add specific participants
            if (meeting.participants) {
                meeting.participants.forEach(userId => {
                    const user = userSource.find(u => u.username === userId && u.role === 'student');
                    if (user) roster[user.username] = user;
                });
            }
            
            // Add all students from the grade level
            if (meeting.gradeLevel && meeting.gradeLevel !== 'All' && meeting.gradeLevel !== '') {
                userSource.forEach(user => {
                    if (user.role === 'student' && String(user.grade) === String(meeting.gradeLevel)) {
                        roster[user.username] = user;
                    }
                });
            }
            
            const rosterList = Object.values(roster).sort((a, b) => a.name.localeCompare(b.name));
            const existingGrades = meeting.participationGrades || {};
            
            if (rosterList.length === 0) {
                return `
                    <div class="bg-white rounded-xl p-6 text-center text-gray-500 card">
                        <p>No students were found for this class's roster (Grade: ${meeting.gradeLevel}, Invited: ${meeting.participants?.length || 0}).</p>
                        <button data-action="set-dashboard-tab" data-tab="onlineClass" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 shadow-md">
                            Back to Online Class
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-5 gap-3">
                        <p class="text-gray-700">Enter participation grade (0-100) for each student.</p>
                        <div class="flex gap-2">
                             <button data-action="set-dashboard-tab" data-tab="onlineClass" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-semibold rounded-lg hover:bg-gray-300">
                                Back
                            </button>
                            <button data-action="save-participation-grades" data-id="${meeting.id}" class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 shadow-md">
                                Save All Grades
                            </button>
                        </div>
                    </div>
                    
                    <div id="grading-feedback" class="text-sm font-medium p-3 rounded-md mb-4" role="alert"></div>
                    
                    <!-- Student Roster for Grading -->
                    <div class="space-y-3">
                        ${rosterList.map(student => {
                            const currentGrade = existingGrades[student.username] !== undefined ? existingGrades[student.username] : '';
                            return `
                                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                    <div class="flex items-center gap-3">
                                        <img src="${student.profilePicUrl || 'https://placehold.co/40x40/eeeeee/333333?text=?'}" alt="Profile" class="w-10 h-10 rounded-full object-cover">
                                        <div>
                                            <p class="font-semibold text-gray-800">${student.name}</p>
                                            <p class="text-xs text-gray-500">${student.username}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label for="grade-input-${student.username}" class="text-sm font-medium text-gray-700">Grade:</label>
                                        <input type="number" id="grade-input-${student.username}" data-userid="${student.username}"
                                               min="0" max="100" class="input-field w-24 text-sm px-2 py-1"
                                               value="${currentGrade}">
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        
        // --- NEW: Renamed from renderMyCourses to renderMySubjects ---
        function renderMySubjects() {
            // --- FIX: Get subjects student is *actually* enrolled in ---
            const enrolledSubjects = getEnrolledSubjects(state.currentUser);
            const studentGradeStr = String(state.currentUser.grade);
            
            // Get all content for the student's grade (DO NOT filter archived)
            const allQuizzes = state.allQuizzes.filter(q => String(q.gradeLevel) === studentGradeStr || q.gradeLevel === 'All');
            const allLessons = state.lessonBooks.filter(l => String(l.gradeLevel) === studentGradeStr || l.gradeLevel === 'All');
            const allAssignments = state.assignments.filter(a => String(a.gradeLevel) === studentGradeStr || a.gradeLevel === 'All');
            // ### NEW: Get all ended meetings for student's grade ###
            const allMeetings = state.allMeetings.filter(m => (String(m.gradeLevel) === studentGradeStr || m.gradeLevel === 'All') && m.status === 'ended');
            
            return `
                 <div class="bg-white rounded-xl p-6 shadow-lg card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">My Subjects</h2>
                     <p class="text-sm text-gray-600 mb-6">Here you can find all your courses, organized by subject and quarter, including archived materials.</p>
                     
                     <div class="space-y-8">
                        ${enrolledSubjects.map(subject => {
                            // Filter content for this subject
                            const subjectQuizzes = allQuizzes.filter(q => q.subject === subject);
                            const subjectLessons = allLessons.filter(l => l.subject === subject);
                            const subjectAssignments = allAssignments.filter(a => a.subject === subject);
                            // ### NEW: Filter meetings for this subject ###
                            const subjectMeetings = allMeetings.filter(m => m.subject === subject);
                            
                            if (subjectQuizzes.length === 0 && subjectLessons.length === 0 && subjectAssignments.length === 0 && subjectMeetings.length === 0) {
                                return ''; // Don't render empty subjects
                            }
                            
                            // --- NEW LOGIC ---
                            const allArchived = subjectQuizzes.filter(q => q.status === 'archived')
                                .concat(subjectLessons.filter(l => l.status === 'archived'))
                                .concat(subjectAssignments.filter(a => a.status === 'archived'));
                            
                            let latestArchivedQuarter = null;
                            if (allArchived.length > 0) {
                                // --- SYNTAX FIX: Replaced spread operator ---
                                const timestamps = allArchived.map(item => item.timestamp?.toMillis() || 0);
                                const latestTimestamp = Math.max.apply(null, timestamps);
                                const latestArchivedItem = allArchived.find(item => item.timestamp?.toMillis() === latestTimestamp);
                                latestArchivedQuarter = latestArchivedItem ? (latestArchivedItem.quarter || 'Other') : null;
                            }
                            // --- END NEW LOGIC ---
                            
                            return `
                                <div class="p-4 border border-gray-200 rounded-xl">
                                    <h3 class="text-xl font-bold text-emerald-700 mb-4">${subject}</h3>
                                    <div class="space-y-6">
                                        ${QUARTERS.map(quarter => {
                                            // Filter content for this quarter
                                            const quizzes = subjectQuizzes.filter(q => (q.quarter || 'Other') === quarter);
                                            const lessons = subjectLessons.filter(l => (l.quarter || 'Other') === quarter);
                                            const assignments = subjectAssignments.filter(a => (a.quarter || 'Other') === quarter);
                                            // ### NEW: Filter meetings for this quarter ###
                                            const onlineClasses = subjectMeetings.filter(m => (m.quarter || 'Other') === quarter);
                                            
                                            if (quizzes.length === 0 && lessons.length === 0 && assignments.length === 0 && onlineClasses.length === 0) {
                                                return ''; // Don't render empty quarters for this subject
                                            }
                                            
                                            // --- MODIFICATION: Use display map ---
                                            const quarterDisplayText = QUARTER_DISPLAY_MAP[quarter] || quarter;
                                            // --- END MODIFICATION ---

                                            return `
                                                <details class="group rounded-lg bg-gray-50" ${quarter === latestArchivedQuarter ? 'open' : ''}>
                                                    <summary class="flex justify-between items-center p-3 cursor-pointer list-none">
                                                        <!-- MODIFICATION: Use display text -->
                                                        <h4 class="text-lg font-semibold text-gray-800">${quarterDisplayText}</h4>
                                                        <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" 
                                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                        </svg>
                                                    </summary>
                                                    <div class="space-y-2 p-3 pt-0">
                                                        ${quizzes.length > 0 ? `
                                                            <div class="pl-4">
                                                                <p class="text-sm font-medium text-gray-700">Quizzes:</p>
                                                                <ul class="list-disc pl-5 text-sm space-y-1 mt-1">
                                                                    <!-- *** BUG FIX: Use 'quizzes', not 'subjectQuizzes' *** -->
                                                                    ${quizzes.map(q => {
                                                                        const attempts = (state.studentStats[q.subject]?.attempts || []).filter(a => a.quizId === q.id);
                                                                        // --- SYNTAX FIX: Replaced spread operator ---
                                                                        const bestScore = attempts.length > 0 ? attempts.slice().sort((a,b) => b.score - a.score)[0].score : null;
                                                                        const totalItems = attempts.length > 0 ? attempts[0].totalItems : (q.questions?.length || 0);
                                                                        return `<li>
                                                                            <button data-action="review-quiz" data-id="${q.id}" class="text-blue-600 hover:underline">${q.title || q.subject}</button>
                                                                            ${bestScore !== null ? 
                                                                                `<span class="text-gray-500 font-medium">(Best: ${bestScore}/${totalItems})</span>` :
                                                                                (q.status === 'archived' ? '<span class="text-gray-500 font-medium">(Not Taken)</span>' : '')
                                                                            }
                                                                            ${q.status === 'archived' ? '<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium">Archived</span>' : ''}
                                                                        </li>`;
                                                                    }).join('')}
                                                                </ul>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${lessons.length > 0 ? `
                                                            <div class="pl-4">
                                                                <p class="text-sm font-medium text-gray-700">Lessons:</p>
                                                                <ul class="list-disc pl-5 text-sm space-y-1 mt-1">
                                                                    <!-- *** BUG FIX: Use 'lessons', not 'subjectLessons' *** -->
                                                                    ${lessons.map(l => {
                                                                        const progress = state.lessonBookProgress[l.id];
                                                                        return `<li><button data-action="view-lesson" data-id="${l.id}" class="text-blue-600 hover:underline">${l.title}</button> ${progress?.completed ? `<span class="text-green-600 font-medium">(Completed)</span>` : ''}</li>`;
                                                                    }).join('')}
                                                                </ul>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        ${assignments.length > 0 ? `
                                                            <div class="pl-4">
                                                                <p class="text-sm font-medium text-gray-700">Assignments:</p>
                                                                <ul class="list-disc pl-5 text-sm space-y-1 mt-1">
                                                                    <!-- *** BUG FIX: Use 'assignments', not 'subjectAssignments' *** -->
                                                                    ${assignments.map(a => {
                                                                        const submission = state.myAssignmentSubmissions[a.id];
                                                                        return `<li><button data-action="view-assignment" data-id="${a.id}" class="text-blue-600 hover:underline">${a.title}</button> ${submission ? `<span class="text-green-600 font-medium">(Submitted)</span>` : ''}</li>`;
                                                                    }).join('')}
                                                                </ul>
                                                            </div>
                                                        ` : ''}
                                                        
                                                        <!-- ### NEW: Render Online Classes ### -->
                                                        ${onlineClasses.length > 0 ? `
                                                            <div class="pl-4">
                                                                <p class="text-sm font-medium text-gray-700">Online Classes:</p>
                                                                <ul class="list-disc pl-5 text-sm space-y-1 mt-1">
                                                                    ${onlineClasses.map(m => {
                                                                        const myGrade = (m.participationGrades && m.participationGrades[state.currentUser.username] !== undefined) ? m.participationGrades[state.currentUser.username] : null;
                                                                        return `<li>${m.topic} ${myGrade !== null ? `<span class="text-gray-500 font-medium">(Grade: ${myGrade}/100)</span>` : ''}</li>`;
                                                                    }).join('')}
                                                                </ul>
                                                            </div>
                                                        ` : ''}
                                                        <!-- ### END NEW ### -->
                                                    </div>
                                                </details>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                     </div>
                 </div>
            `;
        }

        // Priority 1: This is the new master calculation function
        // It reads from the global state, simulating a server function with full DB access
        // Priority 1: This is the new master calculation function
        // It reads from the global state, simulating a server function with full DB access
        function _getCalculatedAveragesForStudent(studentUid, studentGrade) {
            
            // --- FIX: Get subjects student is *actually* enrolled in ---
            // Find the student object to pass to the helper
            const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;
            const student = userSource.find(u => u.username === studentUid);
            const subjects = getEnrolledSubjects(student);
            // const subjects = subjectMap[String(studentGrade)] || []; // OLD
            
            if (!studentUid || subjects.length === 0) {
                return { subjectAverages: {}, totalAverage: null };
            }

            // 1. Get all data for this student
            const studentQuizResults = state.studentResults.find(r => r.userId === studentUid);
            
            // ... (keep the existing logic for studentLessonSubs and studentAssignmentSubs) ...
            let studentLessonSubs = [];
            let studentAssignmentSubs = [];
            if (state.currentUser && state.currentUser.role === 'student' && state.currentUser.username === studentUid) {
                studentLessonSubs = Object.values(state.lessonBookProgress || {});
                studentAssignmentSubs = Object.values(state.myAssignmentSubmissions || {});
            } else if (state.currentUser && (state.currentUser.role === 'teacher' || state.currentUser.role === 'admin')) {
                studentLessonSubs = (state.allLessonSubmissions || []).filter(s => s.userId === studentUid);
                studentAssignmentSubs = (state.assignmentSubmissions || []).filter(s => s.userId === studentUid);
            }
            
            const subjectAverages = {};
            const allSubjectScores = [];

            subjects.forEach(subject => {
                // a. Get Quiz Grades
                // ... (keep all the existing logic for quizAvg) ...
                let quizAvg = null; 
                const allAttemptsForSubject = (studentQuizResults && studentQuizResults.subjects && studentQuizResults.subjects[subject]) ? studentQuizResults.subjects[subject].attempts : [];
                if (allAttemptsForSubject.length > 0) {
                    const quizIdsInSubject = allAttemptsForSubject.map(a => a.quizId).filter(id => id)
                        .filter((id, index, self) => self.indexOf(id) === index); // Unique IDs
                    const bestScorePercentages = [];
                    quizIdsInSubject.forEach(quizId => {
                        const attemptsForThisQuiz = allAttemptsForSubject.filter(a => a.quizId === quizId);
                        if (attemptsForThisQuiz.length > 0) {
                            const best = attemptsForThisQuiz.slice().sort((a,b) => b.score - a.score)[0];
                            const totalItems = best.totalItems;
                            if (totalItems && totalItems > 0) {
                                bestScorePercentages.push((best.score / totalItems) * 100);
                            }
                        }
                    });
                    if (bestScorePercentages.length > 0) {
                        quizAvg = bestScorePercentages.reduce((a, b) => a + b, 0) / bestScorePercentages.length;
                    }
                }

                // b. Get Lesson Grades
                const lessonPercentages = studentLessonSubs // Will store percentages
                    .filter(s => s.subject === subject && s.completed && s.bestScore !== undefined && s.totalQuestions > 0)
                    .map(s => (s.bestScore / s.totalQuestions) * 100);

                // c. Get Assignment Grades
                // ... (keep all the existing logic for assignmentPercentages) ...
                 const assignmentPercentages = studentAssignmentSubs // Will store percentages
                    .filter(s => s.subject === subject && s.grade !== null && s.grade !== undefined)
                    .map(s => s.grade); // Grade is already a percentage

                // ### NEW: d. Get Participation Grades ###
                const participationPercentages = (state.allMeetings || [])
                    .filter(m => 
                        m.status === 'ended' && 
                        m.subject === subject && // Match the subject
                        m.participationGrades &&
                        m.participationGrades[studentUid] !== undefined &&
                        m.participationGrades[studentUid] !== null
                    )
                    .map(m => m.participationGrades[studentUid]); // Grade is already 0-100
                // ### END NEW ###

                // e. Calculate Averages for each category
                // (quizAvg is already calculated)
                    
                // ### MODIFIED: Combine Lesson and Participation Grades ###
                const allLessonComponentGrades = lessonPercentages.concat(participationPercentages);
                const lessonAvg = allLessonComponentGrades.length > 0
                    ? allLessonComponentGrades.reduce((a, b) => a + b, 0) / allLessonComponentGrades.length
                    : null;
                // ### END MODIFICATION ###
                    
                const assignmentAvg = assignmentPercentages.length > 0
                    ? assignmentPercentages.reduce((a, b) => a + b, 0) / assignmentPercentages.length
                    : null;
                
                // f. Apply weights (NEW WEIGHTS)
                // ... (keep the existing logic for weights) ...
                let totalWeightedScore = 0;
                let totalWeight = 0;
                if (quizAvg !== null) {
                    totalWeightedScore += quizAvg * 0.40; // 40%
                    totalWeight += 0.40;
                }
                if (assignmentAvg !== null) {
                    totalWeightedScore += assignmentAvg * 0.30; // 30%
                    totalWeight += 0.30;
                }
                if (lessonAvg !== null) { // This now includes participation
                    totalWeightedScore += lessonAvg * 0.30; // 30%
                    totalWeight += 0.30;
                }
                
                // g. Calculate final subject average
                // ... (keep the existing logic for final average) ...
                 if (totalWeight === 0) {
                    subjectAverages[subject] = null; // No graded items at all
                } else {
                    const finalSubjectAvg = totalWeightedScore / totalWeight;
                    subjectAverages[subject] = finalSubjectAvg;
                    allSubjectScores.push(finalSubjectAvg); 
                }
            });

            // Calculate total average
            // ... (keep the existing logic for total average) ...
            const validScores = allSubjectScores.filter(s => s !== null && s !== undefined);
            const totalAverage = validScores.length > 0 
                ? validScores.reduce((a, b) => a + b, 0) / validScores.length 
                : null;
            
            return {
                subjectAverages: subjectAverages,
                totalAverage: totalAverage
            };
        }

        // Priority 1.2: Gut and replace renderStudentGradeBook
        function renderStudentGradeBook() {
             
             if (!state.currentUser) return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">Loading...</div>`; // Use state.currentUser

             // Call the master calculation function for the current user
             const { subjectAverages, totalAverage } = _getCalculatedAveragesForStudent(
                 state.currentUser.username, // Use username
                 state.currentUser.grade
             );
             
             // --- FIX: Get subjects student is *actually* enrolled in ---
             const subjects = getEnrolledSubjects(state.currentUser);
             // const subjects = subjectMap[String(state.currentUser.grade)] || []; // OLD
             
             if (subjects.length === 0 || totalAverage === null) {
                 return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">No graded items found. Complete some quizzes, lessons, or assignments to see your grades here.</div>`;
             }

             return `
                 <div class="bg-white rounded-xl p-6 shadow-lg card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">My Grade Book</h2>
                     <div class="space-y-6">
                         <div class="rounded-lg border border-gray-200 overflow-hidden">
                             <div class="divide-y divide-gray-100">
                                 ${subjects.map(subject => {
                                     const avg = subjectAverages[subject];
                                     if (avg === null || avg === undefined) return ''; // Don't show subjects with no grades
                                     
                                     const avgColor = avg >= 80 ? 'text-green-600' : avg >= 50 ? 'text-orange-500' : 'text-red-600';
                                     
                                     return `
                                         <div class="p-4 flex justify-between items-center hover:bg-gray-50">
                                             <p class="font-semibold text-xl text-gray-800">${subject}</p>
                                             <div class="text-right">
                                                 <span class="font-bold text-2xl ${avgColor}">${avg.toFixed(1)}%</span>
                                                 <span class="text-xs text-gray-500 block">Subject Average</span>
                                             </div>
                                         </div>
                                     `;
                                 }).join('')}
                             </div>
                             <!-- Total Average -->
                             <div class="p-4 flex justify-between items-center bg-gray-50 border-t-2 border-emerald-200">
                                 <p class="font-bold text-xl text-emerald-800">Total Average</p>
                                 <div class="text-right">
                                     <span class="font-extrabold text-2xl text-emerald-700">${totalAverage !== null ? totalAverage.toFixed(1) : 'N/A'}%</span>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
         }
         
        // NEW: Student Payment Status View
        function renderStudentPaymentStatus() {
            const sessions = state.studentPaymentSessions; // Already filtered and sorted
            
            if (sessions.length === 0) {
                 return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">You have no payment sessions on record.</div>`;
            }

             return `
                 <div class="bg-white rounded-xl p-6 shadow-lg card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3">My Payment Status</h2>
                     <div class="space-y-4">
                         ${sessions.map(session => {
                             const status = session.paymentStatus || 'N/A';
                             let colorClass = 'text-gray-700 bg-gray-100';
                             switch(status) {
                                 case 'Paid': colorClass = 'text-green-700 bg-green-200'; break;
                                 case 'Pending': colorClass = 'text-yellow-700 bg-yellow-200'; break;
                                 case 'No Payment': colorClass = 'text-red-700 bg-red-200'; break;
                                 case 'Overdue': colorClass = 'text-red-700 bg-red-200 font-bold'; break;
                             }
                             
                             const reminderSent = session.reminderSentTimestamp && (Date.now() - session.reminderSentTimestamp.toDate().getTime()) < (14 * 86400000); // Active reminder

                             // --- NEW LOGIC FOR CONTAINER ---
                             let containerColorClass = 'bg-gray-50 border-gray-200'; // Default
                             let reminderTextClass = 'text-sm font-bold text-red-600 mb-2'; // Default reminder text
                             
                             if (status === 'Paid') {
                                 containerColorClass = 'bg-green-50 border-green-200';
                                 reminderTextClass = 'text-sm font-medium text-green-700 mb-2'; // Make reminder text green
                             } else if (status === 'Pending') {
                                 containerColorClass = 'bg-yellow-50 border-yellow-200';
                                 reminderTextClass = 'text-sm font-medium text-yellow-800 mb-2'; // Make reminder text yellow
                             } else if (status === 'No Payment' || status === 'Overdue') {
                                 // Make red even if no reminder sent
                                 containerColorClass = 'bg-red-50 border-red-200';
                             } else if (reminderSent) { // Only if not Paid or Pending
                                 containerColorClass = 'bg-red-50 border-red-200';
                                 // reminderTextClass is already red (default)
                             }
                             // --- END NEW LOGIC ---

                             return `
                                 <div class="p-4 rounded-lg border border-gray-200 shadow-sm ${containerColorClass}">
                                     ${reminderSent ? `<p class="${reminderTextClass}">A reminder was sent for this payment.</p>` : ''}
                                     <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                         <div>
                                             <h3 class="text-lg font-semibold text-gray-800">${session.notes || 'Tutorial Session'}</h3>
                                             <p class="text-sm text-gray-500">
                                                 Session: 
                                                 <span class="font-medium text-gray-700">${new Date(session.sessionStartDate.toDate()).toLocaleDateString()}</span> to
                                                 <span class="font-medium text-gray-700">${new Date(session.sessionEndDate.toDate()).toLocaleDateString()}</span>
                                             </p>
                                             <p class="text-sm text-gray-500">
                                                 Amount Due: <span class="font-medium text-gray-700">${session.amountDue?.toFixed(2) || '0.00'}</span>
                                             </p>
                                         </div>
                                         <div class="mt-2 sm:mt-0 sm:text-right">
                                             <span class="px-3 py-1 rounded-full text-sm font-semibold ${colorClass}">${status}</span>
                                         </div>
                                     </div>
                                 </div>
                             `;
                         }).join('')}
                     </div>
                 </div>
             `;
        }


        function renderTeacherMonitor() {
            // Task 1: Handle legacy grades
            const mappedResults = state.studentResults.map(student => {
                 let grade = student.grade;
                 if (grade === '3.1' || grade === '3.2') grade = 3;
                 if (grade === '5.1') grade = 5;
                 // --- SYNTAX FIX: Replaced spread operator ---
                 return Object.assign({}, student, { grade: grade });
            });
        
            // FIX 2: Filter for *students only* from the user profile list first.
            // --- EDIT: Use state.allUserProfiles if available, fallback to seed ---
            const userSource = (state.allUserProfiles && state.allUserProfiles.length > 0) ? state.allUserProfiles : INITIAL_SEED_USERS;

             const allStudentsFromUsers = userSource.filter(u => u.role === 'student').map(u => {
                 // Normalize grades from USERS array just like from results
                 let grade = u.grade;
                 if (grade === '3.1' || grade === '3.2') grade = 3;
                 if (grade === '5.1') grade = 5;
                 // Find the matching result doc
                 // --- EDIT: Find by username ---
                 const resultData = mappedResults.find(r => r.userId === u.username);
                 // --- SYNTAX FIX: Replaced spread operator ---
                 return Object.assign({}, u, {
                     grade: grade, // Use normalized grade
                     userId: u.username, // Username is the stable ID
                     subjects: resultData?.subjects || {} // Get subjects from results
                 });
             }).sort((a,b) => a.name.localeCompare(b.name));


            const studentsByGrade = allStudentsFromUsers.reduce((acc, student) => {
                const grade = student.grade || 'Ungraded';
                if (!acc[grade]) {
                    acc[grade] = [];
                }
                acc[grade].push(student);
                return acc;
            }, {});

            // Task 1: Update grade sorting
            const sortedGrades = Object.keys(studentsByGrade).sort((a, b) => {
                 const indexA = gradeSortOrder.indexOf(String(a));
                 const indexB = gradeSortOrder.indexOf(String(b));
                 // Handle items not in sortOrder (like 'Ungraded')
                 if (indexA === -1) return 1;
                 if (indexB === -1) return -1;
                 return indexA - indexB;
            });

            if (allStudentsFromUsers.length === 0) {
                 return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">No student quiz data has been recorded yet.</div>`
            }

            return sortedGrades.map(grade => {
                const studentsInGrade = studentsByGrade[grade]; // Already sorted by name
                
                // --- MODIFICATION ---
                // Use the grade-specific subject map, fallback to all subjects if grade not in map (e.g., 'Ungraded')
                const subjectsForThisGrade = subjectMap[String(grade)] || MASTER_SUBJECT_LIST;
                // --- END MODIFICATION ---

                return `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold text-emerald-700 mb-4">${grade.startsWith('Kinder') ? grade : `Grade ${grade}`} Students - Quiz Performance</h2>
                        <div class="overflow-x-auto bg-white rounded-xl shadow-lg card">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-emerald-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        ${subjectsForThisGrade.map(sub => {
                                            // --- NEW: Find newest quiz for header ---
                                            // ### MODIFIED: Restricted to Current Teacher's Quizzes ###
                                            const newestQuiz = state.allQuizzes
                                                .filter(q => q.subject === sub && (String(q.gradeLevel) === String(grade) || q.gradeLevel === 'All') && q.status !== 'archived')
                                                // Filter by teacherId OR fallback to name for old data
                                                .filter(q => (q.teacherId === state.currentUser.username) || (!q.teacherId && q.teacherName === state.currentUser.name))
                                                .sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0))[0];
                                            
                                            return `<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        ${sub}
                                                        <span class="font-normal normal-case text-gray-400 text-[10px] truncate max-w-[150px] block" title="${newestQuiz ? newestQuiz.title : 'No Active Quiz'}">
                                                            ${newestQuiz ? `(Newest: ${newestQuiz.title})` : '(No Active Quiz)'}
                                                        </span>
                                                    </th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${studentsInGrade.map(student => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                ${student.name}
                                                <div class="text-xs text-gray-400 truncate" title="${student.userId || 'N/A'}">${student.userId || 'N/A'}</div>
                                            </td>
                                            ${subjectsForThisGrade.map(sub => {
                                                // --- NEW: Find newest quiz for this subject/grade ---
                                                // ### MODIFIED: Restricted to Current Teacher's Quizzes ###
                                                const newestQuiz = state.allQuizzes
                                                    .filter(q => q.subject === sub && (String(q.gradeLevel) === String(grade) || q.gradeLevel === 'All') && q.status !== 'archived')
                                                    // Filter by teacherId OR fallback to name for old data
                                                    .filter(q => (q.teacherId === state.currentUser.username) || (!q.teacherId && q.teacherName === state.currentUser.name))
                                                    .sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0))[0];

                                                if (newestQuiz) {
                                                    const subjectData = student.subjects?.[sub];
                                                    if (subjectData && subjectData.attempts?.length > 0) {
                                                        // Find attempts *for this specific quiz*
                                                        const attemptsForNewestQuiz = subjectData.attempts.filter(a => a.quizId === newestQuiz.id);
                                                        
                                                        if (attemptsForNewestQuiz.length > 0) {
                                                            // --- SYNTAX FIX: Replaced spread operator ---
                                                            const bestAttempt = attemptsForNewestQuiz.slice().sort((a,b) => b.score - a.score)[0];
                                                            const totalItems = bestAttempt.totalItems; 
                                                            const percentage = (totalItems && totalItems > 0) ? (bestAttempt.score / totalItems) * 100 : 0;
                                                            const scoreClass = percentage >= 80 ? 'text-green-600 font-extrabold' : percentage >= 50 ? 'text-orange-500 font-bold' : 'text-red-600 font-bold';
                                                            
                                                            return `<td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                                                <span class="${scoreClass}">${bestAttempt.score}/${totalItems || '?'}</span>
                                                                <span class="text-gray-500"> (${attemptsForNewestQuiz.length})</span>
                                                            </td>`;
                                                        } else {
                                                            // Student has attempts in this subject, but not for the newest quiz
                                                            return `<td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-400">N/A</td>`;
                                                        }
                                                    }
                                                    // Student has no attempts for this subject at all
                                                    return `<td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-400">N/A</td>`;
                                                }
                                                // No active quiz found for this subject/grade
                                                return `<td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-400">-</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAnnouncementsManager() {
             // ### MODIFIED: Filter Announcements by Teacher ###
             const myAnnouncements = state.announcements.filter(ann => 
                (ann.teacherId === state.currentUser.username) || (!ann.teacherId && ann.teacherName === state.currentUser.name)
             );
             
             return `
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                     <!-- Post New Announcement -->
                     <div class="lg:col-span-1">
                         <div class="bg-white rounded-xl shadow-lg p-6 card sticky top-24">
                             <h2 class="text-2xl font-bold text-gray-800 mb-4">Post Announcement</h2>
                             <form id="announcement-form" class="space-y-4">
                                 <div>
                                     <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                                     <input type="text" id="title" name="title" required class="input-field mt-1">
                                 </div>
                                 <div>
                                     <label for="content" class="block text-sm font-medium text-gray-700">Content</label>
                                     <textarea id="content" name="content" rows="4" required class="input-field mt-1"></textarea>
                                 </div>
                                 <div>
                                      <label for="gradeLevel" class="block text-sm font-medium text-gray-700">Visible To</label>
                                      <select id="gradeLevel" name="gradeLevel" required class="input-field mt-1">
                                          ${getGradeLevelOptions('All')}
                                      </select>
                                 </div>
                                 <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 shadow-md">
                                     Post Now
                                 </button>
                             </form>
                         </div>
                     </div>
                     <!-- Existing Announcements -->
                     <div class="lg:col-span-2">
                          <h2 class="text-2xl font-bold text-gray-800 mb-4">History</h2>
                         <div class="space-y-4">
                             ${myAnnouncements.length > 0 ? myAnnouncements.map(ann => `
                                 <div class="bg-white rounded-xl shadow-lg p-5 card">
                                     <div class="flex justify-between items-start">
                                         <div>
                                             <div class="flex items-center space-x-3 mb-1">
                                                  <h3 class="text-lg font-semibold text-gray-800">${ann.title}</h3>
                                                  <span class="px-2 py-0.5 ${ann.gradeLevel === 'All' ? 'bg-gray-200 text-gray-700' : 'bg-emerald-200 text-emerald-700'} rounded-full text-xs font-medium">
                                                      ${ann.gradeLevel === 'All' ? 'All Grades' : (ann.gradeLevel.startsWith('Kinder') ? ann.gradeLevel : `Grade ${ann.gradeLevel}`)}
                                                  </span>
                                             </div>
                                             <p class="text-sm text-gray-500 text-left">
                                                 By ${ann.teacherName} on ${new Date(ann.timestamp?.toDate() || Date.now()).toLocaleDateString()}
                                             </p>
                                         </div>
                                         <button data-action="delete-announcement" data-id="${ann.id}" class="text-sm text-red-500 hover:text-red-700 font-medium ml-4">Delete</button>
                                     </div>
                                     <p class="text-sm text-gray-700 mt-3 whitespace-pre-wrap">${ann.content}</p>
                                 </div>
                             `).join('') : `
                                 <div class="bg-white rounded-xl p-6 text-center text-gray-500 card">No announcements have been posted yet.</div>
                             `}
                         </div>
                     </div>
                 </div>
             `;
        }

        function renderQuizEditor() {
            // Find existing quizzes to list them
             const allQuizzesSorted = state.allQuizzes.sort((a, b) => {
                 if (a.subject < b.subject) return -1;
                 if (a.subject > b.subject) return 1;
                 // Sort by grade level
                 const indexA = gradeSortOrder.indexOf(String(a.gradeLevel));
                 const indexB = gradeSortOrder.indexOf(String(b.gradeLevel));
                 if (indexA === -1) return 1;
                 if (indexB === -1) return -1;
                 return indexA - indexB;
             });
             
             // --- NEW: Split into active and archived ---
             // ### MODIFIED: Filter by Current Teacher ###
             const myQuizzes = allQuizzesSorted.filter(q => (q.teacherId === state.currentUser.username) || (!q.teacherId && q.teacherName === state.currentUser.name));
             
             const activeQuizzes = myQuizzes.filter(q => q.status !== 'archived');
             const archivedQuizzes = myQuizzes.filter(q => q.status === 'archived');

             return `
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                     <!-- Quiz Editor Form -->
                     <div class="lg:col-span-2">
                         <div class="bg-white rounded-xl shadow-lg p-6 card">
                            <form id="quiz-editor-form" class="space-y-4">
                                 <!-- ### MODIFIED: Header for editor ### -->
                                 <div class="flex justify-between items-center mb-4">
                                     <h2 class="text-2xl font-bold text-gray-800">${state.isEditingQuiz ? 'Edit Quiz' : 'Create New Quiz'}</h2>
                                     ${state.isEditingQuiz ? `
                                         <button type="button" data-action="cancel-edit-quiz" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-200">
                                             Cancel Edit
                                         </button>
                                     ` : ''}
                                 </div>
                                 <p class="text-sm text-gray-600 mb-4">
                                     Create or update a quiz. Parsing is automatic. Use format:
                                     <code class="text-xs bg-gray-100 p-1 rounded">1. Question?</code>,
                                     <code class="text-xs bg-gray-100 p-1 rounded">A) Option</code>,
                                     <code class="text-xs bg-gray-100 p-1 rounded">Answer: A</code>.
                                     For fill-in-the-blank, just omit options (e.g., <code class="text-xs bg-gray-100 p-1 rounded">Answer: Photosynthesis</code>).
                                     You can also add <code class="text-xs bg-gray-100 p-1 rounded">Type: FillIn</code>, <code class="text-xs bg-gray-100 p-1 rounded">Discussion: ...</code>,
                                     <!-- NEW -->
                                     <code class="text-xs bg-gray-100 p-1 rounded">Introduction: ...</code>,
                                     <code class="text-xs bg-gray-100 p-1 rounded">Image: https://...</code>
                                     <!-- END NEW -->
                                 </p>
                                 <input type="hidden" id="quizId" name="quizId" value="${state.editingQuiz?.id || ''}">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div>
                                         <label for="quizGradeLevel" class="block text-sm font-medium text-gray-700">Grade Level</label>
                                         <select id="quizGradeLevel" name="quizGradeLevel" required class="input-field mt-1" onchange="updateSubjectDropdown('quizGradeLevel', 'quizSubject')">
                                              ${getGradeLevelOptions(state.editingQuiz?.gradeLevel || 'All')}
                                         </select>
                                     </div>
                                     <div>
                                         <label for="quizSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                                          <select id="quizSubject" name="quizSubject" required class="input-field mt-1">
                                             ${getSubjectOptions(state.editingQuiz?.gradeLevel || 'All', state.editingQuiz?.subject || null)}
                                         </select>
                                     </div>
                                 </div>
                                  <!-- NEW: Quarter Field -->
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div>
                                          <label for="quizTitle" class="block text-sm font-medium text-gray-700">Quiz Title</label>
                                          <input type="text" id="quizTitle" name="quizTitle" required class="input-field mt-1" placeholder="e.g., Week 1: Addition" value="${state.editingQuiz?.title || ''}">
                                     </div>
                                     <div>
                                         <label for="quizQuarter" class="block text-sm font-medium text-gray-700">Quarter</label>
                                          <select id="quizQuarter" name="quizQuarter" required class="input-field mt-1">
                                             ${getQuarterOptions(state.editingQuiz?.quarter || 'Q1')}
                                         </select>
                                     </div>
                                 </div>
                                 <div>
                                     <label for="quizText" class="block text-sm font-medium text-gray-700">Quiz Content (Paste Text)</label>
                                     <textarea id="quizText" name="quizText" rows="15" required class="input-field mt-1 font-mono text-sm" placeholder="1. Introduction: This is a story...\nWhat is 2+2?\nImage: https://...\nA) 3\nB) 4\nC) 5\nAnswer: B\n\n2. What is the capital of France?\nAnswer: Paris\nType: FillIn">${state.editingQuiz ? quizQuestionsToText(state.editingQuiz.questions) : ''}</textarea>
                                 </div>
                                 <div id="quiz-editor-error" class="text-sm font-medium p-3 rounded-md" role="alert"></div>
                                 <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 shadow-md">
                                     ${state.isEditingQuiz ? 'Update Quiz' : 'Save New Quiz'}
                                 </button>
                             </form>
                         </div>
                     </div>
                     <!-- Existing Quizzes -->
                     <div class="lg:col-span-1">
                         <div class="bg-white rounded-xl shadow-lg p-6 card sticky top-24">
                             <h2 class="text-2xl font-bold text-gray-800 mb-4">Active Quizzes</h2>
                             <div class="space-y-3 max-h-96 overflow-y-auto mb-6 border-b pb-6">
                                 ${activeQuizzes.length > 0 ? activeQuizzes.map(quiz => `
                                     <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 flex justify-between items-center">
                                         <div>
                                             <p class="font-semibold text-gray-800">${quiz.title || quiz.subject}</p>
                                             <p class="text-xs text-gray-500">
                                                 ${quiz.subject} | ${quiz.quarter || 'Other'} | ${quiz.questions?.length || 0} Qs
                                             </p>
                                         </div>
                                         <div class="flex-shrink-0 ml-2 space-x-2">
                                             <button data-action="edit-quiz" data-id="${quiz.id}" class="text-xs text-blue-500 hover:text-blue-700 font-medium">Edit</button>
                                             <button data-action="archive-quiz" data-id="${quiz.id}" data-status="archived" class="text-xs text-yellow-600 hover:text-yellow-800 font-medium">Archive</button>
                                             <button data-action="delete-quiz" data-id="${quiz.id}" class="text-xs text-red-600 hover:text-red-800 font-medium">Delete</button>
                                         </div>
                                     </div>
                                 `).join('') : `
                                     <p class="text-sm text-gray-500 text-center py-4">No active quizzes.</p>
                                 `}
                             </div>
                             
                             <!-- ### START FIX: ADDED ARCHIVED QUIZZES LIST ### -->
                             <h2 class="text-2xl font-bold text-gray-800 mb-4">Archived Quizzes</h2>
                             <div class="space-y-3 max-h-96 overflow-y-auto">
                                 ${archivedQuizzes.length > 0 ? archivedQuizzes.map(quiz => `
                                     <div class="bg-gray-100 rounded-lg p-3 border border-gray-200 flex justify-between items-center opacity-70">
                                         <div>
                                             <p class="font-semibold text-gray-600">${quiz.title || quiz.subject}</p>
                                             <p class="text-xs text-gray-500">
                                                 ${quiz.subject} | ${quiz.quarter || 'Other'} | ${quiz.questions?.length || 0} Qs
                                             </p>
                                         </div>
                                         <div class="flex-shrink-0 ml-2 space-x-2">
                                             <button data-action="edit-quiz" data-id="${quiz.id}" class="text-xs text-blue-500 hover:text-blue-700 font-medium">Edit</button>
                                             <button data-action="archive-quiz" data-id="${quiz.id}" data-status="active" class="text-xs text-green-600 hover:text-green-800 font-medium">Unarchive</button>
                                             <button data-action="delete-quiz" data-id="${quiz.id}" class="text-xs text-red-600 hover:text-red-800 font-medium">Delete</button>
                                         </div>
                                     </div>
                                 `).join('') : `
                                     <p class="text-sm text-gray-500 text-center py-4">No archived quizzes.</p>
                                 `}
                             </div>
                             <!-- ### END FIX ### -->
                         </div>
                     </div>
                 </div>
             `;
        }

        function renderLessonBookManager() {
             // ### MODIFIED: Filter by Current Teacher ###
             const myLessons = state.lessonBooks.filter(l => (l.teacherId === state.currentUser.username) || (!l.teacherId && l.teacherName === state.currentUser.name));

             const activeLessons = myLessons.filter(l => l.status !== 'archived');
             const archivedLessons = myLessons.filter(l => l.status === 'archived');

             return `
                 <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <div class="flex justify-between items-center mb-5 border-b pb-3">
                         <h2 class="text-2xl font-bold text-gray-800">Lesson Manager</h2>
                         <button data-action="open-lesson-modal" class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 shadow-md">
                             + Create New Lesson
                         </button>
                         <!-- ### FIX: Removed rogue h2 tag from here ### -->
                     </div>
                     <!-- ### FIX: Added correct h3 tag here ### -->
                     <h3 class="text-xl font-bold text-gray-700 mb-3">Active Lessons</h3>
                     <div class="space-y-4">
                         ${activeLessons.length === 0 ? `<p class="text-gray-500 text-center py-4">No active lessons created yet.</p>` : ''}
                         ${activeLessons.map(lesson => `
                             <!-- ### FIX: Removed '+' and '-' typos from div below ### -->
                             <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-800">${lesson.title}</h3>
                                     <p class="text-sm text-gray-500">
                                         Subject: <span class="font-medium text-gray-700">${lesson.subject || 'N/A'}</span> |
                                         Quarter: <span class="font-medium text-gray-700">${lesson.quarter || 'Other'}</span> |
                                         Grade: <span class="font-medium text-gray-700">${lesson.gradeLevel === 'All' ? 'All' : (lesson.gradeLevel.startsWith('Kinder') ? lesson.gradeLevel : `Grade ${lesson.gradeLevel}`)}</span> |
                                         Slides: <span class="font-medium text-gray-700">${lesson.slides?.length || 0}</span>
                                     </p>
                                     <p class="text-xs text-gray-400">By ${lesson.teacherName} on ${new Date(lesson.timestamp?.toDate() || Date.now()).toLocaleDateString()}</p>
                                 </div>
                                 <div class="flex space-x-2 mt-3 sm:mt-0">
                                     <button data-action="open-lesson-modal" data-id="${lesson.id}" class="px-4 py-1.5 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Edit</button>
                                     <button data-action="archive-lesson" data-id="${lesson.id}" data-status="archived" class="px-4 py-1.5 bg-yellow-100 text-yellow-700 text-sm font-medium rounded-md hover:bg-yellow-200">Archive</button>
                                     <button data-action="delete-lesson" data-id="${lesson.id}" class="px-4 py-1.5 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">Delete</button>
                                 </div>
                             </div>
                         `).join('')}
                     </div>
                     <h3 class="text-xl font-bold text-gray-700 mt-8 mb-3">Archived Lessons</h3>
                     <div class="space-y-4">
                         ${archivedLessons.length === 0 ? `<p class="text-gray-500 text-center py-4">No archived lessons.</p>` : ''}
                         ${archivedLessons.map(lesson => `
                             <div class="p-4 bg-gray-100 rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between opacity-70">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-600">${lesson.title}</h3>
                                     <p class="text-sm text-gray-500">
                                         Subject: <span class="font-medium text-gray-600">${lesson.subject || 'N/A'}</span> |
                                         Grade: <span class="font-medium text-gray-600">${lesson.gradeLevel === 'All' ? 'All' : (lesson.gradeLevel.startsWith('Kinder') ? lesson.gradeLevel : `Grade ${lesson.gradeLevel}`)}</span>
                                     </p>
                                 </div>
                                 <div class="flex space-x-2 mt-3 sm:mt-0">
                                     <button data-action="archive-lesson" data-id="${lesson.id}" data-status="active" class="px-4 py-1.5 bg-green-100 text-green-700 text-sm font-medium rounded-md hover:bg-green-200">Unarchive</button>
                                     <button data-action="delete-lesson" data-id="${lesson.id}" class="px-4 py-1.5 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">Delete</button>
                                 </div>
                             </div>
                         `).join('')}
                     </div>
                 </div>
             `;
        }

        function renderAssignmentManager() {
             // ### MODIFIED: Filter by Current Teacher ###
             const myAssignments = state.assignments.filter(a => (a.teacherId === state.currentUser.username) || (!a.teacherId && a.teacherName === state.currentUser.name));
             
             const activeAssignments = myAssignments.filter(a => a.status !== 'archived');
             const archivedAssignments = myAssignments.filter(a => a.status === 'archived');
             return `
                 <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <div class="flex justify-between items-center mb-5 border-b pb-3">
                         <h2 class="text-2xl font-bold text-gray-800">Assignment Manager</h2>
                         <button data-action="open-assignment-modal" class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 shadow-md">
                             + Create New Assignment
                         </button>
                     </div>
                     <h3 class="text-xl font-bold text-gray-700 mb-3">Active Assignments</h3>
                     <div class="space-y-4">
                         ${activeAssignments.length === 0 ? `<p class="text-gray-500 text-center py-4">No active assignments created yet.</p>` : ''}
                         ${activeAssignments.map(assignment => {
                             const dueDate = assignment.dueDate ? new Date(assignment.dueDate.toDate()) : null;
                             const submissions = state.assignmentSubmissions.filter(s => s.assignmentId === assignment.id);
                             return `
                                 <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                     <div>
                                         <h3 class="text-lg font-semibold text-gray-800">${assignment.title}</h3>
                                         <p class="text-sm text-gray-500">
                                             Subject: <span class="font-medium text-gray-700">${assignment.subject || 'N/A'}</span> |
                                             Quarter: <span class="font-medium text-gray-700">${assignment.quarter || 'Other'}</span> |
                                             Grade: <span class="font-medium text-gray-700">${assignment.gradeLevel === 'All' ? 'All' : (assignment.gradeLevel.startsWith('Kinder') ? assignment.gradeLevel : `Grade ${assignment.gradeLevel}`)}</span>
                                         </p>
                                         <p class="text-sm text-gray-500">
                                             Due: <span class="font-medium text-gray-700">${dueDate ? dueDate.toLocaleDateString() : 'No due date'}</span>
                                         </p>
                                         <p class="text-xs text-gray-400">By ${assignment.teacherName} on ${new Date(assignment.timestamp?.toDate() || Date.now()).toLocaleDateString()}</p>
                                 </div>
                                 <div class="flex space-x-2 mt-3 sm:mt-0">
                                      <button data-action="view-submissions" data-id="${assignment.id}" class="px-4 py-1.5 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200">
                                         View Submissions (${submissions.length})
                                     </button>
                                     <button data-action="open-assignment-modal" data-id="${assignment.id}" class="px-4 py-1.5 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Edit</button>
                                     <button data-action="archive-assignment" data-id="${assignment.id}" data-status="archived" class="px-4 py-1.5 bg-yellow-100 text-yellow-700 text-sm font-medium rounded-md hover:bg-yellow-200">Archive</button>
                                     <button data-action="delete-assignment" data-id="${assignment.id}" class="px-4 py-1.5 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">Delete</button>
                                 </div>
                                 </div>
                             `;
                         }).join('')}
                     </div>
                     <h3 class="text-xl font-bold text-gray-700 mt-8 mb-3">Archived Assignments</h3>
                     <div class="space-y-4">
                         ${archivedAssignments.length === 0 ? `<p class="text-gray-500 text-center py-4">No archived assignments.</p>` : ''}
                         ${archivedAssignments.map(assignment => {
                             return `
                                 <div class="p-4 bg-gray-100 rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between opacity-70">
                                     <div>
                                         <h3 class="text-lg font-semibold text-gray-600">${assignment.title}</h3>
                                         <p class="text-sm text-gray-500">
                                             Subject: <span class="font-medium text-gray-600">${assignment.subject || 'N/A'}</span> |
                                             Grade: <span class="font-medium text-gray-600">${assignment.gradeLevel === 'All' ? 'All' : (assignment.gradeLevel.startsWith('Kinder') ? assignment.gradeLevel : `Grade ${assignment.gradeLevel}`)}</span>
                                         </p>
                                     </div>
                                     <div class="flex space-x-2 mt-3 sm:mt-0">
                                          <button data-action="archive-assignment" data-id="${assignment.id}" data-status="active" class="px-4 py-1.5 bg-green-100 text-green-700 text-sm font-medium rounded-md hover:bg-green-200">
                                             Unarchive
                                         </button>
                                         <button data-action="delete-assignment" data-id="${assignment.id}" class="px-4 py-1.5 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">Delete</button>
                                     </div>
                                 </div>
                             `;
                         }).join('')}
                     </div>
                 </div>
             `;
         }
         
        // NEW: Teacher Payment Manager View
        function renderPaymentManager() {
            const sessions = state.allPaymentSessions; // Already sorted
            
             // Helper to get status color
             const getStatusColor = (status) => {
                 switch(status) {
                     case 'Paid': return 'text-green-100 bg-green-600';
                     case 'Pending': return 'text-yellow-100 bg-yellow-500';
                     case 'No Payment': return 'text-red-100 bg-red-600';
                     case 'Overdue': return 'text-red-100 bg-red-700 font-bold';
                     default: return 'text-gray-700 bg-gray-100';
                 }
             };

             return `
                 <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <div class="flex justify-between items-center mb-5 border-b pb-3">
                         <h2 class="text-2xl font-bold text-gray-800">Payment Manager</h2>
                         <button data-action="open-payment-modal" class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 shadow-md">
                             + Create Payment Session
                         </button>
                     </div>
                     
                     ${sessions.length === 0 ? `<p class="text-gray-500 text-center py-4">No payment sessions created yet.</p>` : ''}
                     
                     <!-- Payment Session List -->
                     <div class="space-y-4">
                         ${sessions.map(session => {
                             const status = session.paymentStatus || 'N/A';
                             const colorClass = getStatusColor(status);
                             const reminderSent = session.reminderSentTimestamp && (Date.now() - session.reminderSentTimestamp.toDate().getTime()) < (14 * 86400000); // Active reminder
                             const history = (session.history || []).sort((a, b) => (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0)); // Show newest first
                             
                             return `
                                 <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                                     <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                         <!-- Student Info -->
                                         <div class="md:col-span-1">
                                             <h3 class="text-lg font-semibold text-gray-800">${session.studentName}</h3>
                                             <p class="text-sm text-gray-500">Grade ${session.studentGrade}</p>
                                             <p class="text-xs text-gray-400 truncate" title="Student ID: ${session.studentId}">ID: ${session.studentId}</p>
                                         </div>
                                         
                                         <!-- Session & Amount -->
                                         <div class="md:col-span-1">
                                             <p class="text-sm text-gray-500">Session:</p>
                                             <p class="font-medium text-gray-700">${new Date(session.sessionStartDate.toDate()).toLocaleDateString()} - ${new Date(session.sessionEndDate.toDate()).toLocaleDateString()}</p>
                                             <p class="text-sm text-gray-500 mt-1">Amount:</p>
                                             <p class="font-medium text-gray-700">${session.amountDue?.toFixed(2) || '0.00'}</p>
                                         </div>
                                         
                                         <!-- Status & Notes -->
                                         <div class="md:col-span-1">
                                              <label for="status-select-${session.id}" class="text-sm text-gray-500">Status:</label>
                                              <select id="status-select-${session.id}"
                                                      onchange="handleChangePaymentStatus('${session.id}', this.value)"
                                                      class="input-field text-sm p-1 ${colorClass} font-semibold">
                                                  <option value="No Payment" ${status === 'No Payment' ? 'selected' : ''}>No Payment</option>
                                                  <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                                                  <option value="Overdue" ${status === 'Overdue' ? 'selected' : ''}>Overdue</option>
                                                  <option value="Paid" ${status === 'Paid' ? 'selected' : ''}>Paid</option>
                                              </select>
                                              <p class="text-sm text-gray-500 mt-1">Notes:</p>
                                              <p class="text-sm text-gray-700">${session.notes || 'N/A'}</p>
                                              
                                              ${history.length > 0 ? `
                                                <div class="mt-2 pt-2 border-t border-gray-200">
                                                    <p class="text-xs font-semibold text-gray-500">History:</p>
                                                    <div class="max-h-20 overflow-y-auto space-y-1 pr-2">
                                                        ${history.map(h => `
                                                            <div class="text-xs text-gray-600 p-1 bg-gray-100 rounded">
                                                                <strong>${new Date(h.timestamp?.toDate?.() || Date.now()).toLocaleDateString()}:</strong>
                                                                Status: ${h.previousStatus}, Amt: ${h.previousAmount?.toFixed(2)}
                                                                (${h.changedBy})
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                              ` : ''}
                                         </div>
                                         
                                         <!-- Actions -->
                                         <div class="md:col-span-1 flex flex-col items-start md:items-end justify-between space-y-2">
                                             <div class="flex space-x-2">
                                                 <button data-action="open-payment-modal" data-id="${session.id}" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Edit</button>
                                                 <button data-action="delete-payment-session" data-id="${session.id}" class="px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">Delete</button>
                                             </div>
                                             <button data-action="send-payment-reminder" data-id="${session.id}" class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200 ${reminderSent ? 'bg-green-100 text-green-700' : ''}">
                                                 ${reminderSent ? 'Reminder Sent' : 'Send Reminder'}
                                             </button>
                                         </div>
                                     </div>
                                 </div>
                             `;
                         }).join('')}
                     </div>
                 </div>
             `;
        }

        function renderViewSubmissions() {
             if (!state.selectedAssignment) {
                 return `<div class="bg-white rounded-xl p-6 text-center text-gray-500 card">Assignment not found.</div>`;
             }
             const assignment = state.selectedAssignment;
             const submissions = state.assignmentSubmissions
                 .filter(s => s.assignmentId === assignment.id)
                 .sort((a,b) => a.studentName.localeCompare(b.name)); // Sort by name

             return `
                 <div class="bg-white rounded-xl shadow-lg p-6 card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-2">${assignment.title}</h2>
                     <p class="text-gray-600 mb-4">Viewing ${submissions.length} submission(s)</p>
                     <div class="space-y-5">
                         ${submissions.length === 0 ? `<p class="text-gray-500 text-center py-4">No submissions received yet.</p>` : ''}
                         ${submissions.map(sub => `
                             <div class="rounded-lg border border-gray-200 shadow-sm">
                                 <div class="p-4 bg-gray-50 border-b">
                                     <h3 class="text-lg font-semibold text-gray-800">${sub.studentName}</h3>
                                     <p class="text-sm text-gray-500">Grade: ${sub.grade || 'N/A'}</p>
                                     <p class="text-xs text-gray-500">Submitted: ${sub.submissionTimestamp ? new Date(sub.submissionTimestamp.toDate()).toLocaleString() : 'N/A'}</p>
                                 </div>
                                 <div class="p-4">
                                     <p class="text-sm text-gray-700 whitespace-pre-wrap mb-3">${sub.submissionText || 'No text submitted.'}</p>
                                      <!-- *** TASK 2 (Assignment) FIX: Render image, link, or filename *** -->
                                      ${sub.submissionFile ? 
                                          (sub.submissionFile.startsWith('data:image/') ? 
                                              `<img src="${sub.submissionFile}" alt="Submission" class="max-w-full h-auto rounded-md shadow-sm mt-2 mb-3" onerror="this.onerror=null;this.parentElement.innerHTML='<p class=\\'text-red-500\\'>Error loading image.</p>';">` :
                                          (sub.submissionFile.startsWith('data:') ?
                                              `<a href="${sub.submissionFile}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-blue-100 text-blue-700 font-medium rounded-md hover:bg-blue-200 inline-block mb-3" download="${sub.studentName}_submission.file"> View/Download Submitted File</a>` :
                                          (sub.submissionFile.startsWith('http') ?
                                               `<a href="${sub.submissionFile}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-blue-100 text-blue-700 font-medium rounded-md hover:bg-blue-200 inline-block mb-3"> View Submitted File</a>` :
                                               `<p class="text-sm text-gray-700 font-medium mb-3"> Submitted File: ${sub.submissionFile}</p>`) // Fallback for filename
                                          )
                                      ) : ''}
                                      <!-- *** END TASK 2 FIX *** -->
                                     <div class="flex items-center space-x-2">
                                         <label for="grade-input-${sub.id}" class="text-sm font-medium text-gray-700">Grade (0-100):</label>
                                         <input type="number" id="grade-input-${sub.id}" min="0" max="100" step="1"
                                                value="${sub.grade !== null && sub.grade !== undefined ? sub.grade : ''}"
                                                class="input-field w-24 text-sm px-2 py-1">
                                         <button data-action="save-grade" data-id="${sub.id}" class="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-md hover:bg-green-600">Save Grade</button>
                                     </div>
                                 </div>
                             </div>
                         `).join('')}
                     </div>
                 </div>
             `;
         }

        function renderLessonBookModal() {
             const lesson = state.editingLessonBook;
             if (!lesson) return ''; // Should not happen if modal is open

             // Task 2.3: Convert existing slides back to text for editing
             let rawLessonText = '';
             if (state.isEditingLesson && lesson && lesson.slides) {
                 rawLessonText = lessonSlidesToText(lesson.slides);
             } else if (lesson && lesson.slides) {
                 // For new lesson, show default text
                 rawLessonText = lessonSlidesToText(lesson.slides);
             }

             return `
                 <div class="modal flex fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
                     <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-screen overflow-hidden flex flex-col card">
                         <div class="flex justify-between items-center p-5 border-b">
                             <h2 class="text-2xl font-bold text-gray-800">${state.isEditingLesson ? 'Edit Lesson' : 'Create New Lesson'}</h2>
                             <button data-action="close-lesson-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
                         </div>
                         <form id="lessonBookForm" class="flex-grow overflow-y-auto p-6 space-y-4">
                             <input type="hidden" name="lessonBookId" value="${lesson.id || ''}">
                             <div class="grid grid-cols-1 md:grid-cols-4 gap-4"> <!-- NEW: Changed to 4 cols -->
                                <div class="md:col-span-2"> <!-- NEW: Span 2 -->
                                    <label for="lessonTitle" class="block text-sm font-medium text-gray-700">Lesson Title</label>
                                    <input type="text" id="lessonTitle" name="lessonTitle" required class="input-field mt-1" value="${lesson.title || ''}">
                                </div>
                                <div>
                                    <label for="lessonGradeLevel" class="block text-sm font-medium text-gray-700">Grade Level</label>
                                    <select id="lessonGradeLevel" name="lessonGradeLevel" required class="input-field mt-1" onchange="updateSubjectDropdown('lessonGradeLevel', 'lessonSubject')">
                                        ${getGradeLevelOptions(lesson.gradeLevel)}
                                    </select>
                                </div>
                                 <div>
                                     <label for="lessonSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                                     <select id="lessonSubject" name="lessonSubject" required class="input-field mt-1">
                                          ${getSubjectOptions(lesson.gradeLevel, lesson.subject)}
                                     </select>
                                 </div>
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <!-- NEW: Second row for Quarter/URL -->
                                  <div>
                                     <label for="lessonQuarter" class="block text-sm font-medium text-gray-700">Quarter</label>
                                     <select id="lessonQuarter" name="lessonQuarter" required class="input-field mt-1">
                                          ${getQuarterOptions(lesson.quarter || 'Q1')}
                            </select>
                                 </div>
                                  <div>
                                     <label for="lessonAttachmentUrl" class="block text-sm font-medium text-gray-700">Attachment URL (Optional)</label>
                                     <input type="url" id="lessonAttachmentUrl" name="lessonAttachmentUrl" class="input-field mt-1" placeholder="https://..." value="${lesson.attachmentUrl || ''}">
                                 </div>
                             </div>
                             
                             <!-- Task 2.3: New Textarea Editor -->
                             <div>
                                 <label for="lessonRawText" class="block text-sm font-medium text-gray-700">Lesson Content</label>
                                 <p class="text-xs text-gray-500 mb-1">Generate a lesson book for an automated parser, ensuring that every slide begins with the [SLIDE] tag. Inside each [SLIDE], all content must adhere to a strict Markdown format: use # Title for the main heading, ## Subtitle for optional sections, * Bullet points for key ideas and lists, **Bold text** for keywords, and _Italic text_ for emphasis. After any [SLIDE] block, you can optionally add one of several tags for supplementary content, including [QUESTION] a. b. c. d. Answer: [Correct answer letter] for assessments, [FILE: descriptive name or URL] for documents, [VIDEO: descriptive topic or URL] for videos, or [IMAGE: descriptive prompt for an image] for visuals.</p>
                                 <!-- ### NEW: Updated help text for Markdown ### -->
                                 <p class="text-xs text-gray-500 mb-1">
                                     Inside [SLIDE]: Use # Title, ## Subtitle, * Bullet, **Bold**, _Italic_
                                 </p>
                                 <textarea id="lessonRawText" name="lessonRawText" rows="15" required class="input-field mt-1 font-mono text-sm" placeholder="[SLIDE]\n# My First Lesson\n## A Subtitle\n\nThis is a paragraph with **bold** and _italic_ text.\n\n* Bullet point 1\n* Bullet point 2\n\n[IMAGE: https://.../image.png]\n\n[QUESTION]\nWhat is 2+2?\na) 3\nb) 4\nAnswer: b\n\n[VIDEO: https://www.youtube.com/watch?v=...]">${rawLessonText}</textarea>
                             </div>
                             
                             <!-- Task 2.3: New Upload/Link Buttons -->
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="lessonFileUpload" class="block text-sm font-medium text-gray-700">Upload File (Stub)</label>
                                    <div class="flex gap-2">
                                        <input type="file" id="lessonFileUpload" name="lessonFileUpload" accept=".pdf,.png,.jpeg,.jpg,.ppt,.mp4,.webm" class="input-field text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
                                        <button type="button" data-action="add-lesson-file-tag" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Add</button>
                                    </div>
                                </div>
                                <div>
                                    <label for="lessonYouTubeLink" class="block text-sm font-medium text-gray-700">Add YouTube or Image Link</label>
                                    <div class="flex gap-2">
                                        <input type="url" id="lessonYouTubeLink" name="lessonYouTubeLink" class="input-field mt-1" placeholder="https://...">
                                        <button type="button" data-action="add-lesson-link-tag" class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200">Add</button>
                                    </div>
                                </div>
                             </div>
                             
                             <div id="lesson-editor-error" class="text-sm font-medium text-red-500" role="alert"></div>
                             
                             <div class="flex justify-end space-x-3 pt-4 border-t">
                                 <button type="button" data-action="close-lesson-modal" class="px-5 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200">Cancel</button>
                                 <button type="submit" class="px-5 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-md">Save Lesson</button>
                             </div>
                         </form>
                     </div>
                 </div>
             `;
         }

        function renderAssignmentModal() {
             const assignment = state.editingAssignment;
             if (!assignment) return '';

             // Format date for input type="date" (YYYY-MM-DD)
             let dueDateStr = '';
             if (assignment.dueDate) {
                 try {
                     const dateObj = new Date(assignment.dueDate.toDate ? assignment.dueDate.toDate() : assignment.dueDate);
                     // Adjust for timezone offset to get correct YYYY-MM-DD
                     dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset());
                     dueDateStr = dateObj.toISOString().split('T')[0];
                 } catch (e) {
                     console.warn("Could not parse due date:", assignment.dueDate, e);
                 }
             }


             return `
                 <div class="modal flex fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
                     <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-screen overflow-hidden flex flex-col card">
                         <div class="flex justify-between items-center p-5 border-b">
                             <h2 class="text-2xl font-bold text-gray-800">${state.isEditingAssignment ? 'Edit Assignment' : 'Create New Assignment'}</h2>
                             <button data-action="close-assignment-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
                         </div>
                         <form id="assignmentForm" class="flex-grow overflow-y-auto p-6 space-y-4">
                             <input type="hidden" name="assignmentId" value="${assignment.id || ''}">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div class="md:col-span-2">
                                     <label for="assignmentTitle" class="block text-sm font-medium text-gray-700">Assignment Title</label>
                                     <input type="text" id="assignmentTitle" name="assignmentTitle" required class="input-field mt-1" value="${assignment.title || ''}">
                                 </div>
                                 <div>
                                     <label for="assignmentGradeLevel" class="block text-sm font-medium text-gray-700">Grade Level</label>
                                     <select id="assignmentGradeLevel" name="assignmentGradeLevel" required class="input-field mt-1" onchange="updateSubjectDropdown('assignmentGradeLevel', 'assignmentSubject')">
                                         ${getGradeLevelOptions(assignment.gradeLevel)}
                                     </select>
                                 </div>
                                  <div>
                                     <label for="assignmentSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                                     <select id="assignmentSubject" name="assignmentSubject" required class="input-field mt-1">
                                          ${getSubjectOptions(assignment.gradeLevel, assignment.subject)}
                                     </select>
                                 </div>
                                 <!-- NEW: Quarter Field -->
                                 <div>
                                     <label for="assignmentQuarter" class="block text-sm font-medium text-gray-700">Quarter</label>
                                     <select id="assignmentQuarter" name="assignmentQuarter" required class="input-field mt-1">
                                          ${getQuarterOptions(assignment.quarter || 'Q1')}
                                     </select>
                                 </div>
                                  <div>
                                     <label for="assignmentDueDate" class="block text-sm font-medium text-gray-700">Due Date (Optional)</label>
                                     <input type="date" id="assignmentDueDate" name="assignmentDueDate" class="input-field mt-1" value="${dueDateStr}">
                                 </div>
                             </div>
                             <!-- NEW: Moved Attachment URL to its own row -->
                             <div>
                                 <label for="assignmentAttachmentUrl" class="block text-sm font-medium text-gray-700">Attachment URL (Optional)</label>
                                 <input type="url" id="assignmentAttachmentUrl" name="assignmentAttachmentUrl" class="input-field mt-1" placeholder="https://..." value="${assignment.attachmentUrl || ''}">
                             </div>
                              <div class="md:col-span-2">
                                 <label for="assignmentInstructions" class="block text-sm font-medium text-gray-700">Instructions</label>
                                 <textarea id="assignmentInstructions" name="assignmentInstructions" rows="5" required class="input-field mt-1">${assignment.instructions || ''}</textarea>
                             </div>
                             <div class="flex justify-end space-x-3 pt-4 border-t">
                                 <button type="button" data-action="close-assignment-modal" class="px-5 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200">Cancel</button>
                                 <button type="submit" class="px-5 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-md">Save Assignment</button>
                             </div>
                         </form>
                     </div>
                 </div>
             `;
         }
         
        // NEW: Payment Session Modal
        function renderPaymentModal() {
            const session = state.editingPaymentSession;
            if (!session) return '';

            const startDateStr = formatDateForInput(session.sessionStartDate);
            const endDateStr = formatDateForInput(session.sessionEndDate);
            const paymentStatuses = ['No Payment', 'Pending', 'Overdue', 'Paid'];

            return `
                <div class="modal flex fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-screen overflow-hidden flex flex-col card">
                        <div class="flex justify-between items-center p-5 border-b">
                            <h2 class="text-2xl font-bold text-gray-800">${state.isEditingPayment ? 'Edit Payment Record' : 'Create Payment Record'}</h2>
                            <button data-action="close-payment-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <form id="paymentSessionForm" class="flex-grow overflow-y-auto p-6 space-y-4">
                            <input type="hidden" name="paymentSessionId" value="${session.id || ''}">
                            <div>
                                <label for="paymentStudentId" class="block text-sm font-medium text-gray-700">Student</label>
                                <select id="paymentStudentId" name="paymentStudentId" required class="input-field mt-1" ${state.isEditingPayment ? 'disabled' : ''}>
                                    <option value="" disabled ${!session.studentId ? 'selected' : ''}>Select a student...</option>
                                    ${getStudentOptions(session.studentId)}
                                </select>
                                ${state.isEditingPayment ? '<p class="text-xs text-gray-500 mt-1">Student cannot be changed after creation.</p>' : ''}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="paymentStartDate" class="block text-sm font-medium text-gray-700">Session Start Date</label>
                                    <input type="date" id="paymentStartDate" name="paymentStartDate" required class="input-field mt-1" value="${startDateStr}">
                                </div>
                                <div>
                                    <label for="paymentEndDate" class="block text-sm font-medium text-gray-700">Session End Date</label>
                                    <input type="date" id="paymentEndDate" name="paymentEndDate" required class="input-field mt-1" value="${endDateStr}">
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="paymentAmountDue" class="block text-sm font-medium text-gray-700">Amount Due ()</label>
                                    <input type="number" id="paymentAmountDue" name="paymentAmountDue" min="0" step="0.01" required class="input-field mt-1" value="${session.amountDue || 0}">
                                </div>
                                <div>
                                    <label for="paymentStatus" class="block text-sm font-medium text-gray-700">Payment Status</label>
                                    <select id="paymentStatus" name="paymentStatus" required class="input-field mt-1">
                                        ${paymentStatuses.map(s => `<option value="${s}" ${session.paymentStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="paymentNotes" class="block text-sm font-medium text-gray-700">Notes / Reminder Message</label>
                                <textarea id="paymentNotes" name="paymentNotes" rows="3" class="input-field mt-1" placeholder="e.g., Pending balance of 500. Please settle before next session.">${session.notes || ''}</textarea>
                            </div>
                            <div id="payment-modal-error" class="text-sm font-medium text-red-500" role="alert"></div>
                            <div class="flex justify-end space-x-3 pt-4 border-t">
                                <button type="button" data-action="close-payment-modal" class="px-5 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200">Cancel</button>
                                <button type="submit" class="px-5 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-md">Save Record</button>
                            </div>
                        </form>
                    </div>
                 </div>
            `;
        }
        
        /* REMOVING DUPLICATE/UNUSED FUNCTIONS:
           - handleSavePaymentRecord (L2873)
           - handleDeletePaymentRecord (L2946)
           
           The correct functions `handleSavePaymentSession` (L2094) and 
           `handleDeletePaymentSession` (L2141) are already present and used.
        */
        

        // --- END OF NEW PAYMENT FUNCTIONS ---


        // Task 2.3: Helper to convert YouTube watch URL to embed URL
        function getYouTubeEmbedUrl(url) {
            if (!url) return null;
            let videoId = null;
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname;
                const pathname = urlObj.pathname;

                if (hostname === 'youtu.be') {
                    // e.g., https://youtu.be/VIDEO_ID
                    videoId = pathname.slice(1);
                } else if (hostname.includes('youtube.com')) {
                    if (pathname === '/watch') {
                        // e.g., https://www.youtube.com/watch?v=VIDEO_ID
                        videoId = urlObj.searchParams.get('v');
                    } else if (pathname.startsWith('/embed/')) {
                        // e.g., https://www.youtube.com/embed/VIDEO_ID
                        videoId = pathname.split('/')[2];
                    } else if (pathname.startsWith('/shorts/')) {
                        // e.g., https://www.youtube.com/shorts/VIDEO_ID
                        videoId = pathname.split('/')[2];
                    }
                }
                
                if (videoId) {
                    // Clean up potential extra query params from the videoId
                    videoId = videoId.split('?')[0].split('&')[0];
                    return `https://www.youtube.com/embed/${videoId}`;
                }
            } catch (e) {
                console.warn("Could not parse video URL:", url, e);
            }
            // If no match, return null
            return null;
        }

        // ### NEW: MARKDOWN PARSER FOR LESSON SLIDES ###
        function parseSlideMarkdown(text) {
            if (!text) return '';
            
            return text
                .trim()
                // Process blocks (split by double newline)
                .split(/\n\s*\n+/) // Split by one or more empty lines
                .map(block => {
                    block = block.trim();
                    if (block.length === 0) return '';

                    // # Title
                    if (block.startsWith('# ')) {
                        // ### FIX: Use h1 tag, not slide-text-content class ###
                        return `<h1>${block.substring(2)}</h1>`;
                    }
                    // ## Subtitle
                    if (block.startsWith('## ')) {
                        // ### FIX: Use h2 tag, not slide-text-content class ###
                        return `<h2>${block.substring(3)}</h2>`;
                    }
                    // * Bullet points
                    if (block.startsWith('* ')) {
                        const items = block.split('\n')
                            .filter(line => line.trim().startsWith('* '))
                            .map(line => `<li>${
                                line.trim().substring(2).trim()
                                    .replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>')
                                    .replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>')
                            }</li>`)
                            .join('');
                        // ### FIX: Use ul tag, not slide-text-content class ###
                        return `<ul>${items}</ul>`;
                    }
                    
                    // Standard paragraph
                    // We must process inline styles *within* the paragraph
                    // ### FIX: Use p tag, not slide-text-content class ###
                    let processedParagraph = '<p>' + block
                        // **Bold** or __Bold__
                        .replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>')
                        // *Italic* or _Italic_
                        .replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>')
                        // Handle line breaks within a paragraph
                        .replace(/\n/g, '<br>')
                        + '</p>';
                        
                    return processedParagraph;
                })
                .join('');
        }


        // ### MODIFICATION: REPLACING renderViewLesson with Presentation Mode ###
        function renderViewLesson() {
            if (!state.selectedLessonBook) {
                // This will be inside the presentation view, show a loading/error state
                return `
                    <div class="presentation-view">
                        <div class="presentation-slide-container">
                            <div class="presentation-slide-content">
                                <p class="text-xl text-gray-500">Loading lesson...</p>
                            </div>
                        </div>
                        <nav class="presentation-nav">
                             <button data-action="back-to-dashboard" class="presentation-nav-btn">Back to Dashboard</button>
                        </nav>
                    </div>
                `;
            }

            const lesson = state.selectedLessonBook;
            const slides = lesson.slides || [];
            if (slides.length === 0) {
                 return `
                    <div class="presentation-view">
                        <div class="presentation-slide-container">
                            <div class="presentation-slide-content">
                                <p class="text-xl text-gray-500">This lesson has no slides yet.</p>
                            </div>
                        </div>
                        <nav class="presentation-nav">
                             <button data-action="back-to-dashboard" class="presentation-nav-btn">Back to Dashboard</button>
                        </nav>
                    </div>
                `;
            }
            
            const slide = slides[state.currentLessonSlideIndex];
            if (!slide) {
                 console.error("Slide index out of bounds:", state.currentLessonSlideIndex, "Slides:", slides);
                 state.currentLessonSlideIndex = 0; // Reset index
                 // Re-call renderApp to fix the view
                 renderApp();
                 return;
            }

            const progress = state.lessonBookProgress[lesson.id] || { answers: [] };
            const currentAnswerData = progress.answers?.find(a => a.slideIndex === state.currentLessonSlideIndex);
            const isCompleted = progress?.completed;
            const calculatedLength = lesson.slides?.filter(s => s.type === 'QUESTION' && s.question && s.question.trim() !== '').length;
            const totalQuestions = progress?.totalQuestions ?? (calculatedLength || 0);

            // Function to render the inner content of a slide
            function getSlideHtml(slide) {
                switch(slide.type) {
                    case 'SLIDE':
                        const slideContent = slide.text || '';
                        // Basic check for image URL
                        if (/\.(jpeg|jpg|gif|png|webp)(\?.*)?$/i.test(slideContent) || slideContent.startsWith('data:image/')) {
                            return `<img src="${slideContent}" alt="Lesson image" class="max-w-full max-h-full object-contain" onerror="this.onerror=null;this.parentElement.innerHTML='<p class=\\'text-red-500\\'>Error loading image.</p>';">`;
                        }
                        // ### NEW: Render text content with markdown parser ###
                        const formattedHtml = parseSlideMarkdown(slideContent);
                        // ### FIX: Apply .slide-text-content class to the *wrapper* ###
                        return `<div class="slide-text-content">${formattedHtml || '<p class="text-gray-400 italic">No content for this slide.</p>'}</div>`;
                    case 'IMAGE':
                        return `<img src="${slide.url}" alt="Lesson image" class="max-w-full max-h-full object-contain" onerror="this.onerror=null;this.parentElement.innerHTML='<p class=\\'text-red-500 text-xl\\'>Error loading image: ${slide.url}</p>';">`;
                    case 'VIDEO':
                        const embedUrl = getYouTubeEmbedUrl(slide.url);
                        if (embedUrl) {
                            // YouTube Embed
                            return `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>`;
                        // ### NEW: HTML5 Video Player ###
                        } else if (/\.(mp4|webm|ogg)(\?.*)?$/i.test(slide.url) || slide.url.startsWith('data:video/')) {
                            return `<video controls class="w-full h-full" src="${slide.url}">Your browser does not support the video tag.</video>`;
                        } else {
                            return `<p class="text-red-500 text-xl">Invalid or unsupported video link: <a href="${slide.url}" target="_blank" class="underline">${slide.url}</a></p>`;
                        }
                    case 'FILE':
                         return `<a href="${slide.url}" target="_blank" rel="noopener noreferrer" class="px-6 py-4 bg-blue-600 text-white text-xl font-medium rounded-lg hover:bg-blue-700 inline-block shadow-lg"> View Attached File</a>`;
                    case 'QUESTION':
                        // Special layout for questions
                        const colors = ['bg-red-600', 'bg-blue-600', 'bg-yellow-500', 'bg-green-600'];
                        const options = slide.options || {};
                        const optionKeys = Object.keys(options);

                        return `
                            <div class="flex flex-col md:flex-row w-full h-full">
                                <!-- Question Panel (Left) -->
                                <div class="w-full md:w-1/2 h-1/2 md:h-full flex items-center justify-center p-6 bg-white">
                                    <p class="text-2xl lg:text-3xl font-bold text-gray-800 text-center">${slide.question}</p>
                                </div>
                                <!-- Answer Panel (Right) -->
                                <div class="w-full md:w-1/2 h-1/2 md:h-full flex items-center justify-center p-6 bg-gray-100">
                                    <div class="question-grid w-full">
                                        ${optionKeys.map((key, index) => {
                                            const value = options[key];
                                            const colorClass = colors[index % colors.length];
                                            
                                            let stateClass = '';
                                            if (currentAnswerData) {
                                                // Feedback is shown
                                                if (key === slide.answer) {
                                                    stateClass = 'correct'; // Always show correct answer
                                                } else if (key === currentAnswerData.answer) {
                                                    stateClass = 'incorrect'; // Show user's wrong answer
                                                } else {
                                                    stateClass = 'opacity-50 !bg-gray-500'; // Fade out non-selected, non-correct answers
                                                }
                                            } else if (state.selectedAnswer === key) {
                                                // User has selected but not confirmed (this happens instantly)
                                                stateClass = 'selected';
                                            }
                                            
                                            return `
                                                <button 
                                                    onclick="submitLessonAnswer('${lesson.id}', ${state.currentLessonSlideIndex}, '${key}')"
                                                    class="question-option-btn ${colorClass} ${stateClass}"
                                                    ${currentAnswerData ? 'disabled' : ''}
                                                >
                                                    ${key}. ${value}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    default:
                        return `<p class="text-gray-400 italic text-xl">Unknown slide type.</p>`;
                }
            }
            
            const slideContentHtml = getSlideHtml(slide);

            return `
                <div class="presentation-view">
                    <!-- Header: Title and Close Button -->
                    <header class="presentation-header">
                        <h1 class="text-lg font-semibold text-gray-800 truncate pr-4">${lesson.title}</h1>
                        <button data-action="back-to-dashboard" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
                    </header>
                    
                    <!-- Main Slide Container -->
                    <div class="presentation-slide-container">
                        <div class="presentation-slide-content ${slide.type === 'QUESTION' ? '!p-0' : ''}">
                            ${slideContentHtml}
                        </div>
                         ${lesson.attachmentUrl ? `<div class="p-2 text-center bg-gray-50 border-t"><a href="${lesson.attachmentUrl}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 font-medium hover:underline"> View Main Attached File</a></div>` : ''}
                    </div>

                    <!-- Navigation -->
                    <nav class="presentation-nav">
                         <button data-action="previous-lesson-slide" ${state.currentLessonSlideIndex === 0 ? 'disabled' : ''} 
                                 class="presentation-nav-btn">
                             &larr; Previous
                         </button>
                         
                         <p class="text-gray-600 font-medium">
                            Slide ${state.currentLessonSlideIndex + 1} of ${slides.length}
                         </p>

                         ${state.currentLessonSlideIndex === slides.length - 1
                            ? `<button data-action="complete-lesson" data-id="${lesson.id}" 
                                      class="presentation-nav-btn !bg-green-600 !text-white hover:!bg-green-700 ${totalQuestions === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                      ${totalQuestions === 0 ? 'disabled title="No questions to score"' : ''}>
                                   ${isCompleted ? 'Finish Again' : 'Complete Lesson'} &rarr;
                               </button>`
                            : `<button data-action="next-lesson-slide" class="presentation-nav-btn">
                                   Next &rarr;
                               </button>`
                         }
                    </nav>
                </div>
            `;
        }

        // --- NEW: Render function for Virtual Classroom View ---
        function renderVirtualClassroom() {
            if (!state.selectedRoomId || !state.selectedRoomTopic) {
                console.error("Missing room ID or topic, cannot render classroom.");
                // Immediately navigate back
                setTimeout(() => navigateTo('dashboard'), 0);
                return `<div class="p-8 text-center">Invalid meeting link...</div>`;
            }

            return `
                <div class="virtual-classroom-view">
                    <!-- Header with Leave Button -->
                    <header class="virtual-classroom-header">
                        <h1 class="text-lg font-bold text-gray-800 truncate pr-4">${state.selectedRoomTopic}</h1>
                        <button data-action="leave-meeting" class="px-5 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 shadow-md">
                            Leave Class
                        </button>
                    </header>
                    
                    <!-- Jitsi Meet Iframe Container -->
                    <div id="jitsi-container">
                        <!-- Jitsi API will create the iframe here -->
                    </div>
                </div>
            `;
        }


        function renderViewAssignment() {
             if (!state.selectedAssignment) {
                 return `<div class="p-8 text-center">Loading assignment... <button data-action="back-to-dashboard" class="text-blue-500 underline">Back</button></div>`;
             }

             const assignment = state.selectedAssignment;
             const submission = state.myAssignmentSubmissions[assignment.id];
             const dueDate = assignment.dueDate ? new Date(assignment.dueDate.toDate()) : null; // Use .toDate()
             const grade = submission?.grade;
             
             // *** TASK 2 (Assignment) FIX: Check what type of submission file exists ***
             let submissionFileHtml = '';
             if (submission?.submissionFile) {
                 const fileData = submission.submissionFile;
                 if (fileData.startsWith('data:image/')) {
                     submissionFileHtml = `<p class="text-xs text-gray-500 mt-1">Current submission:</p><img src="${fileData}" class="max-w-xs h-auto rounded-md shadow-sm mt-1 mb-2">`;
                 } else if (fileData.startsWith('data:')) {
                     submissionFileHtml = `<p class="text-xs text-gray-500 mt-1">Current submission: <a href="${fileData}" download="${assignment.title.replace(/ /g, '_')}_submission" class="text-blue-600 underline">Download File</a> (Uploading a new file will replace this)</p>`;
                 } else {
                     submissionFileHtml = `<p class="text-xs text-gray-500 mt-1">Current file: ${fileData} (Uploading a new file will replace this)</p>`;
                 }
             }
             // *** END TASK 2 FIX ***


             return `
                 <div class="min-h-screen bg-gray-50 p-4 sm:p-8">
                     <div class="max-w-3xl mx-auto">
                         <header class="flex justify-between items-center py-4 border-b border-blue-300 mb-6">
                             <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">${assignment.title}</h1>
                             <button data-action="back-to-dashboard" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 text-sm">Back to Dashboard</button>
                         </header>

                         <div class="p-6 bg-white rounded-xl shadow-lg card mb-6">
                             <div class="mb-4 pb-4 border-b">
                                  <p class="text-sm text-gray-500">Subject: <span class="font-medium text-gray-700">${assignment.subject || 'N/A'}</span></p>
                                 ${dueDate ? `<p class="text-sm text-gray-500">Due: <span class="font-medium text-gray-700">${dueDate.toLocaleDateString()}</span></p>` : ''}
                                 ${assignment.attachmentUrl ? `<a href="${assignment.attachmentUrl}" target="_blank" rel="noopener noreferrer" class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 font-medium rounded-md hover:bg-blue-200 inline-block"> View Assignment File</a>` : ''}
                             </div>
                             <div class="prose max-w-none mb-6">
                                 <p class="text-gray-700 whitespace-pre-wrap">${assignment.instructions || 'No instructions provided.'}</p>
                             </div>
                         </div>

                         <div class="p-6 bg-white rounded-xl shadow-lg card">
                             <h2 class="text-2xl font-bold text-gray-800 mb-4">My Submission</h2>
                             ${grade !== undefined && grade !== null ? `
                                 <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg mb-4">
                                     <h3 class="text-xl font-bold text-emerald-700">Grade: ${grade} / 100</h3>
                                 </div>
                             ` : (submission ? `
                                 <div class="p-3 bg-green-50 border border-green-200 rounded-lg mb-4">
                                     <p class="text-sm font-medium text-green-700">Submitted on ${submission.submissionTimestamp ? new Date(submission.submissionTimestamp.toDate()).toLocaleString() : 'N/A'}. Awaiting grade.</p>
                                 </div>
                             ` : '')}

                             <!-- Hidden submission form -->
                             <form id="assignmentSubmissionForm" style="${submission ? 'display: none;' : 'display: block;'}" class="space-y-4">
                                 <input type="hidden" name="submitAssignmentId" value="${assignment.id}">
                                 <div>
                                     <label for="submissionText" class="block text-sm font-medium text-gray-700">Your Answer / Text Submission</label>
                                     <textarea id="submissionText" name="submissionText" rows="6" class="input-field mt-1" placeholder="Type your answer here...">${submission?.submissionText || ''}</textarea>
                                 </div>
                                 <!-- Task 2.2: Replace URL input with File input -->
                                 <div>
                                     <label for="submissionFile" class="block text-sm font-medium text-gray-700">Upload File (PDF, PNG, JPG)</label>

                                     <input type="file" id="submissionFile" name="submissionFile" accept=".pdf,.png,.jpeg,.jpg"
                                            class="input-field text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                                     <!-- *** TASK 2 (Assignment) FIX: Show file preview/link *** -->
                                     ${submissionFileHtml}
                                     <!-- *** END TASK 2 FIX *** -->
                                 </div>
                                 <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-emerald-700 shadow-md">
                                     ${submission ? 'Update Submission' : 'Submit Assignment'}
                                 </button>
                             </form>

                             <!-- Show "Edit" button if submitted -->
                              ${submission ? `
                                 <button id="edit-submission-button" data-action="edit-submission" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300">
                                     Edit Submission
                                 </button>
                              ` : ''}
                         </div>
                     </div>
                 </div>
             `;
         }

        function renderQuiz() {
             if (state.quizData.length === 0 || state.currentQuestionIndex >= state.quizData.length) {
                 return `<div class="p-8 text-center">Loading quiz... <button data-action="back-to-dashboard" class="text-blue-500 underline">Back</button></div>`;
             }
             const currentQ = state.quizData[state.currentQuestionIndex];
             const questionType = currentQ.type || 'MC'; // Default to MC

             return `
                 <div class="min-h-screen bg-gray-50 p-4 sm:p-8">
                     <div class="max-w-2xl mx-auto">
                         <!-- Header -->
                         <header class="flex justify-between items-center py-4 mb-4">
                             <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">${state.quizSubject} Quiz</h1>
                             <button data-action="save-and-back" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 text-sm">
                                 Save & Back
                             </button>
                         </header>

                         <!-- Progress -->
                         <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                             <div class="bg-emerald-600 h-2.5 rounded-full" style="width: ${((state.currentQuestionIndex + 1) / state.quizData.length) * 100}%"></div>
                         </div>

                         <!-- Question Card -->
                         <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 card">
                             <p class="text-sm font-semibold text-emerald-600 mb-2">Question ${state.currentQuestionIndex + 1} of ${state.quizData.length}</p>
                             
                             <!-- NEW: Introduction -->
                             ${currentQ.introduction ? `
                                 <div class="text-gray-600 italic border-l-4 border-gray-200 pl-4 mb-4">
                                     <p class="whitespace-pre-wrap">${currentQ.introduction}</p>
                                 </div>
                             ` : ''}
                             <!-- END NEW -->

                             <p class="text-lg font-medium text-gray-900 mb-6 whitespace-pre-wrap">${currentQ.question}</p>
                             
                             <!-- NEW: Question Image -->
                             ${currentQ.questionImage ? `
                                 <div class="mb-6">
                                     <img src="${currentQ.questionImage}" alt="Question visual aid" class="max-w-full h-auto rounded-md shadow-sm mx-auto" onerror="this.onerror=null;this.parentElement.innerHTML='<p class=\\'text-red-500 text-center\\'>Error loading image.</p>';">
                                 </div>
                             ` : ''}
                             <!-- END NEW -->

                             <!-- Answer Options -->
                             <div class="space-y-3 ${currentQ.questionImage ? 'mt-6' : ''}"> <!-- NEW: Add margin if image exists -->
                                 ${questionType === 'MC' || questionType === 'TF' ?
                                     Object.entries(currentQ.options).map(([key, value]) => `
                                         <label class="flex items-center p-4 border rounded-lg cursor-pointer transition-colors ${
                                             state.selectedAnswer === key ? 'bg-emerald-50 border-emerald-300 shadow-sm' : 'bg-gray-50 hover:bg-gray-100'
                                         } ${state.quizFeedback ? 'opacity-70 cursor-not-allowed' : ''}">
                                             <input type="radio" name="answer" value="${key}"
                                                    onchange="handleAnswerSelection(event)"
                                                    ${state.selectedAnswer === key ? 'checked' : ''}
                                                    ${state.quizFeedback ? 'disabled' : ''}
                                                    class="h-4 w-4 text-emerald-600 border-gray-300 focus:ring-emerald-500">
                                             <span class="ml-3 text-sm font-medium text-gray-800">${key}. ${value}</span>
                                         </label>
                                     `).join('')
                                 : questionType === 'FillIn' ?
                                     `<div>
                                         <label for="answerInput_${currentQ.id || (state.currentQuestionIndex + 1)}" class="block text-sm font-medium text-gray-700 mb-1">Your Answer:</label>
                                         <input type="text" id="answerInput_${currentQ.id || (state.currentQuestionIndex + 1)}" name="answer"
                                                value="${state.selectedAnswer || ''}"
                                                oninput="handleAnswerSelection(event)"
                                                ${state.quizFeedback ? 'disabled' : ''}
                                                class="input-field"
                                                placeholder="Type your answer...">
                                     </div>`
                                 : ''}
                             </div>

                             <!-- Feedback Section -->
                             ${state.quizFeedback ? `
                                 <div class="mt-6 p-4 rounded-lg ${state.quizFeedback.isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                     <h3 class="text-lg font-semibold ${state.quizFeedback.isCorrect ? 'text-green-800' : 'text-red-800'}">
                                         ${state.quizFeedback.isCorrect ? 'Correct!' : 'Incorrect'}
                                     </h3>
                                     ${!state.quizFeedback.isCorrect ? `
                                         <p class="text-sm text-red-700 mt-1">
                                             Correct Answer: <span class="font-bold">${currentQ.answer}</span>
                                         </p>
                                     ` : ''}
                                      ${currentQ.discussion ? `
                                         <p class="text-sm text-gray-700 mt-2">
                                             <strong>Discussion:</strong> ${currentQ.discussion}
                                         </p>
                                      ` : ''}
                                 </div>
                             ` : ''}

                             <!-- Action Buttons -->
                             <div class="flex justify-end mt-8">
                                 ${state.quizFeedback ? `
                                     <button data-action="next-question" class="w-full sm:w-auto px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700">
                                         ${state.currentQuestionIndex === state.quizData.length - 1 ? 'Finish Quiz' : 'Next Question'}
                                     </button>
                                 ` : `
                                     <button id="submit-answer-button" data-action="submit-answer"
                                             ${!state.selectedAnswer || (typeof state.selectedAnswer === 'string' && !state.selectedAnswer.trim()) ? 'disabled' : ''}
                                             class="w-full sm:w-auto px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                         Submit Answer
                                     </button>
                                 `}
                             </div>
                         </div>
                     </div>
                 </div>
             `;
         }

        function renderResult() {
            const score = state.quizResponses.filter(r => r.isCorrect).length;
            const total = state.quizData.length;
            const percentage = total > 0 ? (score / total) * 100 : 0;
            // FIX: Changed ( ... ) to [ ... ] for array destructuring
            const resultData = percentage >= 80
                ? ["Great Job!", "text-green-600", ""]
                : percentage >= 50
                ? ["Good Effort!", "text-orange-500", ""]
                : ["Keep Practicing!", "text-red-500", ""];
            const percentageText = resultData[0];
            const colorClass = resultData[1];
            const emoji = resultData[2];

            const isArchived = state.allQuizzes.find(q => q.id === state.quizId)?.status === 'archived';


             return `
                 <div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                     <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl card p-8 text-center">
                         <h1 class="text-3xl font-bold text-gray-800 mb-2">${percentageText} ${emoji}</h1>
                         <p class="text-lg text-gray-600 mb-6">You completed the ${state.quizSubject} quiz.</p>
                         <div class="mb-8">
                             <p class="text-6xl font-extrabold ${colorClass}">${score} / ${total}</p>
                             <p class="text-2xl font-semibold ${colorClass}">(${percentage.toFixed(0)}%)</p>
                         </div>

                         <!-- Review Section -->
                         <div class="text-left max-h-60 overflow-y-auto space-y-4 border p-4 rounded-lg bg-gray-50 mb-8">
                             <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Review Your Answers</h3>
                             ${state.quizResponses.map((response, index) => {
                                 const question = state.quizData.find(q => q.id === response.questionId) || state.quizData[index]; // Fallback
                                 if (!question) return ''; // Safety check if question not found
                                 const isFillIn = question.type === 'FillIn';
                                 return `
                                     <div class="pb-3 ${index < state.quizResponses.length - 1 ? 'border-b' : ''}">
                                         <p class="text-sm font-medium text-gray-800">${index + 1}. ${question.question}</p>
                                         ${response.isCorrect ? `
                                             <p class="text-sm text-green-600">
                                                 Your answer: <span class="font-semibold">${response.response}</span> (Correct)
                                             </p>
                                         ` : `
                                             <p class="text-sm text-red-600">
                                                 Your answer: <span class="font-semibold">${response.response}</span>
                                             </p>
                                             <p class="text-sm text-gray-700">
                                                 Correct answer: <span class="font-semibold">${response.correctAnswer}</span>
                                             </p>
                                         `}
                                     </div>
                                 `;
                             }).join('')}
                         </div>

                         <div class="flex flex-col sm:flex-row gap-3">
                             ${!isArchived ? `
                             <button data-action="try-quiz-again" data-id="${state.quizId}" class="flex-1 px-5 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                                 Try Again
                             </button>
                             ` : ''}
                             <button data-action="back-to-dashboard" class="${isArchived ? 'w-full' : 'flex-1'} px-5 py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-md transition-colors">
                                 Back to Dashboard
                             </button>
                         </div>
                     </div>
                 </div>
             `;
        }

        function renderApp() {
            const root = document.getElementById('app-content');
            if (!root) {
                console.error("Root element 'app-content' not found!");
                return;
            }

            // Centralized click/input handlers
            root.onclick = handleAppClick;
            root.oninput = handleAppInput; // This is safe now, but handleAppInput is assigned to window later

            let content = '';
            try {
                switch (state.view) {
                    case 'login': content = renderLogin(); break;
                    case 'dashboard': content = renderDashboard(); break;
                    case 'quiz': content = renderQuiz(); break;
                    case 'result': content = renderResult(); break;
                    case 'viewLesson': content = renderViewLesson(); break;
                    case 'viewAssignment': content = renderViewAssignment(); break;
                    case 'virtualClassroom': content = renderVirtualClassroom(); break; // NEW VIEW
                    case 'reviewQuiz': content = renderQuizReview(); break;
                    default: content = renderLogin();
                }
                root.innerHTML = content;
            } catch (error) {
                 console.error("Error during rendering:", error);
                 root.innerHTML = `<div class="p-6 text-center text-red-600 bg-red-100 rounded-lg">A critical error occurred while rendering the page. Check the console. Error: ${error.message}</div>`;
            }

            // --- Re-attach essential event listeners after innerHTML update ---
            try {
                 if (state.view === 'login') {
                    // Find the form and attach the submit listener *explicitly*
                    const loginForm = document.getElementById('login-form');
                    if (loginForm) {
                         loginForm.onsubmit = (e) => {
                             e.preventDefault();
                             handleLogin(e.target.username.value, e.target.password.value);
                         };
                    }
                } else if (state.view === 'dashboard') { // --- EDIT: Handle teacher AND admin ---
                     if (state.currentUser?.role === 'teacher') {
                         // Attach listeners based on the current tab
                         const announcementForm = document.getElementById('announcement-form');
                         if (announcementForm) {
                             announcementForm.onsubmit = handlePostAnnouncement;
                         }
                         const quizEditorForm = document.getElementById('quiz-editor-form');
                         if (quizEditorForm) {
                             quizEditorForm.onsubmit = handleSaveQuiz;
                         }
                         // NEW: Attach listener for create meeting form
                         const createMeetingForm = document.getElementById('create-meeting-form');
                         if (createMeetingForm) {
                             createMeetingForm.onsubmit = handleCreateMeeting;
                         }
                     }
                     
                     // Attach form listeners ONLY when the modal is open and rendered
                     const lessonBookForm = document.getElementById('lessonBookForm');
                     if (state.isLessonModalOpen && lessonBookForm) {
                         lessonBookForm.onsubmit = handleSaveLessonBook;
                         // Task 2: renderModalSlides() is no longer needed here
                         // renderModalSlides(); 
                     }
                     const assignmentForm = document.getElementById('assignmentForm');
                     if (state.isAssignmentModalOpen && assignmentForm) {
                         assignmentForm.onsubmit = handleSaveAssignment;
                     }
                     // NEW: Attach listener for payment modal
                     const paymentSessionForm = document.getElementById('paymentSessionForm');
                     if (state.isPaymentModalOpen && paymentSessionForm) {
                         paymentSessionForm.onsubmit = handleSavePaymentSession;
                     }
                     // --- NEW: Attach listener for admin user modal ---
                     const userForm = document.getElementById('userForm');
                     if (state.isUserModalOpen && userForm) {
                         userForm.onsubmit = handleSaveUser;
                     }
 
                } else if (state.view === 'viewAssignment' && state.currentUser?.role === 'student') {
                     // Attach listener for the submission form
                     const submissionForm = document.getElementById('assignmentSubmissionForm');
                         if (submissionForm) {
                             submissionForm.onsubmit = handleSubmitAssignment;
                         }
                }
                 // Ensure fill-in quiz input retains focus after feedback render (if applicable)
                 if (state.view === 'quiz') {
                     const currentQ = state.quizData[state.currentQuestionIndex];
                     if(currentQ) { // Add safety check
                         const questionType = currentQ.type || 'MC';
                         if(questionType === 'FillIn' && state.quizFeedback !== null) {
                            const inputId = `answerInput_${currentQ.id || (state.currentQuestionIndex + 1)}`;
                            document.getElementById(inputId)?.focus();
                         }
                     }
                 }
                 // --- NEW: Initialize Jitsi Meet AFTER container is rendered ---
                 if (state.view === 'virtualClassroom') {
                    // We must wait for the DOM to update before initializing Jitsi
                    setTimeout(initJitsiMeet, 0);
                 }
            } catch (error) {
                 console.error("Error attaching event listeners:", error);
            }

            // --- Manage Loading Overlay ---
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.toggle('hidden', !state.loading);
                // Use 'flex' for display to center content
                loadingOverlay.classList.toggle('flex', state.loading);
            }
        }

        // Task 1: Add new functions for quiz loading
        function startNewQuiz(quizId) { // CHANGED: parameter is quizId
            const grade = state.currentUser.grade;
            const key = `unfinishedQuiz_${state.currentUser.username}_${quizId}`; // CHANGED: Use quizId
            try { localStorage.removeItem(key); } catch (e) { console.warn("Could not remove item from localStorage:", e); }

            // Find the quiz data from Firestore state
            const quiz = state.allQuizzes.find(q => q.id === quizId); // CHANGED: Find by quizId

            if (quiz && quiz.questions) {
                state.quizId = quizId; // NEW: Set quizId
                state.quizSubject = quiz.subject; // NEW: Set subject
                state.quizData = quiz.questions; // Load questions from Firestore data
                state.currentQuestionIndex = 0; // Reset index
                state.quizResponses = []; // Reset responses
                state.selectedAnswer = null; // Reset selection
                state.quizFeedback = null; // Reset feedback
                navigateTo('quiz'); // CHANGED: No argument, state is set here
            } else {
                console.error(`Quiz not found or has no questions for quizId: ${quizId}`);
                // Optionally show an error message to the user before navigating back
                // alert(`Quiz for ${subject} (Grade ${grade}) is not available.`);
                navigateTo('dashboard');
            }
        }

        function loadAndContinueQuiz(quizId) { // CHANGED: parameter is quizId
            const grade = state.currentUser.grade;
            const key = `unfinishedQuiz_${state.currentUser.username}_${quizId}`; // CHANGED: Use quizId
            let savedProgressJSON = null;
            try { savedProgressJSON = localStorage.getItem(key); } catch (e) { console.warn("Could not access localStorage:", e); }

            // Find the quiz data from Firestore state FIRST
            const quiz = state.allQuizzes.find(q => q.id === quizId); // CHANGED: Find by quizId

            if (!quiz || !quiz.questions) {
                 console.error(`Quiz not found or has no questions for quizId: ${quizId} during continuation.`);
                 // alert(`Quiz for ${subject} (Grade ${grade}) is not available or has changed.`);
                 try { localStorage.removeItem(key); } catch (e) {} // Clear invalid progress
                 navigateTo('dashboard');
                 return;
            }

            state.quizId = quizId; // NEW: Set quizId
            state.quizSubject = quiz.subject; // NEW: Set subject
            state.quizData = quiz.questions; // Load current questions

            if (savedProgressJSON) {
                const savedProgress = JSON.parse(savedProgressJSON);
                // Set initial quiz state
                state.view = 'quiz'; // Explicitly set view here for navigation
                state.quizFeedback = null; // Clear feedback when continuing
                state.selectedAnswer = null; // Clear selected answer

                // Load progress from localStorage
                state.quizResponses = Array.isArray(savedProgress.responses) ? savedProgress.responses : [];
                state.currentQuestionIndex = savedProgress.currentQuestionIndex || 0;

                // Validate index against current quiz data length
                if (state.currentQuestionIndex >= state.quizData.length) {
                    console.warn("Saved quiz index is out of bounds for current quiz data. Resetting.");
                    state.currentQuestionIndex = 0;
                    state.quizResponses = []; // Reset responses too if index was invalid
                     try { localStorage.removeItem(key); } catch (e) {} // Clear invalid progress
                }

                // Pre-load the answer for the question we are landing on, if it exists in saved responses
                const currentResponse = state.quizResponses[state.currentQuestionIndex];
                if (currentResponse) {
                    state.selectedAnswer = currentResponse.response;
                }

                renderApp(); // Render the quiz view with loaded state
            } else {
                // If no saved progress, start a new quiz (which also loads the data)
                startNewQuiz(quizId); // CHANGED: pass quizId
            }
        }

        function viewLessonBook(lessonBookId) {
             navigateTo('viewLesson', lessonBookId);
        }

        // --- END OF RE-ADDED FUNCTIONS ---


        // --- Event Delegation Handlers ---
        // *** TASK 3 (Lesson Book) FIX: Make handleAppClick async ***
        async function handleAppClick(event) {
            // Find the closest button or link with data-action
            const target = event.target.closest('button[data-action], a[data-action], img[data-action]'); 

            if (!target) return; // Exit if the click wasn't on or inside a relevant element

            const action = target.dataset.action;
            const subject = target.dataset.subject; // Used by quiz actions
            const id = target.dataset.id;           // Used by delete/edit/view actions
            const tab = target.dataset.tab;         // Used by tab navigation
            const slideIndexStr = target.dataset.slideIndex; // Used by remove slide
            const status = target.dataset.status; // NEW: For archive button
            const topic = target.dataset.topic; // NEW: For joining meetings

            // console.log(`Clicked action: ${action}, Subject: ${subject}, ID: ${id}, Tab: ${tab}, SlideIndex: ${slideIndexStr}`); // Debug log

            try {
                switch (action) {
                    // Quiz Actions (Student)
                    case 'start-new-quiz':
                        if (id) startNewQuiz(id); // CHANGED: Use id
                        break;
                    case 'continue-quiz':
                        if (id) loadAndContinueQuiz(id); // CHANGED: Use id
                        break;

                    // Quiz Taking Actions (Student)
                    case 'submit-answer':
                         checkAnswerAndProvideFeedback();
                         break;
                    case 'next-question':
                         nextQuestion();
                         break;
                     case 'save-and-back': // Quiz view save button
                         saveProgress();
                         navigateTo('dashboard');
                         break;

                     // Result View Actions (Student)
                     case 'back-to-dashboard': // Result view button AND Lesson/Assignment view
                         navigateTo('dashboard');
                         break;
                     case 'try-quiz-again': // Result view button
                         if (id) startNewQuiz(id); // CHANGED: Use id
                         break;
                     case 'review-quiz':
                        if (id) navigateTo('reviewQuiz', id);
                        break;

                     // General Navigation & State
                     case 'logout':
                         handleLogout();
                         break;
                     case 'set-dashboard-tab':
                         if (tab) setDashboardTab(tab);
                         break;

                    // Announcements (Teacher)
                    case 'delete-announcement':
                        if (id) handleDeleteAnnouncement(id);
                        break;

                    // Lesson Books (Teacher & Student)
                    case 'open-lesson-modal': // Teacher
                        openLessonBookModal(id); // id might be undefined for 'create new'
                        break;
                     case 'close-lesson-modal': // Teacher (Modal Cancel)
                         closeLessonBookModal();
                         break;
                     // *** TASK 3 (Lesson Book) FIX: Implement file-to-base64 logic ***
                     case 'add-lesson-file-tag':
                         const fileInput = document.getElementById('lessonFileUpload');
                         if (fileInput && fileInput.files[0]) {
                             const file = fileInput.files[0];
                             setLoading(true); // Show loading while reading file
                             try {
                                 const fileDataUrl = await new Promise((resolve, reject) => {
                                     const reader = new FileReader();
                                     reader.onload = e => resolve(e.target.result);
                                     reader.onerror = e => reject(new Error("Error reading file"));
                                     reader.readAsDataURL(file);
                                 });

                                 const textarea = document.getElementById('lessonRawText');
                                 let tag = 'FILE'; // Default tag
                                 if (file.type.startsWith('image/')) {
                                     tag = 'IMAGE';
                                 } else if (file.type.startsWith('video/')) {
                                     tag = 'VIDEO';
                                 }
                                 textarea.value += `\n\n[${tag}: ${fileDataUrl}]`; // Use data URL
                                 fileInput.value = ''; // Clear input

                             } catch (e) {
                                  console.error("Error reading file:", e);
                                  // Fallback to filename (though this won't work for playback)
                                  const textarea = document.getElementById('lessonRawText');
                                  textarea.value += `\n\n[FILE: ${file.name}]`;
                                  fileInput.value = ''; // Clear input
                             } finally {
                                 setLoading(false); // Hide loading
                             }
                         } else {
                             console.warn("No file selected.");
                         }
                         break;
                    // *** END TASK 3 FIX ***
                    case 'add-lesson-link-tag':
                        const linkInput = document.getElementById('lessonYouTubeLink');
                        if (linkInput && linkInput.value) {
                            const url = linkInput.value.trim();
                            const textarea = document.getElementById('lessonRawText');
                            let tag = `[IMAGE: ${url}]`; // Default to image
                            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                                tag = `[VIDEO: ${url}]`;
                            }
                            textarea.value += `\n\n${tag}`;
                            linkInput.value = ''; // Clear input
                        }
                        break;
                     case 'add-slide-to-modal': // Teacher (Modal Add Slide)
                         // Task 2: Obsolete
                         // addSlideToModal();
                         console.warn("add-slide-to-modal action is obsolete.");
                         break;
                     case 'remove-slide-from-modal': // Teacher (Modal Remove Slide)
                         // Task 2: Obsolete
                         // const slideIndex = parseInt(slideIndexStr, 10);
                         // if (!isNaN(slideIndex)) removeSlideFromModal(slideIndex);
                         console.warn("remove-slide-from-modal action is obsolete.");
                         break;
                    case 'delete-lesson': // Teacher
                        if (id) handleDeleteLessonBook(id);
                        break;
                    case 'archive-lesson': // NEW
                        if (id && status) handleToggleLessonStatus(id, status);
                        break;
                    case 'view-lesson': // Student
                        if (id) viewLessonBook(id);
                        break;
                    // --- NEW: Lesson Retake ---
                    case 'retake-lesson':
                        if (id) handleRetakeLesson(id);
                        break;
                    // Lesson Viewing Actions (Student)
                    case 'previous-lesson-slide':
                        previousLessonSlide();
                        break;
                    case 'next-lesson-slide':
                        nextLessonSlide();
                        break;
                    case 'complete-lesson':
                         // Use the ID from the button's data attribute
                         if (id) calculateAndSaveLessonScore(id);
                         else if (state.selectedLessonBookId) calculateAndSaveLessonScore(state.selectedLessonBookId);
                        break;

                    // Assignments (Teacher & Student)
                    case 'open-assignment-modal': // Teacher
                        openAssignmentModal(id); // id might be undefined for 'create new'
                        break;
                     case 'close-assignment-modal': // Teacher (Modal Cancel)
                         closeAssignmentModal();
                         break;
                    case 'delete-assignment': // Teacher
                        if (id) handleDeleteAssignment(id);
                        break;
                    case 'archive-assignment': // NEW
                        if (id && status) handleToggleAssignmentStatus(id, status);
                        break;
                    case 'view-assignment': // Student view link
                         if (id) viewAssignment(id);
                         break;
                     case 'view-submissions': // Teacher view link
                         if (id) viewSubmissions(id);
                         break;
                     case 'edit-submission': // Student edit button in viewAssignment
                         const form = document.getElementById('assignmentSubmissionForm');
                         const editButton = document.getElementById('edit-submission-button');
                         const textArea = document.getElementById('submissionText');
                          const attachmentInput = document.getElementById('submissionFile'); // Task 2.2
                         if (form && editButton && textArea && state.selectedAssignmentId) {
                             const currentSubmission = state.myAssignmentSubmissions[state.selectedAssignmentId];
                             textArea.value = currentSubmission?.submissionText || '';
                             // We can't pre-fill a file input, but we can show the old file name
                             // The renderViewAssignment function already does this.
                             form.style.display = 'block';
                             editButton.style.display = 'none'; // Hide the edit button
                         }
                         break;

                     // Assignment Grading (Teacher)
                     case 'save-grade':
                         if (id) handleSaveAssignmentGrade(id);
                         break;

                     // Quiz Editor (Teacher)
                     case 'archive-quiz': // --- FIX: Changed from delete-quiz
                         if (id && status) handleArchiveQuiz(id, status);
                         break;
                    case 'edit-quiz': // NEW
                        if (id) handleEditQuiz(id);
                        break;
                    case 'cancel-edit-quiz': // NEW
                        handleCancelEditQuiz();
                        break;
                    case 'delete-quiz': // NEW
                        if (id) handleDeleteQuiz(id);
                        break;
                    
                    // NEW: Payment Actions
                    case 'open-payment-modal':
                        openPaymentModal(id); // id is null for 'create new'
                        break;
                    case 'close-payment-modal':
                        closePaymentModal();
                        break;
                    case 'delete-payment-session':
                        if (id) handleDeletePaymentSession(id);
                        break;
                    case 'send-payment-reminder':
                        if (id) handleSendPaymentReminder(id);
                        break;

                    // Task 2.1: Profile Pic Upload Actions
                    case 'upload-pic':
                         // This action is on both header and dashboard profile pics
                        document.getElementById('profileUpload')?.click();
                        break;

                     // --- NEW: ADMIN ACTIONS ---
                    case 'seed-users':
                         handleSeedUsers();
                         break;
                    case 'open-user-modal':
                        openUserModal(id); // id is null for 'create new'
                        break;
                    case 'close-user-modal':
                        closeUserModal();
                        break;
                    case 'toggle-user-status':
                        if (id && status) handleToggleUserStatus(id, status);
                        break;
                    case 'delete-user':
                        if (id) handleDeleteUser(id);
                        break;
                    // --- END ADMIN ACTIONS ---

                    // --- NEW: ADMIN SUBJECT ACTIONS ---
                    case 'add-new-subject':
                        await handleAddNewSubject(event);
                        break;
                    // --- END ADMIN SUBJECT ACTIONS ---

                    // --- NEW: VIRTUAL CLASSROOM ACTIONS ---
                    case 'join-meeting':
                        // const topic = target.dataset.topic; // Already defined above
                        // ### MODIFIED: Call new permission-requesting function ###
                        if (id && topic) await requestMediaPermissionsAndJoin(id, topic); // id is roomId
                        break;
                    case 'leave-meeting':
                        handleLeaveMeeting();
                        break;
                    case 'end-meeting':
                        if (id) await handleEndMeeting(id); // ### MODIFIED: Added await ###
                        break;
                    case 'delete-meeting': // <-- NEW
                        if (id) await handleDeleteMeeting(id); // <-- NEW
                        break; // <-- NEW
                    // --- ### NEW: GRADING ACTIONS ### ---
                    case 'save-participation-grades':
                        if (id) await handleSaveParticipationGrades(id); // id is meetingId
                        break;
                    case 'view-meeting-grades':
                        state.selectedMeetingForGradingId = id; // id is meetingId
                        state.dashboardTab = 'gradeMeeting';
                        navigateTo('dashboard');
                        break;
                    case 'view-meeting-grades':
                        // ### REMOVED: This case is no longer used ###
                        // state.dashboardTab = 'gradeMeeting';
                        // navigateTo('dashboard', id); // id is the meetingId
                        break;
                    // --- END VIRTUAL CLASSROOM ACTIONS ---

                    default:
                        console.log(`Unhandled action: ${action}`);
                }
            } catch (error) {
                 console.error(`Error handling action ${action}:`, error);
            }
        }

        // --- Add separate handler for input events ---
        function handleAppInput(event) {
            const target = event.target;
            if (!target) return;
            
            // Note: Profile pic upload is handled by inline onchange, not here.

            // Check if the input is from the login form
            if (target.matches('#login-form input')) {
                clearLoginError();
            }

            // Handle quiz answer input for FillIn types
            if (target.matches('#app-content input[name="answer"]') && state.view === 'quiz') {
                 handleAnswerSelection(event);
            }
        }

        // --- WINDOW ASSIGNMENTS (MUST BE AFTER FUNCTION DEFINITIONS) ---
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.navigateTo = navigateTo;
        window.saveProgress = saveProgress;
        window.setDashboardTab = setDashboardTab;
        window.handleAnswerSelection = handleAnswerSelection;
        window.checkAnswerAndProvideFeedback = checkAnswerAndProvideFeedback;
        window.nextQuestion = nextQuestion;
        window.handleDeleteAnnouncement = handleDeleteAnnouncement;
        window.handlePostAnnouncement = handlePostAnnouncement;
        window.clearLoginError = clearLoginError;

        // Task 1: Expose quiz editor handlers
        window.handleSaveQuiz = handleSaveQuiz;
        window.handleArchiveQuiz = handleArchiveQuiz; // --- FIX: Changed from handleDeleteQuiz
        window.handleEditQuiz = handleEditQuiz; // NEW
        window.handleCancelEditQuiz = handleCancelEditQuiz; // NEW
        window.handleDeleteQuiz = handleDeleteQuiz; // NEW

        // Task 1: Add new functions for quiz loading
        window.startNewQuiz = startNewQuiz;
        window.loadAndContinueQuiz = loadAndContinueQuiz;

        // New Feature Handlers
        window.handleSaveLessonBook = handleSaveLessonBook;
        window.openLessonBookModal = openLessonBookModal;
        window.closeLessonBookModal = closeLessonBookModal;
        window.handleDeleteLessonBook = handleDeleteLessonBook;
        window.handleToggleLessonStatus = handleToggleLessonStatus; // NEW
        window.addSlideToModal = addSlideToModal; // Obsolete, but kept for safety
        window.removeSlideFromModal = removeSlideFromModal; // Obsolete, but kept for safety
        window.viewLessonBook = viewLessonBook; // Expose it
        window.nextLessonSlide = nextLessonSlide;
        window.previousLessonSlide = previousLessonSlide;
        window.submitLessonAnswer = submitLessonAnswer;
        window.handleSaveAssignment = handleSaveAssignment;
        window.openAssignmentModal = openAssignmentModal;
        window.closeAssignmentModal = closeAssignmentModal;
        window.handleDeleteAssignment = handleDeleteAssignment;
        window.handleToggleAssignmentStatus = handleToggleAssignmentStatus; // NEW
        window.viewAssignment = viewAssignment;
        window.viewSubmissions = viewSubmissions;
        window.handleSubmitAssignment = handleSubmitAssignment;
        window.calculateAndSaveLessonScore = calculateAndSaveLessonScore; // Task 3
        window.handleSaveAssignmentGrade = handleSaveAssignmentGrade; // Task 4
        
        // Task 2: Expose dynamic dropdown helper
        window.updateSubjectDropdown = updateSubjectDropdown;

        // Task 2 & 3: Expose new gradebook functions
        // Priority 1: Expose new/updated functions
        window.getTeacherGradeBookData = getTeacherGradeBookData;
        window._getCalculatedAveragesForStudent = _getCalculatedAveragesForStudent; // Expose master function

        // Task 2: Expose new lesson parser functions
        window.parseLessonText = parseLessonText;
        window.lessonSlidesToText = lessonSlidesToText;
        
        // FIX: Expose handleAppInput to the global scope for inline event handlers
        window.handleAppInput = handleAppInput;
        
        // Task 2.1: Expose profile pic uploader
        window.handleProfilePicUpload = handleProfilePicUpload;

        // NEW: Expose payment functions
        window.openPaymentModal = openPaymentModal;
        window.closePaymentModal = closePaymentModal;
        window.handleSavePaymentSession = handleSavePaymentSession;
        window.handleDeletePaymentSession = handleDeletePaymentSession;
        window.handleSendPaymentReminder = handleSendPaymentReminder;
        window.handleChangePaymentStatus = handleChangePaymentStatus;
        window.renderStudentPaymentStatus = renderStudentPaymentStatus;
        window.renderPaymentManager = renderPaymentManager;
        window.renderPaymentModal = renderPaymentModal;
        window.getStudentOptions = getStudentOptions;
        window.formatDateForInput = formatDateForInput;

                // NEW: Expose Admin functions
        window.handleSeedUsers = handleSeedUsers;
        window.openUserModal = openUserModal;
        window.closeUserModal = closeUserModal;
        window.handleSaveUser = handleSaveUser;
        window.handleToggleUserStatus = handleToggleUserStatus;
        window.handleDeleteUser = handleDeleteUser;
        window.renderSubjectManager = renderSubjectManager; // <-- NEW
        window.handleAddNewSubject = handleAddNewSubject; // <-- NEW

        // --- ### NEW: Admin Pic Preview Handler ### ---
        async function handleAdminProfilePicPreview(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log("Admin is uploading new pic: " + file.name);
            setLoading(true);
            try {
                // Compress to 256px
                const base64Url = await compressAndEncodeFile(file, 256, 0.8);
                if (base64Url) {
                    const previewImg = document.getElementById('user-modal-pic-preview');
                    const urlInput = document.getElementById('userProfilePicUrl');
                    if (previewImg) previewImg.src = base64Url;
                    if (urlInput) urlInput.value = base64Url;
                }
            } catch (error) {
                console.error("Error compressing file for admin preview:", error);
            } finally {
                setLoading(false);
            }
        }
        window.handleAdminProfilePicPreview = handleAdminProfilePicPreview;
        // --- ### END NEW ### ---

        // ### NEW: Expose Markdown Parser ###
        window.parseSlideMarkdown = parseSlideMarkdown;
        
        // --- NEW: Expose Lesson Retake ---
        window.handleRetakeLesson = handleRetakeLesson;

        // --- NEW: Expose Virtual Classroom functions ---
        window.handleCreateMeeting = handleCreateMeeting;
        // ### MODIFIED: Expose new permission function ###
        window.requestMediaPermissionsAndJoin = requestMediaPermissionsAndJoin;
        window.handleJoinMeeting = handleJoinMeeting; // Keep old one just in case
        window.handleEndMeeting = handleEndMeeting;
        window.handleDeleteMeeting = handleDeleteMeeting; // <-- NEW
        window.handleLeaveMeeting = handleLeaveMeeting;
        window.initJitsiMeet = initJitsiMeet;
        window.renderMeetingGradingPage = renderMeetingGradingPage;
        window.handleSaveParticipationGrades = handleSaveParticipationGrades;
        
        // --- NEW: Expose subject enrollment helper ---
        window.getEnrolledSubjects = getEnrolledSubjects;

        // --- NEW: Quiz Review Renderer ---
        function renderQuizReview() {
            if (state.quizData.length === 0) {
                return `<div class="p-8 text-center">Loading quiz review... <button data-action="back-to-dashboard" class="text-blue-500 underline">Back</button></div>`;
            }

            const quiz = state.allQuizzes.find(q => q.id === state.quizId);
            if (!quiz) {
                return `<div class="p-8 text-center">Quiz not found. <button data-action="back-to-dashboard" class="text-blue-500 underline">Back</button></div>`;
            }

            // Find the student's best attempt for this quiz
            const subjectStats = state.studentStats[quiz.subject];
            const attemptsForThisQuiz = subjectStats ? (subjectStats.attempts || []).filter(a => a.quizId === quiz.id) : [];
            const bestAttempt = attemptsForThisQuiz.length > 0 ? attemptsForThisQuiz.slice().sort((a,b) => b.score - a.score)[0] : null;

            let score = 0;
            let total = state.quizData.length;
            let percentage = 0;
            let percentageText = "Review Mode";
            let colorClass = "text-gray-600";
            let emoji = "";
            let responses = [];

            if (bestAttempt) {
                score = bestAttempt.score;
                total = bestAttempt.totalItems;
                percentage = total > 0 ? (score / total) * 100 : 0;
                const resultData = percentage >= 80
                    ? ["Great Job!", "text-green-600", ""]
                    : percentage >= 50
                    ? ["Good Effort!", "text-orange-500", ""]
                    : ["Keep Practicing!", "text-red-600", ""];
                percentageText = `Best Score: ${resultData[0]}`;
                colorClass = resultData[1];
                emoji = resultData[2];
                responses = bestAttempt.responses || [];
            } else {
                // No attempt. We will just show correct answers.
                percentageText = "Quiz Review";
                colorClass = "text-blue-600";
                emoji = "";
                // `responses` remains empty.
            }

             return `
                 <div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                     <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl card p-8 text-center">
                         <h1 class="text-3xl font-bold text-gray-800 mb-2">${percentageText} ${emoji}</h1>
                         <p class="text-lg text-gray-600 mb-6">Reviewing: ${quiz.title || state.quizSubject}</p>
                         
                         ${bestAttempt ? `
                             <div class="mb-8">
                                 <p class="text-6xl font-extrabold ${colorClass}">${score} / ${total}</p>
                                 <p class="text-2xl font-semibold ${colorClass}">(${percentage.toFixed(0)}%)</p>
                             </div>
                         ` : `
                             <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                 <p class="text-lg font-medium text-blue-700">You have not taken this quiz. Showing correct answers for review.</p>
                             </div>
                         `}

                         <!-- Review Section -->
                         <div class="text-left max-h-80 overflow-y-auto space-y-4 border p-4 rounded-lg bg-gray-50 mb-8">
                             <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Quiz Questions & Answers</h3>
                             ${state.quizData.map((question, index) => {
                                 const studentResponse = bestAttempt ? responses.find(r => r.qId === question.id || r.qId === (index + 1)) : null; // Handle old/new response format
                                 const correctAnswer = question.answer;

                                 return `
                                     <div class="pb-3 ${index < state.quizData.length - 1 ? 'border-b' : ''}">
                                         <p class="text-sm font-medium text-gray-800">${index + 1}. ${question.question}</p>
                                         
                                         ${studentResponse ? `
                                             <!-- Show student's attempt -->
                                             ${studentResponse.isCorrect ? `
                                                 <p class="text-sm text-green-600">
                                                     Your answer: <span class="font-semibold">${studentResponse.r}</span> (Correct)
                                                 </p>
                                             ` : `
                                                 <p class="text-sm text-red-600">
                                                     Your answer: <span class="font-semibold">${studentResponse.r}</span>
                                                 </p>
                                                 <p class="text-sm text-gray-700">
                                                     Correct answer: <span class="font-semibold">${correctAnswer}</span>
                                                 </p>
                                             `}
                                         ` : `
                                             <!-- No attempt, just show correct answer -->
                                             <p class="text-sm text-green-600">
                                                 Correct answer: <span class="font-semibold">${correctAnswer}</span>
                                             </p>
                                         `}
                                     </div>
                                 `;
                             }).join('')}
                         </div>

                         <div class="flex">
                             <button data-action="back-to-dashboard" class="w-full px-5 py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-md transition-colors">
                                 Back to Dashboard
                             </button>
                         </div>
                     </div>
                 </div>
             `;
        }


        // Initialize Firebase on DOM load, then render
        document.addEventListener('DOMContentLoaded', async () => {
             renderApp(); // Show initial loading
             await initFirebase(); // Initialize Firebase and set up auth listener
             // The auth listener will eventually call renderApp again
        });


    </script>
</head>
<body class="bg-gray-50">
    <div id="app-content">
         <!-- Initial loading state -->
         <div class="flex items-center justify-center min-h-screen">
             <div class="loader"></div> <p class="ml-4 text-lg text-gray-600">Initializing LMS...</p>
         </div>
    </div>
    <div id="loading-overlay" class="fixed inset-0 loading-overlay items-center justify-center hidden z-50">
        <div class="loader"></div>
        <p class="ml-4 text-xl text-gray-700 font-semibold">Loading...</p>
    </div>
</body>
</html>
